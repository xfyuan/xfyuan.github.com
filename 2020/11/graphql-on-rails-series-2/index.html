<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>GraphQL on Railsâ€”â€”æ›´æ–° | The Tragedy of XY</title>

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>GraphQL on Railsâ€”â€”æ›´æ–° | The Tragedy of XY</title>
<meta name="generator" content="Jekyll v4.1.0" />
<meta property="og:title" content="GraphQL on Railsâ€”â€”æ›´æ–°" />
<meta name="author" content="Mr.Z" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆDmitry Tsepelevï¼‰ã€ï¼ˆPolina Gurtovayaï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡æ˜¯ Rails + React ä½¿ç”¨ GraphQLçš„ç³»åˆ—æ•™ç¨‹ç¬¬äºŒç¯‡ï¼Œä»‹ç»äº†ä»¥ Rails ä½œä¸ºåç«¯ï¼ŒReact + Apollo ä½œä¸ºå‰ç«¯ï¼Œå¦‚ä½•è¿›è¡Œæ•°æ®æ›´æ–°çš„æ•™å­¦ã€‚" />
<meta property="og:description" content="æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆDmitry Tsepelevï¼‰ã€ï¼ˆPolina Gurtovayaï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡æ˜¯ Rails + React ä½¿ç”¨ GraphQLçš„ç³»åˆ—æ•™ç¨‹ç¬¬äºŒç¯‡ï¼Œä»‹ç»äº†ä»¥ Rails ä½œä¸ºåç«¯ï¼ŒReact + Apollo ä½œä¸ºå‰ç«¯ï¼Œå¦‚ä½•è¿›è¡Œæ•°æ®æ›´æ–°çš„æ•™å­¦ã€‚" />
<meta property="og:site_name" content="The Tragedy of XY" />
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20201121_131305.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-24T00:00:00+00:00" />
<script type="application/ld+json">
{"dateModified":"2020-11-24T00:00:00+00:00","datePublished":"2020-11-24T00:00:00+00:00","description":"æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆDmitry Tsepelevï¼‰ã€ï¼ˆPolina Gurtovayaï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡æ˜¯ Rails + React ä½¿ç”¨ GraphQLçš„ç³»åˆ—æ•™ç¨‹ç¬¬äºŒç¯‡ï¼Œä»‹ç»äº†ä»¥ Rails ä½œä¸ºåç«¯ï¼ŒReact + Apollo ä½œä¸ºå‰ç«¯ï¼Œå¦‚ä½•è¿›è¡Œæ•°æ®æ›´æ–°çš„æ•™å­¦ã€‚","url":"/2020/11/graphql-on-rails-series-2/","@type":"BlogPosting","image":"https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20201121_131305.jpg","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"},"name":"Mr.Z"},"mainEntityOfPage":{"@type":"WebPage","@id":"/2020/11/graphql-on-rails-series-2/"},"author":{"@type":"Person","name":"Mr.Z"},"headline":"GraphQL on Railsâ€”â€”æ›´æ–°","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link href="/assets/css/prism.css" rel="stylesheet">

<link href="/assets/css/theme.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body>
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>

<!-- Begin Sidebar Navigation
================================================== -->

<div class="sidebar">
</div>
<div class="nav-icon">
    <div class="hamburger-bar"></div>
</div>
<div id="blackover-nav" class="blackover"></div>
<nav id="menu">
    <ul>
        <h3>Navigation</h3>
        <li><a href="/">Home</a></li>
        <li><a href="/categories">Categories</a></li>
        <li><a href="/about">About</a></li>
    </ul>
</nav>

<script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>


<!-- End Sidebar Navigation
================================================== -->

<div class="site-content ">

<div class="container">

    <!-- Site Logo/Name
    ================================================== -->

    <a class="navbar-brand" href="/">
        <img src="/assets/images/logo.png" alt="The Tragedy of XY">
    </a>


    <!-- Site Tag
    ================================================== -->
    

    <!-- Content
    ================================================== -->
    <div class="main-content">
        <div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">GraphQL on Railsâ€”â€”æ›´æ–°</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
            
        </div>            
        <div>
        Written by <a target="_blank" class="text-dark" href="https://xfyuan.github.io">Mr.Z</a> on 
        <span class="post-date"><time class="post-date" datetime="2020-11-24">24 Nov 2020</time></span>           
        
        </div>            
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image lazyimg " src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20201121_131305.jpg" alt="GraphQL on Railsâ€”â€”æ›´æ–°">
    
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <p><em>æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆDmitry Tsepelevï¼‰ã€ï¼ˆPolina Gurtovayaï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡æ˜¯ Rails + React ä½¿ç”¨ GraphQLçš„ç³»åˆ—æ•™ç¨‹ç¬¬äºŒç¯‡ï¼Œä»‹ç»äº†ä»¥ Rails ä½œä¸ºåç«¯ï¼ŒReact + Apollo ä½œä¸ºå‰ç«¯ï¼Œå¦‚ä½•è¿›è¡Œæ•°æ®æ›´æ–°çš„æ•™å­¦ã€‚</em></p>

<ul>
  <li>åŸæ–‡é“¾æ¥ï¼š<a href="https://evilmartians.com/chronicles/graphql-on-rails-2-updating-the-data">GraphQL on Rails: Updating the data</a></li>
  <li>ä½œè€…ï¼š<a href="https://twitter.com/dmitrytsepelev">Dmitry Tsepelev</a>ï¼Œ<a href="https://github.com/HellSquirrel">Polina Gurtovaya</a></li>
  <li>ç«™ç‚¹ï¼šEvil Martians â€”â€”ä½äºçº½çº¦å’Œä¿„ç½—æ–¯çš„ Ruby on Rails å¼€å‘äººå‘˜åšå®¢ã€‚ å®ƒå‘å¸ƒäº†è®¸å¤šä¼˜ç§€çš„æ–‡ç« ï¼Œå¹¶ä¸”æ˜¯ä¸å°‘ gem çš„èµåŠ©å•†ã€‚</li>
</ul>

<p><em>ã€æ­£æ–‡å¦‚ä¸‹ã€‘</em></p>

<h2 id="å¼•è¨€">å¼•è¨€</h2>

<p><strong>è¿™æ˜¯ä¸€ä¸ªåœ¨åç«¯ä½¿ç”¨ Railsã€å‰ç«¯ä½¿ç”¨ React/Apollo æ¥å¼€å‘ GraphQL åº”ç”¨ç¨‹åºçš„æ—…è¡Œè€…æŒ‡å¯¼ã€‚æœ¬æ•™ç¨‹çš„ç¬¬äºŒéƒ¨åˆ†å°†æ¶µç›– mutationï¼ˆæ›´æ–°æ•°æ®çš„æ–¹å¼ï¼‰å’Œæœ‰å…³å®¢æˆ·ç«¯ç¼“å­˜çš„é«˜çº§ä¸»é¢˜</strong></p>

<p>åœ¨è¯¥æŒ‡å—çš„<a href="https://evilmartians.com/chronicles/graphql-on-rails-1-from-zero-to-the-first-query">ç¬¬ä¸€éƒ¨åˆ†</a>ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº† GraphQL æ˜¯ä»€ä¹ˆï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ª Martian Library åº”ç”¨ç¨‹åºçš„å¾ˆåˆçº§çš„ç‰ˆæœ¬ã€‚å¦‚æœä½ è¿˜æ²¡é˜…è¯»çš„è¯ï¼Œç°åœ¨æ­£å¥½å»çœ‹ä¸€ä¸‹ã€‚</p>

<p>æˆ‘ä»¬å·²ç»é…ç½®äº†<code>graphql-ruby</code> gem å’Œ Apollo æ¡†æ¶ä»¥ç¡®ä¿å®ƒä»¬èƒ½ä¸€èµ·å¾ˆå¥½åœ°å·¥ä½œï¼Œä¹Ÿé€šè¿‡æ·»åŠ ä¸€ä¸ªå¾ˆåˆçº§çš„æŸ¥è¯¢èŠ‚ç‚¹åˆ° schema ä¸Šæ¥å®æˆ˜æ£€éªŒäº†å…¶é…ç½®ã€‚ç°åœ¨è¯¥ç»§ç»­å‰è¡Œäº†ï¼</p>

<h2 id="introducing-mutations">Introducing mutations</h2>

<p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåœ¨ GraphQL ä¸­æœ‰ä¸‰ç§åŸºç¡€ operationâ€”â€” queryï¼Œmutationï¼ŒåŠ subscriptionsã€‚æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç» mutationâ€”â€”ä¸€ç§ä» GraphQL è¿›è¡Œæ•°æ®æ›´æ”¹çš„æœºåˆ¶ã€‚</p>

<p>ä»å®¢æˆ·ç«¯çš„è§’åº¦çœ‹ï¼Œmutation çœ‹èµ·æ¥è·Ÿ query å¾ˆåƒï¼Œåªæœ‰ä¸€ç‚¹ç»†å¾®çš„å·®åˆ«â€”â€”å®ƒä»¬ä»â€œmutationâ€èŠ‚ç‚¹å¼€å§‹ï¼š</p>

<pre><code class="language-graphql">mutation SignInUser($email: String) {
  signIn(email: $email) {
    id
  }
}
</code></pre>

<p>ç„¶è€Œï¼Œå…¶ä¸»è¦çš„åŒºåˆ«ï¼Œæ˜¯è¯­ä¹‰ä¸Šçš„ï¼šé¦–å…ˆï¼Œmutation è´Ÿè´£ä¿®æ”¹ï¼ˆæˆ–<em>è½¬å˜</em>ï¼‰æ•°æ®ã€‚åœ¨æ‰§è¡Œå¼•æ“å¤„ç†å®ƒä»¬çš„æ–¹å¼ä¸Šï¼Œä¹Ÿæœ‰ä¸€ä¸ªå·®åˆ«ï¼šæ ¹æ®è§„èŒƒï¼ŒGraphQL æœåŠ¡ç«¯<a href="https://graphql.github.io/graphql-spec/June2018/#sec-Mutation">å¿…é¡»ç¡®ä¿</a> mutation æ˜¯è¢«è¿ç»­æ‰§è¡Œçš„ï¼Œè€Œ query åˆ™èƒ½è¢«å¹¶è¡Œæ‰§è¡Œã€‚</p>

<p>åœ¨ä¸Šé¢çš„ mutation ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç”¨æˆ·çš„ email å‘æœåŠ¡ç«¯è¯·æ±‚èº«ä»½éªŒè¯ï¼Œä»¥å¦‚ä¸‹æ–¹å¼ï¼š</p>

<ul>
  <li>æˆ‘ä»¬ä»¥ä¸€ä¸ª operation å<code>SignInUser</code>å’Œä¸€ä¸ªå˜é‡<code>$email</code>ï¼ˆæ‰€æœ‰ GraphQL ä¸­çš„å˜é‡éƒ½ä»¥<code>$</code>å¼€å¤´ï¼‰æ¥å®šä¹‰ä¸€ä¸ª mutation å¼€å§‹ã€‚</li>
  <li>æˆ‘ä»¬æœ‰ä¸€ä¸ªæƒ³è¦æ‰§è¡Œä¿®æ”¹çš„åˆ—è¡¨åœ¨å¤§æ‹¬å·å†…ï¼ˆè¯¥åˆ—è¡¨ç§°ä½œ <em>selection set</em>ï¼‰â€”â€”è¿™é‡Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå«<code>signIn</code>çš„å­—æ®µã€‚</li>
  <li>è·Ÿ query ä¸€æ ·ï¼Œåœ¨æ ¹å­—æ®µå†…æˆ‘ä»¬å¯ä»¥æœ‰åµŒå¥—çš„ selection setsï¼ˆå³ï¼Œä» mutation è¿”å›å€¼é€‰æ‹©ç‰¹å®šå­—æ®µï¼‰ã€‚</li>
</ul>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-2-updating-the-data/mutation-77c15e7.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-2-updating-the-data/mutation-77c15e7.png" /></p>

<p>è¿™äº›å°±æ˜¯ç†è®ºæ–¹é¢æˆ‘ä»¬æ‰€éœ€è¦äº†è§£çš„ä¸œè¥¿äº†ã€‚æ¥ä¸‹æ¥çš„å†…å®¹å°†ä¸“æ³¨äºå®è·µï¼šæˆ‘ä»¬å°†æ·»åŠ  mutation æ¥å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä»¥åŠè®©ç”¨æˆ·æ·»åŠ æ–° items åˆ° Martian libraryã€‚</p>

<h2 id="housekeeping">Housekeeping</h2>

<p>å…ˆæ¥å¿«é€Ÿçœ‹ä¸‹åœ¨å‰ä¸€éƒ¨åˆ†æ•™ç¨‹å®Œæˆåæˆ‘ä»¬çš„æˆæœã€‚ä½ å¯åœ¨<a href="https://github.com/evilmartians/chronicles-gql-martian-library/tree/part-1">è¿™é‡Œ</a>æ‰¾åˆ°æºç â€”â€”åˆ«å¿˜äº†åœ¨é¦–æ¬¡è¿è¡Œå‰æ‰§è¡Œ<code>bundle install &amp;&amp; yarn install</code>ã€‚<a href="https://github.com/evilmartians/chronicles-gql-martian-library">Master</a> åˆ†æ”¯åˆ™ä»£è¡¨äº†è¯¥é¡¹ç›®çš„å½“å‰çŠ¶æ€ã€‚</p>

<p>æˆ‘ä»¬ä½¿ç”¨<code>graphql-tag</code>åº“æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¹¶ä½¿å®ƒä»¬åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­é è¿‘ç»„ä»¶ï¼š</p>

<pre><code class="language-js">// app/javascript/components/Library/index.js

import React from "react";
import { Query } from "react-apollo";
import gql from "graphql-tag";

const LibraryQuery = gql`
  {
    items {
      id
      title
      user {
        email
      }
    }
  }
`;

export default () =&gt; (
  &lt;Query query={LibraryQuery}&gt;
    {({ data, loading }) =&gt; (
      &lt;div&gt;
        {loading
          ? "loading..."
          : data.items.map(({ title, id, user }) =&gt; (
              &lt;div key={id}&gt;
                &lt;b&gt;{title}&lt;/b&gt; {user ? `added by ${user.email}` : null}
              &lt;/div&gt;
            ))}
      &lt;/div&gt;
    )}
  &lt;/Query&gt;
);
</code></pre>

<p>æˆ–è€…ï¼Œä½ å¯ä»¥æŠŠè¿™äº› operation æ”¾åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œä»¥<code>.graphql</code>ï¼ˆæˆ–<code>.gql</code>ï¼‰æ‰©å±•åï¼Œä¿å­˜åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œä½œä¸ºç»„ä»¶å®šä¹‰ã€‚è¿™ç§æ–¹æ¡ˆåœ¨å¼€å‘ä¸­å‹â€”â€”åˆ°å¤§å‹â€”â€”çš„åº”ç”¨ç¨‹åºæ—¶å°¤å…¶æœ‰ç”¨ï¼Œæä¾›äº†æ¸…æ™°çš„é¡¹ç›®ç»“æ„ã€‚æˆ‘ä»¬åœ¨æœ¬æ•™ç¨‹ä¸­å¯¹äºæ‰€æœ‰çš„æ–° operation éƒ½å°†ä½¿ç”¨å®ƒã€‚</p>

<p>è¦è®© Webpack â€œç†è§£â€<code>.gql</code>æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>/config/webpack/environment.js</code>ä¸­é…ç½®ä¸€ä¸ªç‰¹åˆ«çš„ loaderï¼š</p>

<pre><code class="language-js">// config/webpack/environment.js
const { environment } = require("@rails/webpacker");

environment.loaders.append("graphql", {
  test: /\.(graphql|gql)$/,
  exclude: /node_modules/,
  loader: "graphql-tag/loader"
});

module.exports = environment;
</code></pre>

<p>åˆ«å¿˜äº†é‡å¯æ¥è®©é…ç½®ç”Ÿæ•ˆã€‚</p>

<p>ç°åœ¨å·²ç»å‡†å¤‡å¥½å®ç°èº«ä»½éªŒè¯é€»è¾‘äº†ã€‚</p>

<h2 id="implementing-authentication">Implementing authentication</h2>

<p>GraphQL è§„èŒƒæ²¡æœ‰å‘Šè¯‰ä½ å¦‚ä½•å®ç°èº«ä»½éªŒè¯é€»è¾‘ï¼Œç”šè‡³ä¸éœ€è¦ä½ æœ‰è¿™ä¸ªâ€”â€”è¿™å–å†³äºå¼€å‘è€…ã€‚ç„¶è€Œï¼Œä½ å¾ˆéš¾æƒ³è±¡ä¸€ä¸ªçœŸå®çš„åº”ç”¨ç¨‹åºæ²¡æœ‰å®ƒï¼Œæˆ‘ä»¬çš„ Martian Library ä¹Ÿä¸ä¾‹å¤–â€”â€”æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼æ¥è¿½è¸ªæ‰€æœ‰è¢«æ·»åŠ åˆ°å›¾ä¹¦é¦†çš„ items çš„<em>æ‹¥æœ‰è€…</em>ã€‚</p>

<p>æˆ‘ä»¬è®©äº‹æƒ…ç®€å•äº›ï¼Œä»¥ç”¨æˆ·çš„ email è¿›è¡ŒéªŒè¯ï¼Œæ¯‹éœ€å¯†ç ï¼ŒçŸ­ä¿¡ï¼ŒåŠå…¶ä»–ç¡®è®¤æ–¹å¼ã€‚</p>

<p>ä¸‹é¢æ˜¯æˆ‘ä»¬çš„èº«ä»½éªŒè¯æœºåˆ¶çš„æ¦‚è§ˆï¼š</p>

<ul>
  <li>ç”¨æˆ·æä¾› email æ¥å‘èµ·èº«ä»½éªŒè¯è¯·æ±‚</li>
  <li>æœåŠ¡ç«¯éªŒè¯è¯¥ç”¨æˆ·å­˜åœ¨å¹¶ä»¥ä¸€ä¸ª<em>èº«ä»½éªŒè¯ tokan</em> è¿”å›å“åº”</li>
  <li>ç”¨æˆ·æ¯æ¬¡åç»­è¯·æ±‚éƒ½å¸¦ä¸Šè¯¥ tokenï¼ˆæ¯”å¦‚ï¼Œé€šè¿‡ HTTP Headerï¼‰ä»¥è¯æ˜å…¶èº«ä»½</li>
</ul>

<p>æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª GraphQL mutationï¼Œ<code>signIn</code>ï¼Œæ¥æ‰§è¡Œèº«ä»½éªŒè¯ï¼Œå¹¶ä»¥ä¸€ä¸ª base64 åŠ å¯†çš„ email ä½œä¸ºèº«ä»½éªŒè¯ tokenï¼Œä»¥åŠä¸€ä¸ªâ€œAuthorizationâ€ header æ¥ä¼ é€’è¯¥ tokenã€‚æ³¨æ„ï¼Œä½¿ç”¨ GraphQL API æ¥éªŒè¯ç”¨æˆ·å¹¶éæ˜¯å¿…é¡»çš„ï¼šå…¶å¯ä»¥åœ¨â€œå¤–éƒ¨â€å®Œæˆï¼Œæ¯”å¦‚ï¼Œé€šè¿‡ RESTã€‚è¿™åœ¨å½“ä½ ä»…å…è®¸å·²éªŒè¯ç”¨æˆ·è®¿é—® GraphQL API æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚</p>

<p>æˆ‘ä»¬ä¹ŸæœŸæœ›åœ¨ UI ä¸­æŒ‡ç¤ºç”¨æˆ·æ˜¯å¦å·²ç»é€šè¿‡èº«ä»½éªŒè¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ª panel ï¼Œå¦‚æœç”¨æˆ·å·²ç™»å½•åˆ™æ˜¾ç¤ºå…¶åç§°ï¼Œå¦åˆ™æ˜¾ç¤ºâ€œSign Inâ€æŒ‰é’®ï¼š</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-2-updating-the-data/user_info-af682ad.gif" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-2-updating-the-data/user_info-af682ad.gif" /></p>

<h3 id="crafting-authentication-schema">Crafting authentication schema</h3>

<p>è®©æˆ‘ä»¬å…ˆæ¥æ·»åŠ ä¸€ä¸ª API ä»¥è·å–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ã€‚</p>

<p>æˆ‘ä»¬æƒ³è®©äº‹æƒ…ç®€å•äº›ï¼šæ·»åŠ ä¸€ä¸ª<code>me</code>å­—æ®µåˆ° query çš„æ ¹ä¸Šæ¥è¿”å›å…¶ context çš„å½“å‰ç”¨æˆ·ï¼š</p>

<pre><code class="language-ruby"># app/graphql/types/query_type.rb

module Types
  class QueryType &lt; Types::BaseObject
    # ...
    field :me, Types::UserType, null: true

    def me
      context[:current_user]
    end
  end
end
</code></pre>

<p>å¦‚ä½•å¾—åˆ°<code>:current_user</code>ï¼Ÿæˆ‘ä»¬æ¥æ·»åŠ ä¸€ä¸ª<code>ApplicationController#current_user</code>æ–¹æ³•ï¼Œå®ç°ä¸Šè¿°çš„èº«ä»½éªŒè¯é€»è¾‘ï¼š</p>

<pre><code class="language-ruby"># app/controllers/application_controller.rb

class ApplicationController &lt; ActionController::Base
  private

  def current_user
    token = request.headers["Authorization"].to_s
    email = Base64.decode64(token)
    User.find_by(email: email)
  end
end
</code></pre>

<p>æœ€åï¼Œæˆ‘ä»¬æ›´æ–°<code>GraphqlController#execute</code>æ–¹æ³•ä»¥ä¼ é€’<code>current_user</code>åˆ° context å†…ï¼š</p>

<pre><code class="language-ruby"># app/controllers/graphql_controller.rb

class GraphqlController &lt; ApplicationController
  def execute
    result = MartianLibrarySchema.execute(
      params[:query],
      variables: ensure_hash(params[:variables]),
      # Only this line has chagned
      context: { current_user: current_user },
      operation_name: params[:operationName]
    )
    render json: result
  end

  # ...
end
</code></pre>

<p>æ¼‚äº®ï¼ç°åœ¨æˆ‘ä»¬çš„å®¢æˆ·ç«¯å°±èƒ½æ‹¿åˆ°å½“å‰ç”¨æˆ·çš„ä¿¡æ¯äº†ã€‚ä½†ä¸å¹¸çš„æ˜¯ï¼Œå®ƒæ€»æ˜¯è¿”å›<code>nil</code>â€”â€”æˆ‘ä»¬è¿˜æ²¡æœ‰åŠ ä¸Šå‘ŠçŸ¥å½“å‰è°æ­£åœ¨ä½¿ç”¨åº”ç”¨çš„æ–¹æ³•ã€‚æ¥ä¿®å¤å®ƒï¼</p>

<p>æ‰“å¼€<code>Mutations::BaseMutation</code>ç±»å¹¶ç²˜è´´å¦‚ä¸‹ä»£ç ï¼ˆé»˜è®¤ç”Ÿæˆå™¨ç»§æ‰¿è‡ªæ›´å¤æ‚çš„<code>GraphQL::Schema::RelayClassicMutation</code>ç±»ï¼‰ï¼š</p>

<pre><code class="language-ruby"># app/graphql/mutations/base_mutation.rb

module Mutations
  class BaseMutation &lt; GraphQL::Schema::Mutation
  end
end
</code></pre>

<p>æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªç±»ä½œä¸º<code>SignInMutation</code>çš„çˆ¶ç±»ï¼š</p>

<pre><code class="language-ruby"># app/graphql/mutations/sign_in_mutation.rb

module Mutations
  class SignInMutation &lt; Mutations::BaseMutation
    argument :email, String, required: true

    field :token, String, null: true
    field :user, Types::UserType, null: true

    def resolve(email:)
      user = User.find_by!(email: email)
      return {} unless user

      token = Base64.encode64(user.email)
      {
        token: token,
        user: user
      }
    end
  end
end
</code></pre>

<p>å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬æŒ‡å®šäº† mutation å¯ä»¥è¿”å›ä¸€ä¸ª token å’Œä¸€ä¸ªå½“å‰çš„ç”¨æˆ·ï¼Œè€Œå”¯ä¸€æ¥æ”¶çš„å‚æ•°æ˜¯<code>email</code>ã€‚åœ¨<code>#resolve</code>æ–¹æ³•å†…ï¼Œæˆ‘ä»¬æŸ¥æ‰¾ç”¨æˆ·ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ä»¥ base64 åŠ å¯†çš„ email ä½œä¸º token è¿”å›ï¼Œå¦åˆ™è¿”å›<code>null</code>ã€‚</p>

<p>ç¬¬ä¸€çœ¼çœ‹å»ï¼Œmutation ç±»å°±åƒä¸€ä¸ªå¸¸è§„çš„ Rails controllerï¼Œä½†å®ƒæœ‰ä¸€ä¸ªé‡è¦çš„ä¼˜ç‚¹ï¼šå®ƒæ˜¯å¼ºç±»å‹çš„ï¼Œé€šè¿‡å…¶ schema æ¥éªŒè¯è¾“å…¥çš„æ•°æ®ã€‚</p>

<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>MutationType</code>ä¸­æš´éœ²è¿™ç¬¬ä¸€ä¸ª mutationï¼š</p>

<pre><code class="language-ruby"># app/graphql/types/mutation_type.rb

module Types
  class MutationType &lt; Types::BaseObject
    field :sign_in, mutation: Mutations::SignInMutation
  end
end
</code></pre>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œä¸ºäº†æ·»åŠ ä¸€ä¸ªæ–° mutationï¼Œä½ éœ€è¦å®Œæˆå¦‚ä¸‹æ­¥éª¤ï¼š</p>

<ul>
  <li>æ·»åŠ ä¸€ä¸ªç±»å®ç° mutation é€»è¾‘ï¼Œå…¶åŒ…å«ï¼š</li>
  <li>è¾“å…¥å€¼çš„ç±»å‹å®šä¹‰ï¼ˆargumentsï¼‰ï¼›</li>
  <li>è¿”å›å€¼çš„ç±»å‹å®šä¹‰ï¼›</li>
  <li><code>#resolve</code>æ–¹æ³•</li>
  <li>æ·»åŠ ä¸€ä¸ªæ–°çš„å…¥å£åˆ°<code>MutationType</code>ä¸­</li>
</ul>

<p>æ³¨æ„ï¼Œæˆ‘ä»¬æ ¹æœ¬æ²¡æœ‰æåˆ° spec æµ‹è¯•ï¼šå¯ä»¥ä½¿ç”¨åœ¨ä¹‹å‰ç¼–å†™çš„ query spec æ‰€ç”¨è¿‡çš„ç›¸åŒæŠ€æœ¯æ¥æ·»åŠ è¿™é‡Œçš„ specã€‚æˆ–è€…å»çœ‹çœ‹æˆ‘ä»¬åœ¨ç¤ºä¾‹ä»£ç åº“ä¸­å†™å¥½çš„æµ‹è¯•ï¼</p>

<h3 id="adding-user-info-panel">Adding user info panel</h3>

<p>è®©æˆ‘ä»¬æš‚æ—¶å…ˆå¿˜æ‰ Ruby ä¸€ä¼šï¼ŒæŠŠæ³¨æ„åŠ›æ”¾åˆ°å‰ç«¯åº”ç”¨æ¥ã€‚</p>

<p>ç”±äºæˆ‘ä»¬çš„ä»£ç åº“åœ¨ä¸æ–­å¢é•¿ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘ä¸€ä¸ªæ›´å¥½çš„ä»£ç ç»„ç»‡æ–¹å¼ã€‚æˆ‘ä»¬å¯¹äº UI ç»„ä»¶æ¨èå¦‚ä¸‹ç»“æ„ï¼š</p>

<ul>
  <li>æ¯ä¸ªç»„ä»¶å­˜æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„ç›®å½•ä¸­ï¼ˆæ¯”å¦‚ï¼Œ<code>app/javascript/components/MyComponent</code>ï¼‰</li>
  <li><code>index.js</code>åŒ…å«å®ç°éƒ¨åˆ†</li>
  <li>query å®šä¹‰åœ¨<code>operations.graphql</code>ä¸­</li>
  <li>æ ·å¼æ”¾åˆ°<code>styles.module.css</code>ä¸­ï¼ˆå¦‚æ–‡ä»¶åæ‰€å»ºè®®çš„é‚£æ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨<a href="https://github.com/css-modules/css-modules">css modules</a>è€Œæ¯‹éœ€æ‹…å¿ƒæ ·å¼å†²çªï¼‰</li>
</ul>

<p>ä¸ºäº†é¿å…ä¸ºæ¯ä¸ªç»„ä»¶éƒ½æ‰‹åŠ¨åˆ›å»ºè¿™äº›æ–‡ä»¶çš„ç¹çï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ª<a href="https://github.com/HellSquirrel/create-gql-component">gql-component generatorï¼ˆgraphql ç»„ä»¶ç”Ÿæˆå™¨ï¼‰</a>ã€‚ç”¨å®ƒæ¥åˆ›å»ºä¸€ä¸ªç§°ä¸º<code>UserInfo</code>çš„ç»„ä»¶å§ï¼š</p>

<pre><code class="language-bash">$ npx @hellsquirrel/create-gql-component create app/javascript/components/UserInfo
</code></pre>

<p>æ³¨æ„ï¼šæ ·å¼ä»£ç åœ¨æœ¬æ–‡ä¸­è¢«å»æ‰äº†ï¼Œä»¥ä¿æŒç®€æ´ï¼Œä½†ä½ å¯ä»¥åœ¨ GitHub çš„ <a href="https://github.com/evilmartians/chronicles-gql-martian-library">repo</a> ä¸­æ‰¾åˆ°æ‰€æœ‰çš„æ ·å¼æ–‡ä»¶ã€‚å¦‚æœä½ ä½¿ç”¨æˆ‘ä»¬çš„ç”Ÿæˆå™¨ï¼Œæ ·å¼ä¼šè¢«è‡ªåŠ¨æ·»åŠ ã€‚</p>

<p>è¿™å°†æ˜¯ä½ çš„æ–‡ä»¶ç»“æ„çœ‹èµ·æ¥çš„æ ·å­ï¼š</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-2-updating-the-data/component_structure-9a81b3c.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-2-updating-the-data/component_structure-9a81b3c.png" /></p>

<p><code>UserInfo</code>ç»„ä»¶è´Ÿè´£â€œSign Inâ€çš„åŠŸèƒ½ï¼Œä»¥åŠå½“é€šè¿‡èº«ä»½éªŒè¯æ—¶å±•ç¤ºå½“å‰ç”¨æˆ·åã€‚è®©æˆ‘ä»¬æ¥é¦–å…ˆæ·»åŠ è¿™äº›åŠŸèƒ½æ‰€éœ€è¦çš„ API æŸ¥è¯¢åˆ°<code>operations.graphql</code>ä¸­ï¼š</p>

<pre><code class="language-graphql">query Me {
  me {
    id
    fullName
  }
}

mutation SignMeIn($email: String!) {
  signIn(email: $email) {
    token
    user {
      id
      fullName
    }
  }
}
</code></pre>

<p>æˆ‘ä»¬å®šä¹‰äº†<code>SignMeIn</code> operationï¼Œå¸¦æ‰€éœ€çš„<code>$email</code>å‚æ•°ï¼Œä¸º<code>String</code>ç±»å‹ï¼Œâ€œæ‰§è¡Œâ€<code>signIn</code> mutation å¹¶åœ¨æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªéªŒè¯ token å’Œå½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚ä½ å¯èƒ½æ³¨æ„åˆ°äº†<code>Me</code>å’Œ<code>SignMeIn</code> operationä¸Šçš„æŸäº›é‡å¤â€”â€”åˆ«æ‹…å¿ƒï¼Œç¨åæˆ‘ä»¬ä¼šå±•ç¤ºå¦‚ä½•å¤„ç†å®ƒä»¬ã€‚</p>

<p>å†æ‰“å¼€<code>index.js</code>å¹¶ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ operation æ¥å®šä¹‰æˆ‘ä»¬çš„ç»„ä»¶ã€‚æˆ‘ä»¬æœŸæœ›å…ˆåŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œä¸”ä»…å½“ç”¨æˆ·æ²¡æœ‰è¢«èº«ä»½éªŒè¯æ—¶æ‰å±•ç¤ºâ€œSign Inâ€è¡¨å•ï¼š</p>

<pre><code class="language-js">&lt;Query query={Me}&gt;
  {({ data, loading }) =&gt; {
    if (loading) return "...Loading";
    if (!data.me) {
      // Show login form
      return;
    }

    const { fullName } = data.me;
    return &lt;div className={cs.info}&gt;ğŸ˜ˆ {fullName}&lt;/div&gt;;
  }}
&lt;/Query&gt;
</code></pre>

<p>è¦æ˜¾ç¤ºè¡¨å•ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨<code>Mutation</code>ç»„ä»¶å¹¶ä¼ é€’<code>SignMeIn</code> operation ä¸ºä¸€ä¸ª<code>mutation</code> propertyï¼š</p>

<pre><code class="language-js">&lt;Mutation mutation={SignMeIn}&gt;
  {(signIn, { loading: authenticating }) =&gt;
    authenticating ? (
      "..."
    ) : (
      &lt;form onSubmit={() =&gt; signIn(/* email here */)}&gt;
        &lt;input type="email" /&gt;
        &lt;input type="submit" value="Sign In" /&gt;
      &lt;/form&gt;
    )
  }
&lt;/Mutation&gt;
</code></pre>

<p>åˆ«å¿˜äº†å¯¼å…¥ <code>userRef</code> hookï¼Œ<code>Query</code>å’Œ<code>Mutation</code>ç»„ä»¶ï¼Œè·Ÿè¯¥ç»„ä»¶ä¸­ä½¿ç”¨çš„ query ä¸€èµ·ï¼š</p>

<pre><code class="language-js">import React, { useRef } from 'react';
import { Query, Mutation } from "react-apollo";
import { Me, SignMeIn } from "./operations.graphql";
</code></pre>

<p>è¿™æ®µä»£ç çœ‹èµ·æ¥å¾ˆåƒå‰é¢åˆ›å»ºçš„<code>Library</code>ç»„ä»¶ã€‚<code>Mutation</code>ç»„ä»¶çš„ render prop æ¥æ”¶ä¸€ä¸ªæ‰§è¡Œ mutation çš„å‡½æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆ<code>signIn</code>ï¼‰ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª mutation ç»“æœ object çš„ objectï¼ŒåŒ…å«è¿”å›çš„æ•°æ®ï¼ŒåŠ è½½çš„çŠ¶æ€ç­‰ç­‰ã€‚</p>

<p>è¦ä¼ é€’ email ç»™ mutationï¼Œæˆ‘ä»¬éœ€è¦ä» inputï¼ˆä½¿ç”¨<code>ref</code>ï¼‰æ¥è·å–å®ƒï¼ŒæŠŠå®ƒæ”¾å…¥<code>variable</code>å†…ï¼Œå¹¶æ‰§è¡Œ mutationï¼š</p>

<pre><code class="language-js">const UserInfo = () =&gt; {
  const input = useRef(null);

  // ...

  return (
    &lt;form
      onSubmit={event =&gt; {
        event.preventDefault();
        signIn({
          variables: { email: input.current.value }
        });
      }}
    &gt;
      &lt;input
        ref={input}
        type="email"
        className={cs.input}
        placeholder="your email"
      /&gt;
    &lt;/form&gt;
  );
};
</code></pre>

<p>å½“åœ¨ JavaScript ä¸­è°ƒç”¨ mutation æ—¶ï¼Œæˆ‘ä»¬ä»¥å¦‚ä¸‹æ–¹å¼æŠŠå€¼ç»‘å®šåˆ° variablesï¼šä½¿ç”¨è·Ÿ operation ä¸­åŒæ ·çš„åç§°ï¼Œä½†ä¸è¦<code>$</code>å‰ç¼€ï¼Œæ¯”å¦‚ï¼Œ<code>signIn({ variables: { email: '...' } })</code>ã€‚</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-2-updating-the-data/mutation_variables-9cf2be2.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-2-updating-the-data/mutation_variables-9cf2be2.png" /></p>

<p>è®©æˆ‘ä»¬ç¡®ä¿æŠŠ token å­˜å‚¨åˆ°æŸä¸ªåœ°æ–¹ä»¥ä¾¿åœ¨éšåçš„è¯·æ±‚å’Œé¡µé¢é‡è½½é‡ç”¨å®ƒï¼š</p>

<pre><code class="language-js">&lt;form
  onSubmit={event =&gt; {
    event.preventDefault();
    signIn({
      variables: { email: input.current.value },
    }).then(({ data: { signIn: { token } } }) =&gt; {
      if (token) {
        localStorage.setItem('mlToken', token);
      }
    });
  }}
&gt;
</code></pre>

<p>åœ¨æˆ‘ä»¬æ‰§è¡Œâ€œSign Inâ€ä¹‹åï¼Œå°±åº”è¯¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯äº†ï¼ˆé€šè¿‡<code>Me</code> queryï¼‰ã€‚</p>

<h3 id="dealing-with-cache">Dealing with cache</h3>

<p>æœ‰ä¸¤ç§é€‰æ‹©å¯ä»¥åšåˆ°è¿™ç‚¹ï¼š</p>

<ul>
  <li>å½“ mutation å®Œæˆæ—¶é‡æ–°è¯·æ±‚<code>me</code> queryï¼ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Mutation</code>ç»„ä»¶ä¸Š<code>refetchQueries</code> propertyï¼‰â€”â€”è¿™ä¸ªæ˜¯æœ‰ç”¨çš„ï¼Œä½†æœ‰æ›´å¥½çš„æ–¹å¼ã€‚</li>
  <li>ç­‰å¾… mutation å®Œæˆå¹¶æ‰‹åŠ¨æ›´æ–°ç¼“å­˜ã€‚<code>apollo-cache-inmemory</code>ä¸ºæ­¤æä¾›äº†<code>writeQuery</code>å‡½æ•°ã€‚è€Œ<code>react-apollo</code>åº“çš„<code>Mutation</code>ç»„ä»¶æœ‰ä¸€ä¸ªç§°ä¸º<code>update</code>çš„ç‰¹æ®Š propertyã€‚å®ƒæ¥æ”¶<code>cache</code>ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œmutation ç»“æœä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚æˆ‘ä»¬æƒ³è¦ä½¿ç”¨<code>writeQuery</code>æ–¹æ³•æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªæ–°çš„ç¼“å­˜æ•°æ®ã€‚è¿™å°±å¥½æ¯”åœ¨è¯´â€œHeyï¼ŒApolloï¼è¿™å„¿æœ‰ä¸€äº›æ•°æ®ï¼Œå‡è£…ä½ æ˜¯ä»æœåŠ¡ç«¯æ¥æ”¶åˆ°å®ƒä»¬çš„å§ã€‚â€</li>
</ul>

<pre><code class="language-js">&lt;Mutation
  mutation={SignMeIn}
  update={(cache, { data: { signIn } }) =&gt; {
    cache.writeQuery({
      query: Me,
      data: { me: signIn.user },
    });
  }}
&gt;
</code></pre>

<p>å¦‚ä¸‹å°±æ˜¯<code>UserInfo</code>ç»„ä»¶æœ€ç»ˆçœ‹èµ·æ¥çš„æ ·å­ï¼š</p>

<pre><code class="language-js">import React, { useRef } from "react";
import { Query, Mutation } from "react-apollo";
import { Me, SignMeIn } from "./operations.graphql";
import cs from "./styles";

const UserInfo = () =&gt; {
  const input = useRef(null);

  return (
    &lt;div className={cs.panel}&gt;
      &lt;Query query={Me}&gt;
        {({ data, loading }) =&gt; {
          if (loading) return "...Loading";
          if (!data.me) {
            return (
              &lt;Mutation
                mutation={SignMeIn}
                update={(cache, { data: { signIn } }) =&gt; {
                  cache.writeQuery({
                    query: Me,
                    data: { me: signIn.user }
                  });
                }}
              &gt;
                {(signIn, { loading: authenticating }) =&gt;
                  authenticating ? (
                    "..."
                  ) : (
                    &lt;div className={cs.signIn}&gt;
                      &lt;form
                        onSubmit={event =&gt; {
                          event.preventDefault();
                          signIn({
                            variables: { email: input.current.value }
                          }).then(({ data: { signIn: { token } } }) =&gt; {
                            if (token) {
                              localStorage.setItem("mlToken", token);
                            }
                          });
                        }}
                      &gt;
                        &lt;input
                          ref={input}
                          type="email"
                          className={cs.input}
                          placeholder="your email"
                        /&gt;
                        &lt;input
                          type="submit"
                          className={cs.button}
                          value="Sign In"
                        /&gt;
                      &lt;/form&gt;
                    &lt;/div&gt;
                  )
                }
              &lt;/Mutation&gt;
            );
          }

          const { fullName } = data.me;
          return &lt;div className={cs.info}&gt;ğŸ˜ˆ {fullName}&lt;/div&gt;;
        }}
      &lt;/Query&gt;
    &lt;/div&gt;
  );
};

export default UserInfo;
</code></pre>

<p>æ­å–œï¼æˆ‘ä»¬åˆšåˆšé€šè¿‡æ·»åŠ <code>useRef</code>åˆ°ç»„ä»¶è€Œè´­ä¹°äº†ä¸€å¼ ç§°ä½œ<a href="https://reactjs.org/docs/hooks-intro.html">â€œReact Hooksâ€</a>çš„ç«è½¦ç¥¨ã€‚</p>

<p>æ›´å¥½çš„åšæ³•æ˜¯æŠŠ<code>UserInfo</code>æ‹†åˆ†ä¸ºä¸¤ä¸ªå•ç‹¬çš„ç»„ä»¶ã€‚ç¬¬ä¸€ä¸ªè´Ÿè´£â€œSign Inâ€é€»è¾‘ï¼Œç¬¬äºŒä¸ªè´Ÿè´£ç”¨æˆ·ä¿¡æ¯å±•ç¤ºã€‚ä½ æ¥è‡ªå·±æå®šå®ƒå§ï¼</p>

<p>åˆ«å¿˜äº†æŠŠç»„ä»¶æ·»åŠ åˆ°<code>/javascript/packs/index.js</code>ï¼š</p>

<pre><code class="language-js">// app/javascript/packs/index.js

import React from "react";
import { render } from "react-dom";
import Provider from "../components/Provider";
import Library from "../components/Library";
import UserInfo from "../components/UserInfo";

render(
  &lt;Provider&gt;
    &lt;UserInfo /&gt;
    &lt;Library /&gt;
  &lt;/Provider&gt;,
  document.querySelector("#root")
);
</code></pre>

<h3 id="adding-tokens-to-apollo-client">Adding tokens to Apollo client</h3>

<p>è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œè¯•ç€ä½¿ç”¨ä¸€ä¸ªåˆæ³• email ç™»å½•ã€‚</p>

<p>ä¸€åˆ‡æ­£å¸¸ï¼Œé™¤äº†å½“ä½ é‡æ–°åŠ è½½é¡µé¢æ—¶â€”â€”ä½ ä¼šçœ‹åˆ°ç™»å½•è¡¨å•å†æ¬¡å‡ºç°ï¼Œå³ä½¿ä½ ä¹‹å‰å·²æˆåŠŸç™»å½•äº†ï¼è§£é‡Šå¾ˆç®€å•ï¼šæˆ‘ä»¬æŠŠ token å­˜æ”¾åœ¨æµè§ˆå™¨ä¸­ï¼Œä½†æ²¡æœ‰â€œæ•™â€ Apollo ä½¿ç”¨å®ƒã€‚è®©æˆ‘ä»¬æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼</p>

<p>çœ‹ä¸€ä¸‹<code>utils/apollo.js</code>ï¼š</p>

<pre><code class="language-js">// app/javascript/utils/apollo.js
// ...
const getToken = () =&gt;
  document.querySelector('meta[name="csrf-token"]').getAttribute("content");
const token = getToken();
const setTokenForOperation = async operation =&gt;
  operation.setContext({
    headers: {
      "X-CSRF-Token": token
    }
  });
</code></pre>

<p>æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ª CSRF token å‘é€åˆ°æœåŠ¡ç«¯äº†ã€‚å†æ¥æ·»åŠ ä¸€ä¸ªæ–°çš„â€”â€”â€œAuthorizationâ€ tokenï¼š</p>

<pre><code class="language-js">// app/javascript/utils/apollo.js
// ...
const getTokens = () =&gt; {
  const tokens = {
    "X-CSRF-Token": document
      .querySelector('meta[name="csrf-token"]')
      .getAttribute("content")
  };
  const authToken = localStorage.getItem("mlToken");
  return authToken ? { ...tokens, Authorization: authToken } : tokens;
};

const setTokenForOperation = async operation =&gt; {
  return operation.setContext({
    headers: {
      ...getTokens()
    }
  });
};
</code></pre>

<p>å†ç™»å½•è¯•è¯•ï¼Œé‡è½½é¡µé¢â€”â€”ä½ ä¼šçœ‹åˆ°ä¿¡æ¯æ çš„ç”¨æˆ·åäº†ï¼æˆ‘ä»¬çš„â€œå¹¸è¿ä¹‹è·¯â€çœ‹èµ·æ¥ç•…é€šæ— é˜»ã€‚èº«ä»½éªŒè¯æµç¨‹ âœ…</p>

<h2 id="mutating-the-library">Mutating the library</h2>

<p>ç°åœ¨æˆ‘ä»¬è¦æ·»åŠ ä¸€äº›æ›´å¤šçš„ mutation â€”â€”è¿™é‡Œæ²¡ä»€ä¹ˆæ–°ä¸œè¥¿ï¼Œä½†æˆ‘ä»¬éœ€è¦å®ƒæ¥ä½¿èŒƒä¾‹åº”ç”¨çœ‹èµ·æ¥æ›´å¥½ï¼Œå¹¶å¾—åˆ°æ›´å¤šçš„å®è·µæœºä¼šã€‚</p>

<p>æˆ‘ä»¬æ¥å¢åŠ ä¸€ä¸ª mutation ä»¥å‘å›¾ä¹¦é¦†æ·»åŠ æ–° itemã€‚ç…§ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¼ å…¥å‚æ•°å’Œè¿”å›ç±»å‹ï¼š</p>

<pre><code class="language-ruby"># app/graphql/mutations/add_item_mutation.rb

module Mutations
  class AddItemMutation &lt; Mutations::BaseMutation
    argument :title, String, required: true
    argument :description, String, required: false
    argument :image_url, String, required: false

    field :item, Types::ItemType, null: true
    field :errors, [String], null: false

    def resolve(title:, description: nil, image_url: nil)
      if context[:current_user].nil?
        raise GraphQL::ExecutionError,
              "You need to authenticate to perform this action"
      end

      item = Item.new(
        title: title,
        description: description,
        image_url: image_url,
        user: context[:current_user]
      )

      if item.save
        { item: item }
      else
        { errors: item.errors.full_messages }
      end
    end
  end
end
</code></pre>

<p>è¿™æ®µä»£ç é‡Œæœ‰å‡ ä¸ªè¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>

<ul>
  <li>æˆ‘ä»¬æ£€æŸ¥<code>context[:current_user]</code>çš„å­˜åœ¨ï¼Œå¦‚æœå…¶æœªè®¾å®šåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
  <li>æˆ‘ä»¬è¿”å›çš„ç±»å‹åŒ…å«ä¸¤ä¸ªå­—æ®µï¼š<code>item</code>å’Œ<code>errors</code>ã€‚ä¸ºä»€ä¹ˆä¸ç”¨<code>save!</code>å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Ÿç”¨æˆ·è¾“å…¥çš„æ ¡éªŒé”™è¯¯ä¸åº”è¯¥è¢«çœ‹ä½œå¼‚å¸¸ï¼›æˆ‘ä»¬çš„å‰ç«¯åº”ç”¨åº”æŠŠå…¶è§†ä¸ºä¸€ç§åˆæ³•å“åº”å¹¶åé¦ˆç»™ç”¨æˆ·ã€‚</li>
</ul>

<p>å…¶ä»–çš„ä¸€åˆ‡éƒ½çœ‹èµ·æ¥åƒæ˜¯å…¸å‹çš„ Rails controller ä¸­çš„æ—§å¼<code>#create</code>è¡Œä¸ºã€‚è€Œå¦‚åŒ<code>#update</code>çš„ç±»ä¼¼è¡Œä¸ºä¹Ÿéå¸¸ç®€å•ï¼š</p>

<pre><code class="language-ruby"># app/graphql/mutations/update_item_mutation.rb

module Mutations
  class UpdateItemMutation &lt; Mutations::BaseMutation
    argument :id, ID, required: true
    argument :title, String, required: true
    argument :description, String, required: false
    argument :image_url, String, required: false

    field :item, Types::ItemType, null: true
    field :errors, [String], null: false

    def resolve(id:, title:, description: nil, image_url: nil)
      if context[:current_user].nil?
        raise GraphQL::ExecutionError,
              "You need to authenticate to perform this action"
      end

      item = Item.find(id)

      if item.update(title: title, description: description, image_url: image_url)
        { item: item }
      else
        { errors: item.errors.full_messages }
      end
    end
  end
end
</code></pre>

<p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°åœ¨è¿™ä¸¤ä¸ªç±»ä¸­æœ‰å¾ˆå¤šé‡å¤â€”â€”ä¸ç”¨æ‹…å¿ƒï¼Œæœ¬ç³»åˆ—çš„ç¬¬ä¸‰éƒ¨åˆ†å°†æ¶µç›–é‡æ„çš„æŠ€æœ¯å†…å®¹æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>æœ€åï¼ŒæŠŠæ–° mutation æ³¨å†Œåˆ°<code>MutationType</code>ä¸­ï¼š</p>

<pre><code class="language-ruby"># app/graphql/types/mutation_type.rb

module Types
  class MutationType &lt; Types::BaseObject
    # ...
    field :add_item, mutation: Mutations::AddItemMutation
    field :update_item, mutation: Mutations::UpdateItemMutation
  end
end
</code></pre>

<h3 id="updating-library-component">Updating Library component</h3>

<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ¥é‡æ–°ç”Ÿæˆä¸€ä¸‹æˆ‘ä»¬çš„ library ç»„ä»¶ä»¥éµå¾ªæ–°æ¶æ„ï¼ˆè§£æ„ operationï¼Œæ·»åŠ æ ·å¼ï¼‰ï¼š</p>

<pre><code class="language-bash">$ npx @hellsquirrel/create-gql-component create app/javascript/components/Library
</code></pre>

<p>æŠŠå¦‚ä¸‹ query æ”¾å…¥<code>operations.graphql</code>ä¸­ï¼š</p>

<pre><code class="language-graphql">query LibraryQuery {
  items {
    id
    title
    imageUrl
    description
    user {
      id
      email
    }
  }
}
</code></pre>

<p>å¹¶â€œåˆ·æ–°â€ library ç»„ä»¶çš„å®ç°æ–¹å¼ï¼š</p>

<pre><code class="language-js">// app/javascript/components/Library
import React, { useState } from "react";
import { Query } from "react-apollo";
import { LibraryQuery } from "./operations.graphql";
import cs from "./styles";

const Library = () =&gt; {
  const [item, setItem] = useState(null);
  return (
    &lt;Query query={LibraryQuery}&gt;
      {({ data, loading }) =&gt; (
        &lt;div className={cs.library}&gt;
          {loading || !data.items
            ? "loading..."
            : data.items.map(({ title, id, user, imageUrl, description }) =&gt; (
                &lt;button
                  key={id}
                  className={cs.plate}
                  onClick={() =&gt; setItem({ title, imageUrl, id, description })}
                &gt;
                  &lt;div className={cs.title}&gt;{title}&lt;/div&gt;
                  &lt;div&gt;{description}&lt;/div&gt;
                  {imageUrl &amp;&amp; &lt;img src={imageUrl} className={cs.image} /&gt;}
                  {user ? (
                    &lt;div className={cs.user}&gt;added by {user.email}&lt;/div&gt;
                  ) : null}
                &lt;/button&gt;
              ))}
        &lt;/div&gt;
      )}
    &lt;/Query&gt;
  );
};

export default Library;
</code></pre>

<p>æ³¨æ„ï¼Œæˆ‘ä»¬æŠŠæ¯ä¸ª item éƒ½åŒ…è£¹åœ¨<code>button</code> HTML å…ƒç´ å†…ï¼šæˆ‘ä»¬æœŸæœ›å®ƒä»¬æ˜¯å¯ç‚¹å‡»çš„ï¼Œä»¥å±•ç¤ºæ›´æ–°è¿‡çš„è¡¨å•ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çš„å‰ç«¯åº”ç”¨çœ‹èµ·æ¥æ¼‚äº®å¤šäº†ã€‚è®©æˆ‘ä»¬æ¥æ·»åŠ ä¸€äº›æ–°çš„äº®ç‚¹å§ï¼</p>

<h3 id="adding-form-components">Adding form components</h3>

<p>æˆ‘ä»¬æ¥ä¸ºåˆ›å»ºå’Œç¼–è¾‘ item æ·»åŠ æ›´å¤šçš„ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶éƒ½å¾ˆç±»ä¼¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠå¾ˆå¤šé€»è¾‘éƒ½æ”¾åˆ°å¯é‡ç”¨çš„<code>ProcessItemForm</code>ç»„ä»¶å†…ã€‚</p>

<pre><code class="language-bash">$ npx @hellsquirrel/create-gql-component create app/javascript/components/ProcessItemForm
</code></pre>

<p>ç»„ä»¶ä»£ç å¦‚ä¸‹ï¼š</p>

<pre><code class="language-js">// app/javascript/components/ProcessItemForm/index.js

import React, { useState } from "react";
import cs from "./styles";

const ProcessItemForm = ({
  initialTitle = "",
  initialDescription = "",
  initialImageUrl = "",
  onProcessItem,
  buttonText,
  loading
}) =&gt; {
  const [title, setTitle] = useState(initialTitle);
  const [description, setDescription] = useState(initialDescription);
  const [imageUrl, setImageUrl] = useState(initialImageUrl);
  return (
    &lt;div className={cs.form}&gt;
      &lt;input
        type="text"
        placeholder="title"
        value={title}
        className={cs.input}
        onChange={e =&gt; setTitle(e.currentTarget.value)}
      /&gt;
      &lt;input
        type="text"
        placeholder="description"
        value={description}
        className={cs.input}
        onChange={e =&gt; setDescription(e.currentTarget.value)}
      /&gt;

      &lt;input
        type="text"
        placeholder="url"
        value={imageUrl}
        className={cs.input}
        onChange={e =&gt; setImageUrl(e.currentTarget.value)}
      /&gt;
      {loading ? (
        "...Loading"
      ) : (
        &lt;button
          onClick={() =&gt; onProcessItem({ title, description, imageUrl })}
          className={cs.button}
        &gt;
          {buttonText}
        &lt;/button&gt;
      )}
    &lt;/div&gt;
  );
};

export default ProcessItemForm;
</code></pre>

<p>æˆ‘ä»¬å”¯ä¸€æ‰€éœ€è¦æ·»åŠ çš„æ˜¯åˆ›å»º item çš„ formâ€”â€”æˆ‘ä»¬æŠŠå…¶ç§°ä¸º<code>AddItemForm</code>ã€‚</p>

<pre><code class="language-bash">$ npx @hellsquirrel/create-gql-component create app/javascript/components/AddItemForm
</code></pre>

<p>æˆ‘ä»¬è¦æŠŠ AddItemMutation æ·»åŠ åˆ°<code>operations.graphql</code>ï¼š</p>

<pre><code class="language-graphql"># /app/javascript/components/AddItemForm/operations.graphql

mutation AddItemMutation(
  $title: String!
  $description: String
  $imageUrl: String
) {
  addItem(title: $title, description: $description, imageUrl: $imageUrl) {
    item {
      id
      title
      description
      imageUrl
      user {
        id
        email
      }
    }
  }
}
</code></pre>

<p>å¹¶åœ¨<code>index.js</code>ä¸­ä½¿ç”¨å®ƒï¼š</p>

<pre><code class="language-js">import React from "react";
import { Mutation } from "react-apollo";
import { AddItemMutation } from "./operations.graphql";
import ProcessItemForm from "../ProcessItemForm";

const AddItemForm = () =&gt; (
  &lt;Mutation mutation={AddItemMutation}&gt;
    {(addItem, { loading }) =&gt; (
      &lt;ProcessItemForm
        buttonText="Add Item"
        loading={loading}
        onProcessItem={({ title, description, imageUrl }) =&gt;
          addItem({
            variables: {
              title,
              description,
              imageUrl
            }
          })
        }
      /&gt;
    )}
  &lt;/Mutation&gt;
);

export default AddItemForm;
</code></pre>

<p>åˆ«å¿˜äº†æ·»åŠ  form åˆ°<code>/javascript/packs/index.js</code>ï¼š</p>

<pre><code class="language-js">import React from "react";
import { render } from "react-dom";
import Provider from "../components/Provider";
import Library from "../components/Library";
import UserInfo from "../components/UserInfo";
import AddItemForm from "../components/AddItemForm";

render(
  &lt;Provider&gt;
    &lt;UserInfo /&gt;
    &lt;AddItemForm /&gt;
    &lt;Library /&gt;
  &lt;/Provider&gt;,
  document.querySelector("#root")
);
</code></pre>

<p>ç°åœ¨æˆ‘ä»¬é­é‡äº†è·Ÿåœ¨<code>UserInfo</code>ç»„ä»¶ä¸­åŒæ ·çš„é—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦å‘ŠçŸ¥åº”ç”¨ï¼š<code>LibraryQuery</code>åº”è¯¥è¢«æ›´æ–°ã€‚å› æ­¤æˆ‘ä»¬å¿…é¡»åˆ·æ–°ç¼“å­˜ï¼šé€šè¿‡è¯»å–æ•´ä¸ªåˆ—è¡¨å¹¶æŠŠæ–° item åˆå¹¶åˆ°åˆ—è¡¨ä¸Šä»¥è®¾ç½®ä¸€ä¸ªæ–°åˆ—è¡¨ã€‚</p>

<p>æ¥æ”¹ä¸€ä¸‹<code>javascript/components/AddItemForm/index.js</code>ï¼š</p>

<pre><code class="language-js">// javascript/components/AddItemForm/index.js
// ...
import { LibraryQuery } from '../Library/operations.graphql';
// ...

&lt;ProcessItemForm
  //...
  // Update library query after Mutation will be finished
  onProcessItem={({ title, description, imageUrl }) =&gt;
    addItem({
      variables: {
        title,
        description,
        imageUrl,
      },

      // adding the second argument to 'addItem' method
      update: (cache, { data: { addItem } }) =&gt; {
        const item = addItem.item;
        if (item) {
          const currentItems = cache.readQuery({ query: LibraryQuery });
          cache.writeQuery({
            query: LibraryQuery,
            data: {
              items: [item].concat(currentItems.items),
            },
          });
        }
      },
    })
  }
  // ...
</code></pre>

<p>æå®šï¼ç°åœ¨æˆ‘ä»¬ä¼šçœ‹åˆ°æ–°çš„ item è¢«æ·»åŠ åˆ°é¡µé¢åˆ—è¡¨äº†ã€‚</p>

<p>æ¥ä¸ºæ›´æ–° item å†æ·»åŠ ä¸€ä¸ªç»„ä»¶ï¼Œç§°ä¸º<code>UpdateItemForm</code>ã€‚ä»£ç éå¸¸ç±»ä¼¼äº AddItemFormã€‚è¿è¡Œç”Ÿæˆå™¨ï¼š</p>

<pre><code class="language-bash">$ npx @hellsquirrel/create-gql-component create app/javascript/components/UpdateItemForm
</code></pre>

<p>ä¸‹é¢æ˜¯ operations æ–‡ä»¶ä¸­çš„å†…å®¹ï¼š</p>

<pre><code class="language-graphql">mutation UpdateItemMutation(
  $id: ID!
  $title: String!
  $description: String
  $imageUrl: String
) {
  updateItem(
    id: $id
    title: $title
    description: $description
    imageUrl: $imageUrl
  ) {
    item {
      id
      title
      description
      imageUrl
    }
  }
}
</code></pre>

<p>è¿™æ˜¯ç»„ä»¶æ–‡ä»¶ä¸­çš„å†…å®¹ï¼š</p>

<pre><code class="language-js">// /app/javascript/components/UpdateItemForm

import React from "react";
import { Mutation } from "react-apollo";
import { UpdateItemMutation } from "./operations.graphql";
import ProcessItemForm from "../ProcessItemForm";
import cs from "./styles";

const UpdateItemForm = ({
  id,
  initialTitle,
  initialDescription,
  initialImageUrl,
  onClose
}) =&gt; (
  &lt;div className={cs.overlay}&gt;
    &lt;div className={cs.content}&gt;
      &lt;Mutation mutation={UpdateItemMutation}&gt;
        {(updateItem, { loading }) =&gt; (
          &lt;ProcessItemForm
            initialImageUrl={initialImageUrl}
            initialTitle={initialTitle}
            initialDescription={initialDescription}
            buttonText="Update Item"
            loading={loading}
            onProcessItem={({ title, description, imageUrl }) =&gt; {
              updateItem({
                variables: {
                  id,
                  title,
                  description,
                  imageUrl
                }
              });
              onClose();
            }}
          /&gt;
        )}
      &lt;/Mutation&gt;
      &lt;button className={cs.close} onClick={onClose}&gt;
        Close
      &lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
);

export default UpdateItemForm;
</code></pre>

<p>å¹¶æŠŠ UpdateItemForm æ·»åŠ åˆ° libraryï¼ˆä½äº button ä¹‹åï¼‰ï¼š</p>

<pre><code class="language-js">// /app/javascript/components/Library/index.js

//...
import UpdateItemForm from "../UpdateItemForm";

// ...
&lt;button /&gt;;

{
  item !== null &amp;&amp; (
    &lt;UpdateItemForm
      id={item.id}
      initialTitle={item.title}
      initialDescription={item.description}
      initialImageUrl={item.imageUrl}
      onClose={() =&gt; setItem(null)}
    /&gt;
  )
}
// ...
</code></pre>

<p>ç°åœ¨å¦‚æœæˆ‘ä»¬ç‚¹å‡» item å¹¶ä¿®æ”¹ï¼Œå®ƒå°±ä¼šç¥å¥‡åœ°æ›´æ–°äº†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>

<p>å½“è·å–ä¸€ä¸ª item åˆ—è¡¨æ—¶ï¼Œå“åº”ç»“æœè¢«è§„èŒƒåŒ–ï¼Œä¸”æ¯ä¸ª item éƒ½è¢«æ·»åŠ åˆ°ç¼“å­˜ã€‚<code>apollo</code>ä¸ºæ¯ä¸ªæœ‰<code>__typename</code>å’Œ<code>id</code>çš„å®ä½“éƒ½ç”Ÿæˆä¸€ä¸ª keyï¼š<code>${object__typename}:${objectId}</code>ã€‚å½“ mutation å®Œæˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬è·å–åˆ°æœ‰ç›¸åŒ<code>__typename</code>å’Œ<code>id</code>çš„å¯¹è±¡ï¼Œ<code>apollo</code>åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°å®ƒï¼Œå¹¶è¿›è¡Œæ›´æ”¹ï¼ˆç»„ä»¶ä¹Ÿè¢«é‡æ–°æ¸²æŸ“ï¼‰ã€‚</p>

<p>æˆ‘ä»¬èƒ½åšå¾—æ›´å¥½ä¸€äº›ä¹ˆï¼Ÿå½“ç„¶ï¼</p>

<p>ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ç­‰å¾…æœåŠ¡ç«¯çš„å“åº”å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬å¯¹æœåŠ¡ç«¯æœ‰è¶³å¤Ÿçš„ä¿¡å¿ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¹è§‚å¼æ›´æ–°ã€‚è®©æˆ‘ä»¬å†æ·»åŠ ä¸€ä¸ªå‚æ•°åˆ° updateItem å‡½æ•°ï¼š</p>

<pre><code class="language-js">// /app/javascript/components/UpdateItemForm

//...
updateItem({
  variables: {
    //...
  },

  // adding the second argument to 'updateItem' method

  optimisticResponse: {
    __typename: "Mutation",
    updateItem: {
      __typename: "UpdateItemMutationPayload",
      item: {
        id,
        __typename: "Item",
        title,
        description,
        imageUrl
      }
    }
  }
});
//..
</code></pre>

<p>è¿™äº›å°±æ˜¯æœ¬æ–‡çš„å…¨éƒ¨å†…å®¹äº†ï¼æˆ‘ä»¬å­¦ä¹ äº† mutation å’Œ query ä¹‹é—´çš„åŒºåˆ«ï¼Œå­¦ä¹ äº†åœ¨åç«¯å¦‚ä½•å®ç°å®ƒä»¬ï¼Œä»¥åŠå¦‚ä½•åœ¨å‰ç«¯ä½¿ç”¨å®ƒä»¬ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çš„åº”ç”¨æ”¯æŒç”¨æˆ·ç™»å½•å’Œå›¾ä¹¦é¦†çš„ç®¡ç†ï¼Œæ‰€ä»¥å‡ ä¹å·²å‡†å¤‡å¥½å‘å¸ƒåˆ° production äº†ï¼ç„¶è€Œï¼Œä»£ç çœ‹èµ·æ¥è¿˜æœ‰äº›ç¬¨æ‹™ï¼Œæœ‰é‡æ„çš„ç©ºé—´â€”â€”è¿™æ­£æ˜¯æˆ‘ä»¬å°†åœ¨ç¬¬ä¸‰éƒ¨åˆ†ä¸­è¦åšçš„ï¼Œå¹¶æ·»åŠ ä¸€äº›å…¶ä»–æ”¹è¿›ï¼Œä¾‹å¦‚å®æ—¶æ›´æ–°å’Œæ›´å¥½çš„é”™è¯¯å¤„ç†ã€‚æ•¬è¯·å…³æ³¨ï¼</p>


</div>

<!-- Rating -->

<div class="rating mt-4 mb-4 d-flex align-items-center">
    <strong class="mr-1">Rating:</strong> <div class="rating-holder">
<div class="c-rating c-rating--regular" data-rating-value="4">
  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>4</button>
  <button>5</button>
</div>
</div>
</div>


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->


<div class="d-flex authorbox align-items-center">
    <div class="col-md-2 mr-4 text-center">
        
        <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
        
    </div>
    <div class="col-md-10"> 
        <a target="_blank" class="text-dark h4" href="https://xfyuan.github.io">About Mr.Z</a>   <a target="_blank" href="https://twitter.com/apexy" class="btn-sm"><i class="fab fa-twitter"></i></a>        
        <span class="author-description d-block mt-2">A Chinese software engineer living and working in Chengdu. I love Creating the future in digital worlds, big and small.</span>            
    </div>
</div>



<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments">
    <button class="btn btn-dark show-comments">Load Comments</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'xfyuan'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       


<!-- Share -->
<div class="share">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=GraphQL on Railsâ€”â€”æ›´æ–°&url=/2020/11/graphql-on-rails-series-2/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=/2020/11/graphql-on-rails-series-2/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=/2020/11/graphql-on-rails-series-2/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Explore more like this</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">
    
    <!-- Categories -->
    
    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/categories#Programming">Programming</a>                
    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/categories#Translation">Translation</a>                
    

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#graphql">graphql</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#rails">rails</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#ruby">ruby</a>               
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/04/hotwire-reactive-rails-with-no-javascript/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_121324.jpg" alt="Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/04/hotwire-reactive-rails-with-no-javascript/">Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails</a>
                
                <div class="mb-2 mt-2 font-weight-normal">
                <div class="rating-holder">
<div class="c-rating c-rating--regular" data-rating-value="5">
  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>4</button>
  <button>5</button>
</div>
</div>
                </div>
                
            </h2>
            <h4 class="card-text">æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆVladimir Dementyevï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡ä»‹ç»äº† Rails çš„æœ€æ–°â€œé­”æ³•â€ï¼šHotwireã€‚è¿™ä¹Ÿæ˜¯ Vladimir Dementyev åœ¨ RailsConf 2021 ä¸Šçš„æ¼”è®²å†…å®¹ã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">24 Apr 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/04/the-foundation-of-how-tailwindcss-works/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_115551.jpg" alt="Tailwindcssåº•å±‚åŸºçŸ³çš„ç†å¿µ">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/04/the-foundation-of-how-tailwindcss-works/">Tailwindcssåº•å±‚åŸºçŸ³çš„ç†å¿µ</a>
                
            </h2>
            <h4 class="card-text">Tailwindcss ä» 2019 å¹´å¼€å§‹é€æ¸åœ¨å›½å¤–çš„ Web å¼€å‘åœˆå­å†…ç››è¡Œèµ·æ¥ã€‚å›½å†…å€’æ˜¯è‡³ä»Šä»ç„¶ä¸æ¸©ä¸ç«ã€‚2020 å¹´çš„ Ruby China ä¸Šè¿‡çº¯ä¸­åšè¿‡ä¸€æ¬¡åœ¨é¡¹ç›®ä¸Šä½¿ç”¨ tailwindcss ä½“éªŒçš„æœ‰å…³æ¼”è®²ã€‚æˆ‘åœ¨ 2020 å¹´ä¹Ÿå†™è¿‡ä¸€ç¯‡æœ‰å…³çš„åšå®¢â€œåœ¨ Rails 6 ä¸­æ•´åˆ Stimulus å’Œ Tailwind CSSâ€ï¼ˆè¢«å‰è€…åœ¨æ¼”è®²ä¸­æ‰€å¼•ç”¨^_^ï¼‰ã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">10 Apr 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/03/hotwire-build-turbo-application/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_133340.jpg" alt="Hotwireä¹‹æ„å»ºTurboåº”ç”¨">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/03/hotwire-build-turbo-application/">Hotwireä¹‹æ„å»ºTurboåº”ç”¨</a>
                
            </h2>
            <h4 class="card-text">æœ¬æ–‡æ˜¯å¯¹æ„å»º Turbo åº”ç”¨çš„å…·ä½“æè¿°ï¼ŒåŸæ–‡å‡ºè‡ªï¼šhttps://turbo.hotwire.dev/handbook/buildingã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">26 Mar 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
                
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

    <script type="application/ld+json">
    {
    "@context": "http://schema.org/",
    "@type": "Review",
    "itemReviewed": {
    "@type": "Thing",
    "name": "GraphQL on Railsâ€”â€”æ›´æ–°"
    },
    "author": {
    "@type": "Person",
    "name": "Mr.Z"
    },
    "datePublished": "2020-11-24",
    "reviewRating": {
    "@type": "Rating",
    "ratingValue": "4",
    "bestRating": "5"
    }
    }
    </script>

    </div>

    

</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center text-lg-left">
                Copyright Â© 2021 The Tragedy of XY
            </div>
            <div class="col-md-6 col-sm-12 text-center text-lg-right">
                <a target="_blank" href="https://www.wowthemes.net/memoirs-free-jekyll-theme/">Memoirs Jekyll Theme</a>
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

<script src="/assets/js/prism.js"></script>

<script src="/assets/js/theme.js"></script>


<script src="/assets/js/lazyload.js"></script>



<script id="dsq-count-scr" src="//xfyuan.disqus.com/count.js"></script>


</body>
</html>
