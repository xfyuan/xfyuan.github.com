<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>GraphQL on Railsâ€”â€”å¯ç¨‹ | The Tragedy of XY</title>

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>GraphQL on Railsâ€”â€”å¯ç¨‹ | The Tragedy of XY</title>
<meta name="generator" content="Jekyll v4.1.0" />
<meta property="og:title" content="GraphQL on Railsâ€”â€”å¯ç¨‹" />
<meta name="author" content="Mr.Z" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆDmitry Tsepelevï¼‰ã€ï¼ˆPolina Gurtovayaï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡æ˜¯ Rails + React ä½¿ç”¨ GraphQLçš„ç³»åˆ—æ•™ç¨‹ç¬¬ä¸€ç¯‡ï¼Œä»‹ç»äº†ä»¥ Rails ä½œä¸ºåç«¯ï¼ŒReact + Apollo ä½œä¸ºå‰ç«¯ï¼Œå¦‚ä½•ç»è¿‡åŸºç¡€çš„é…ç½®ï¼Œæ„å»ºä¸€ä¸ªç®€å•å›¾ä¹¦é¦†åˆ—è¡¨é¡µé¢ã€‚" />
<meta property="og:description" content="æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆDmitry Tsepelevï¼‰ã€ï¼ˆPolina Gurtovayaï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡æ˜¯ Rails + React ä½¿ç”¨ GraphQLçš„ç³»åˆ—æ•™ç¨‹ç¬¬ä¸€ç¯‡ï¼Œä»‹ç»äº†ä»¥ Rails ä½œä¸ºåç«¯ï¼ŒReact + Apollo ä½œä¸ºå‰ç«¯ï¼Œå¦‚ä½•ç»è¿‡åŸºç¡€çš„é…ç½®ï¼Œæ„å»ºä¸€ä¸ªç®€å•å›¾ä¹¦é¦†åˆ—è¡¨é¡µé¢ã€‚" />
<meta property="og:site_name" content="The Tragedy of XY" />
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20201113_205558.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-12T00:00:00+00:00" />
<script type="application/ld+json">
{"dateModified":"2020-11-12T00:00:00+00:00","datePublished":"2020-11-12T00:00:00+00:00","description":"æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆDmitry Tsepelevï¼‰ã€ï¼ˆPolina Gurtovayaï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡æ˜¯ Rails + React ä½¿ç”¨ GraphQLçš„ç³»åˆ—æ•™ç¨‹ç¬¬ä¸€ç¯‡ï¼Œä»‹ç»äº†ä»¥ Rails ä½œä¸ºåç«¯ï¼ŒReact + Apollo ä½œä¸ºå‰ç«¯ï¼Œå¦‚ä½•ç»è¿‡åŸºç¡€çš„é…ç½®ï¼Œæ„å»ºä¸€ä¸ªç®€å•å›¾ä¹¦é¦†åˆ—è¡¨é¡µé¢ã€‚","url":"/2020/11/graphql-on-rails-series-1/","@type":"BlogPosting","image":"https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20201113_205558.jpg","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"},"name":"Mr.Z"},"mainEntityOfPage":{"@type":"WebPage","@id":"/2020/11/graphql-on-rails-series-1/"},"author":{"@type":"Person","name":"Mr.Z"},"headline":"GraphQL on Railsâ€”â€”å¯ç¨‹","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link href="/assets/css/prism.css" rel="stylesheet">

<link href="/assets/css/theme.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body>
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>

<!-- Begin Sidebar Navigation
================================================== -->

<div class="sidebar">
</div>
<div class="nav-icon">
    <div class="hamburger-bar"></div>
</div>
<div id="blackover-nav" class="blackover"></div>
<nav id="menu">
    <ul>
        <h3>Navigation</h3>
        <li><a href="/">Home</a></li>
        <li><a href="/categories">Categories</a></li>
        <li><a href="/about">About</a></li>
    </ul>
</nav>

<script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>


<!-- End Sidebar Navigation
================================================== -->

<div class="site-content ">

<div class="container">

    <!-- Site Logo/Name
    ================================================== -->

    <a class="navbar-brand" href="/">
        <img src="/assets/images/logo.png" alt="The Tragedy of XY">
    </a>


    <!-- Site Tag
    ================================================== -->
    

    <!-- Content
    ================================================== -->
    <div class="main-content">
        <div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">GraphQL on Railsâ€”â€”å¯ç¨‹</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
            
        </div>            
        <div>
        Written by <a target="_blank" class="text-dark" href="https://xfyuan.github.io">Mr.Z</a> on 
        <span class="post-date"><time class="post-date" datetime="2020-11-12">12 Nov 2020</time></span>           
        
        </div>            
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image lazyimg " src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20201113_205558.jpg" alt="GraphQL on Railsâ€”â€”å¯ç¨‹">
    
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <p><em>æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆDmitry Tsepelevï¼‰ã€ï¼ˆPolina Gurtovayaï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡æ˜¯ Rails + React ä½¿ç”¨ GraphQLçš„ç³»åˆ—æ•™ç¨‹ç¬¬ä¸€ç¯‡ï¼Œä»‹ç»äº†ä»¥ Rails ä½œä¸ºåç«¯ï¼ŒReact + Apollo ä½œä¸ºå‰ç«¯ï¼Œå¦‚ä½•ç»è¿‡åŸºç¡€çš„é…ç½®ï¼Œæ„å»ºä¸€ä¸ªç®€å•å›¾ä¹¦é¦†åˆ—è¡¨é¡µé¢ã€‚</em></p>

<ul>
  <li>åŸæ–‡é“¾æ¥ï¼š<a href="https://evilmartians.com/chronicles/graphql-on-rails-1-from-zero-to-the-first-query">GraphQL on Rails: From zero to the first query</a></li>
  <li>ä½œè€…ï¼š<a href="https://twitter.com/dmitrytsepelev">Dmitry Tsepelev</a>ï¼Œ<a href="https://github.com/HellSquirrel">Polina Gurtovaya</a></li>
  <li>ç«™ç‚¹ï¼šEvil Martians â€”â€”ä½äºçº½çº¦å’Œä¿„ç½—æ–¯çš„ Ruby on Rails å¼€å‘äººå‘˜åšå®¢ã€‚ å®ƒå‘å¸ƒäº†è®¸å¤šä¼˜ç§€çš„æ–‡ç« ï¼Œå¹¶ä¸”æ˜¯ä¸å°‘ gem çš„èµåŠ©å•†ã€‚</li>
</ul>

<p><em>ã€æ­£æ–‡å¦‚ä¸‹ã€‘</em></p>

<h2 id="å¼•è¨€">å¼•è¨€</h2>

<p><strong>è¿™æ˜¯ä¸€ä¸ªåœ¨åç«¯ä½¿ç”¨ Railsã€å‰ç«¯ä½¿ç”¨ React/Apollo æ¥å¼€å‘ GraphQL åº”ç”¨ç¨‹åºçš„æ—…è¡Œè€…æŒ‡å¯¼ã€‚è·Ÿéšè¯¥ç³»åˆ—æ•™ç¨‹å¯é€šè¿‡èŒƒä¾‹å­¦åˆ°æ—¢æœ‰åŸºç¡€çš„ã€ä¹Ÿæœ‰é«˜çº§çš„ä¸»é¢˜å†…å®¹ï¼Œè®©ä½ é¢†ç•¥ç°ä»£æŠ€æœ¯çš„å¨åŠ›ã€‚</strong></p>

<p><a href="https://graphql.org/">GraphQL</a> æ˜¯æˆ‘ä»¬åœ¨ä»»ä½•åœ°æ–¹ï¼ˆåšå®¢ã€ä¼šè®®ã€æ’­å®¢ï¼Œç”šè‡³æŠ¥çº¸ï¼‰éƒ½èƒ½è§åˆ°çš„æ–°é¢–äº‹ç‰©ä¹‹ä¸€ã€‚å¬èµ·æ¥ä½ åº”è¯¥æŠ“ç´§æ—¶é—´ï¼Œå°½å¿«å¼€å§‹ä»¥ GraphQL è€Œé REST æ¥é‡å†™åº”ç”¨ç¨‹åºï¼Œå¯¹å§ï¼Ÿäº‹å®å¹¶éå¦‚æ­¤ã€‚è®°ä½ï¼šæ²¡æœ‰é“¶å¼¹ã€‚åœ¨è¿›è¡Œå†³ç­–ä¹‹å‰ç†è§£è¯¥æŠ€æœ¯çš„ä¼˜åŠ£æ˜¯å®Œå…¨æœ‰å¿…è¦çš„ã€‚</p>

<p>æœ¬ç³»åˆ—ä¸­ï¼Œæˆ‘ä»¬å°†ç»™ä½ ä¸€ä¸ª GraphQL åº”ç”¨ç¨‹åºå¼€å‘çš„ç®€æ´æŒ‡å—ï¼Œä¸æ­¢è°ˆåˆ°å…¶ä¼˜ç‚¹ï¼Œä¹Ÿä¼šè®¨è®ºå…¶æ³¨æ„äº‹é¡¹ä¹ƒè‡³é™·é˜±ï¼ˆå½“ç„¶ï¼Œè¿˜æœ‰å¦‚ä½•å¤„ç†å®ƒä»¬çš„æ–¹æ³•ï¼‰ã€‚</p>

<h2 id="graphql-in-a-nutshell">GraphQL in a nutshell</h2>

<p>æ ¹æ®<a href="https://graphql.github.io/graphql-spec/">è§„èŒƒ</a>ï¼ŒGraphQLæ˜¯ä¸€ç§<em>æŸ¥è¯¢è¯­è¨€</em>å’Œ <em>runtimeï¼ˆæˆ–æ‰§è¡Œå¼•æ“ï¼‰</em>ã€‚æŸ¥è¯¢è¯­è¨€ï¼Œ<a href="https://en.wikipedia.org/wiki/Query_language">æŒ‰ç…§å®šä¹‰</a>ï¼Œæè¿°äº†å¦‚ä½•ä¸ä¸€ä¸ªä¿¡æ¯ç³»ç»Ÿè¿›è¡Œé€šä¿¡ã€‚Runtime åˆ™è´Ÿè´£å®ç°æ•°æ®çš„æŸ¥è¯¢ã€‚</p>

<p>æ¯ä¸ª GraphQL åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒéƒ½åœ¨äºä¸€ä¸ª <a href="https://graphql.org/learn/schema/"><em>schema</em></a>ï¼šå®ƒä»¥æœ‰å‘å›¾çš„å½¢å¼æè¿°åº•å±‚æ•°æ®ã€‚Runtime å¿…é¡»æ ¹æ®è¯¥ schemaï¼ˆåŠè§„èŒƒä¸­çš„ä¸€äº›é€šç”¨è§„åˆ™ï¼‰æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚è¿™æ„å‘³ç€ï¼Œæ¯ä¸ªæœ‰æ•ˆçš„ GraphQL æœåŠ¡ç«¯éƒ½ä»¥ç›¸åŒçš„æ–¹å¼è¿è¡ŒæŸ¥è¯¢ï¼Œå¹¶ä»¥ç›¸åŒçš„æ ¼å¼è¿”å›ç›¸åŒ schema çš„æ•°æ®ã€‚æ¢å¥è¯è¯´ï¼Œschema å°±æ˜¯å®¢æˆ·ç«¯åº”äº†è§£åˆ°çš„å…³äº API çš„ä¸€åˆ‡ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ GraphQL æŸ¥è¯¢çš„ä¾‹å­ï¼š</p>

<pre><code class="language-graphql">query getProduct($id: Int!) {
  product(id: $id) {
    id
    title
    manufacturer {
      name
    }
  }
}
</code></pre>

<p>è®©æˆ‘ä»¬æ¥ä¸€è¡Œä¸€è¡Œè§£æå®ƒï¼š</p>

<ul>
  <li>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå…·åæŸ¥è¯¢ï¼ˆ<code>getProduct</code>æ˜¯æ“ä½œåï¼‰ï¼Œæ¥æ”¶å•ç‹¬ä¸€ä¸ªå‚æ•°ï¼ˆ<code>$id</code>ï¼‰ã€‚æ“ä½œåæ˜¯å¯é€‰çš„ï¼Œä½†å®ƒä¼šå¯¹å¯è¯»æ€§æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿèƒ½ç”¨äºå‰ç«¯è¿›è¡Œç¼“å­˜ã€‚</li>
  <li>æˆ‘ä»¬ä» schema çš„â€œæ ¹â€ä¸Šâ€œé€‰æ‹©â€äº†<code>product</code>å­—æ®µï¼Œå¹¶ä¼ é€’<code>$id</code>å€¼ä½œä¸ºå‚æ•°ã€‚</li>
  <li>æˆ‘ä»¬æè¿°äº†æœŸæœ›è·å–çš„é‚£äº›å­—æ®µï¼šè¯¥åœºæ™¯ä¸­ï¼Œæ˜¯æƒ³è¦å¾—åˆ° product çš„<code>id</code>å’Œ<code>title</code>ï¼Œä»¥åŠ manufacturer çš„<code>name</code>ã€‚</li>
</ul>

<p><strong>æœ¬è´¨ä¸Šï¼Œä¸€ä¸ªæŸ¥è¯¢ä»£è¡¨äº† schema çš„ä¸€ä¸ªå­å›¾ï¼Œè¿™å¸¦æ¥äº† GraphQL çš„ç¬¬ä¸€ä¸ªå¥½å¤„â€”â€”æˆ‘ä»¬å¯ä»¥åœ¨å•ä¸ªæŸ¥è¯¢ä¸­ï¼Œä»…è·å–è‡ªå·±æ‰€éœ€è¦çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥è·å–ä¸€æ¬¡æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚</strong></p>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±è§£å†³äº†ä¼ ç»Ÿ REST API çš„ä¸€ä¸ªå¸¸è§é—®é¢˜â€”â€”<em>overfetchingï¼ˆè¿‡é‡è·å–ï¼‰</em>ã€‚</p>

<p>å¦ä¸€ä¸ªå…³äº GraphQL schema çš„æ˜æ˜¾ç‰¹æ€§æ˜¯å®ƒä»¬ä¸ºå¼ºç±»å‹çš„ï¼ˆ<em>strongly</em> <em>typed</em>ï¼‰ï¼šå®¢æˆ·ç«¯å’Œ runtime ä¸¤è¾¹éƒ½ç¡®ä¿äº†ä»åº”ç”¨ç¨‹åºçš„ç±»å‹ç³»ç»Ÿè§’åº¦çœ‹ï¼Œæ‰€ä¼ é€’çš„æ•°æ®æ˜¯åˆæ³•çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰äººé”™è¯¯ä¼ é€’äº†ä¸€ä¸ªå­—ç¬¦ä¸²çš„å€¼ä½œä¸º<code>$id</code>ç»™ä¸Šé¢çš„æŸ¥è¯¢ï¼Œå®¢æˆ·ç«¯å°±ä¼šå› æŠ›å‡ºå¼‚å¸¸è€Œå¤±è´¥ï¼Œç”šè‡³ä¸ä¼šå°è¯•æ‰§è¡ŒæŸ¥è¯¢ã€‚</p>

<p>æœ€åä½†å¹¶éæœ€ç»ˆçš„ä¸€ä¸ªå¥½å¤„æ˜¯ schema çš„<em>è‡ªçœ</em>ï¼šå®¢æˆ·ç«¯å¯ä»¥ä» schema è‡ªèº«æ¥å­¦ä¹  APIï¼Œè€Œæ— éœ€ä»»ä½•é¢å¤–çš„æ–‡æ¡£èµ„æºã€‚</p>

<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº† GraphQL çš„ä¸å°‘ç†è®ºéƒ¨åˆ†ã€‚ç°åœ¨è¯¥æ¥åšä¸€äº›ä»£ç ç»ƒä¹ äº†ï¼Œä»¥ç¡®ä¿ä½ ä¸ä¼šæ˜æ—©èµ·æ¥å°±å¿˜æ‰ä¸€åˆ‡ã€‚</p>

<h2 id="what-are-we-going-to-build">What are we going to build?</h2>

<p>é€šè¿‡è¿™ä¸ªç³»åˆ—ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªä»£è¡¨â€œMartian Libraryâ€çš„åº”ç”¨ç¨‹åºâ€”â€”ä¸€ä¸ªå½±è§†ã€ä¹¦ç±åŠå…¶ä»–ä¸ã€Šçº¢è‰²æ˜Ÿçƒã€‹æœ‰å…³çš„äº‹ç‰©çš„ä¸ªäººåœ¨çº¿æ”¶è—ã€‚</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/application-32576ed.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/application-32576ed.png" /></p>

<p>å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ï¼š</p>

<ul>
  <li>åç«¯ä½¿ç”¨Ruby 2.6 å’Œ Rails 6ï¼ˆ<a href="https://evilmartians.com/chronicles/rails-6-b-sides-and-rarities">RC ç‰ˆæœ¬åœ¨æ­¤</a>ï¼‰ã€è¯‘è€…æ³¨ï¼šRails 6 æ­£å¼ç‰ˆç›®å‰å·²ç»å‘å¸ƒäº†ã€‘</li>
  <li>å‰ç«¯ä½¿ç”¨ Node.js 9+ï¼ŒReact 16.3+ï¼Œå’Œ Apolloï¼ˆå®¢æˆ·ç«¯ç‰ˆæœ¬ 2+ï¼‰ï¼Œè¦ç¡®ä¿ä½ å·²ç»æ ¹æ®<a href="https://yarnpkg.com/en/docs/install#mac-stable">æŒ‡å¯¼</a>å®‰è£…äº† yarnã€‚</li>
</ul>

<p>ä½ å¯ä»¥åœ¨<a href="https://github.com/evilmartians/chronicles-gql-martian-library/tree/part-1">è¿™é‡Œ</a>æ‰¾åˆ°æºç â€”â€”åˆ«å¿˜äº†åœ¨é¦–æ¬¡è¿è¡Œå‰æ‰§è¡Œ<code>bundle install &amp;&amp; yarn install</code>ã€‚<a href="https://github.com/evilmartians/chronicles-gql-martian-library">Master åˆ†æ”¯</a>æ˜¯è¯¥é¡¹ç›®çš„å½“å‰æœ€æ–°çŠ¶æ€ã€‚</p>

<h2 id="setting-up-a-new-rails-project">Setting up a new Rails project</h2>

<p>å¦‚æœé˜…è¯»æœ¬æ–‡çš„æ—¶å€™ Rails 6.0 è¿˜æ²¡æœ‰å‘å¸ƒï¼Œé‚£ä¹ˆä½ å¯èƒ½éœ€è¦å…ˆå®‰è£… rc ç‰ˆæœ¬ï¼š</p>

<pre><code class="language-bash">$ gem install rails --pre
$ rails -v
=&gt; Rails 6.0.0.rc1
</code></pre>

<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥æ¥è¿è¡Œä¸‹é¢è¿™ä¸ªè¶…çº§é•¿çš„<code>rails new</code>å‘½ä»¤äº†ï¼š</p>

<pre><code class="language-bash">$ rails new martian-library -d postgresql --skip-action-mailbox --skip-action-text --skip-spring --webpack=react -T --skip-turbolinks
</code></pre>

<p>æ¯”èµ· Rails å®˜æ–¹çš„<a href="https://dhh.dk/2012/rails-is-omakase.html">â€œä¸»å¨ç²¾é€‰â€</a>ï¼Œæˆ‘ä»¬æ›´å–œæ¬¢è‡ªå·±æ¥å®šåˆ¶ï¼šç•¥å»æ‰€ä¸éœ€è¦çš„æ¡†æ¶å’Œåº“ï¼Œé€‰æ‹© PostgreSQL ä½œä¸ºæ•°æ®åº“ï¼Œä»¥é¢„é…ç½®çš„ Webpacker æ¥ä½¿ç”¨ Reactï¼Œå»æ‰äº†æµ‹è¯•ï¼ˆåˆ«æ‹…å¿ƒâ€”â€”æˆ‘ä»¬ä¼šå¾ˆå¿«åŠ ä¸Š RSpec çš„ï¼‰ã€‚</p>

<p>åœ¨ä½ å¼€å§‹ä¹‹å‰ï¼Œå¼ºçƒˆå»ºè®®å…³é—­<code>config/application.rb</code>å†…æ‰€æœ‰ä¸å¿…è¦çš„ç”Ÿæˆå™¨ï¼š</p>

<pre><code class="language-ruby">config.generators do |g|
  g.test_framework  false
  g.stylesheets     false
  g.javascripts     false
  g.helper          false
  g.channel         assets: false
end
</code></pre>

<h2 id="preparing-the-data-model">Preparing the data model</h2>

<p>æˆ‘ä»¬éœ€è¦è‡³å°‘ä¸¤ä¸ª modelï¼š</p>

<ul>
  <li>ç”¨<code>Item</code>æ¥æè¿°ä»»ä½•æˆ‘ä»¬æƒ³è¦å­˜å‚¨åœ¨å›¾ä¹¦é¦†ä¸­çš„å®ä½“ï¼ˆä¹¦ç±ã€ç”µå½±ç­‰ï¼‰ã€‚</li>
  <li>ç”¨<code>User</code>æ¥ä»£è¡¨åº”ç”¨ç¨‹åºé‡Œèƒ½å¤Ÿç®¡ç†æ”¶è—å“ä¸­è¿™äº› items çš„ç”¨æˆ·ã€‚</li>
</ul>

<p>è®©æˆ‘ä»¬æ¥ç”Ÿæˆå®ƒä»¬ï¼š</p>

<pre><code class="language-bash">$ rails g model User first_name last_name email
$ rails g model Item title description:text image_url user:references
</code></pre>

<p>åˆ«å¿˜äº†æ·»åŠ <code>has_many :items</code>çš„å…³è”å…³ç³»åˆ°<code>app/models/user.rb</code>ï¼š</p>

<pre><code class="language-ruby"># app/models/user.rb
class User &lt; ApplicationRecord
  has_many :items, dependent: :destroy
end
</code></pre>

<p>æ¥æ·»åŠ ä¸€äº›é¢„ç”Ÿæˆçš„æ•°æ®åˆ°<code>db/seeds.rb</code>ï¼š</p>

<pre><code class="language-ruby"># db/seeds.rb
john = User.create!(
  email: "john.doe@example.com",
  first_name: "John",
  last_name: "Doe"
)

jane = User.create!(
  email: "jane.doe@example.com",
  first_name: "Jane",
  last_name: "Doe"
)

Item.create!(
  [
    {
      title: "Martian Chronicles",
      description: "Cult book by Ray Bradbury",
      user: john,
      image_url: "https://upload.wikimedia.org/wikipedia/en/4/45/The-Martian-Chronicles.jpg"
    },
    {
      title: "The Martian",
      description: "Novel by Andy Weir about an astronaut stranded on Mars trying to survive",
      user: john,
      image_url: "https://upload.wikimedia.org/wikipedia/en/c/c3/The_Martian_2014.jpg"
    },
    {
      title: "Doom",
      description: "A group of Marines is sent to the red planet via an ancient " \
                   "Martian portal called the Ark to deal with an outbreak of a mutagenic virus",
      user: jane,
      image_url: "https://upload.wikimedia.org/wikipedia/en/5/57/Doom_cover_art.jpg"
    },
    {
      title: "Mars Attacks!",
      description: "Earth is invaded by Martians with unbeatable weapons and a cruel sense of humor",
      user: jane,
      image_url: "https://upload.wikimedia.org/wikipedia/en/b/bd/Mars_attacks_ver1.jpg"
    }
  ]
)
</code></pre>

<p>æœ€åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥åˆå§‹åŒ–æ•°æ®åº“äº†ï¼š</p>

<pre><code class="language-bash">$ rails db:create db:migrate db:seed
</code></pre>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»å¾€è‡ªå·±çš„ç³»ç»Ÿé‡Œå¡å…¥äº†ä¸€äº›å†…å®¹ï¼Œé‚£å°±æ¥æ·»åŠ è®¿é—®å®ƒä»¬çš„æ–¹å¼å§ï¼</p>

<h2 id="adding-a-graphql-endpoint">Adding a GraphQL endpoint</h2>

<p>ä¸ºäº†â€œåˆ¶ä½œâ€æˆ‘ä»¬çš„ GraphQL APIï¼Œå°†ä½¿ç”¨<a href="https://github.com/rmosolgo/graphql-ruby">graphql-ruby</a> gemï¼š</p>

<pre><code class="language-bash"># First, add it to the Gemfile
$ bundle add graphql --version="~&gt; 1.9"
# Then, run the generator
$ rails generate graphql:install
</code></pre>

<p>ä½ å¯èƒ½ä¼šæƒŠè®¶äºä¸€ä¸ªæœ€å°åŒ–çš„<code>graphql-ruby</code>åº”ç”¨ç¨‹åºæ‰€éœ€æ–‡ä»¶çš„æ•°é‡ï¼šå¦‚ä¸‹çš„æ ·æ¿å°±æ˜¯æˆ‘ä»¬ä¸ºä¸Šè¿°æ‰€æœ‰ç‰©å“æ‰€æ”¯ä»˜çš„ä»£ä»·ã€‚</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/generator-d6a5280.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/generator-d6a5280.png" /></p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ schemaï¼Œ<code>martian_library_schema.rb</code>ï¼š</p>

<pre><code class="language-ruby"># app/graphql/martian_library_schema.rb
class MartianLibrarySchema &lt; GraphQL::Schema
  query(Types::QueryType)
  mutation(Types::MutationType)
end
</code></pre>

<p>è¯¥ schema å®£å¸ƒäº†æ‰€æœ‰ query éƒ½åº”è¯¥åœ¨<code>Types::QueryType</code>ï¼Œè€Œæ‰€æœ‰ mutation éƒ½åº”è¯¥åœ¨<code>Types::MutationType</code>ã€‚æˆ‘ä»¬å°†åœ¨æœ¬ç³»åˆ—æ•™ç¨‹çš„ç¬¬äºŒéƒ¨åˆ†æ¥æ·±å…¥æ¢è®¨ mutationã€‚æœ¬æ–‡çš„ç›®æ ‡åˆ™æ˜¯å­¦ä¹ å¦‚ä½•ç¼–å†™å’Œæ‰§è¡Œ queryã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬æ‰“å¼€<code>types/query_type.rb</code> ç±»â€”â€”å®ƒæ˜¯æ‰€æœ‰ query çš„å…¥å£ã€‚é‡Œé¢æœ‰ä»€ä¹ˆå‘¢ï¼Ÿ</p>

<pre><code class="language-ruby"># app/graphql/types/query_type.rb
module Types
  class QueryType &lt; Types::BaseObject
    # Add root-level fields here.
    # They will be entry points for queries on your schema.

    # TODO: remove me
    field :test_field, String, null: false,
      description: "An example field added by the generator"
    def test_field
      "Hello World!"
    end
  end
end
</code></pre>

<p>è¿™è¯æ˜äº†<code>QueryType</code>å°±æ˜¯ä¸€ä¸ªé€šç”¨ typeï¼šå…¶ç»§æ‰¿äº<code>Types::BaseObject</code>ï¼ˆæˆ‘ä»¬ä¼šæŠŠå®ƒç”¨ä½œæ‰€æœ‰ type çš„åŸºæœ¬ç±»ï¼‰ï¼Œå¹¶ä¸”å®ƒæœ‰ <em>field å®šä¹‰</em>â€”â€”æˆ‘ä»¬æ•°æ®å›¾çš„èŠ‚ç‚¹ã€‚å”¯ä¸€ä½¿å¾—<code>QueryType</code>æœ‰æ‰€ä¸åŒçš„æ˜¯ GraphQL éœ€è¦è¿™ä¸ª type å¿…é¡»å­˜åœ¨ï¼ˆè€Œ<code>mutation</code>å’Œ<code>subscription</code> ä¸¤ç§ type æ˜¯å¯é€‰è€Œéå¿…é¡»ï¼‰ã€‚</p>

<p>æ³¨æ„åˆ°ä¸Šé¢çš„ä»£ç å®é™…ä¸Šä»…æ˜¯ä¸€ä¸ªâ€hello worldâ€äº†å—ï¼Ÿåœ¨ç»§ç»­å¾€ä¸‹èµ°ä¹‹å‰ï¼ˆä¸”å¤§é‡çš„ä»£ç ä½¿ä½ åŒå€¦ï¼‰ï¼Œæˆ‘ä»¬ä¼šå‘ä½ å±•ç¤ºå¦‚ä½•åœ¨æµè§ˆå™¨ä¸­è·å–è¯¥â€œhello worldâ€çš„å†…å®¹ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸‹ç”Ÿæˆå™¨å·²ç»å¾€<code>config/routes.rb</code>ä¸­æ·»åŠ äº†ä»€ä¹ˆï¼š</p>

<pre><code class="language-ruby"># config/routes.rb
Rails.application.routes.draw do
  mount GraphiQL::Rails::Engine, at: "/graphiql", graphql_path: "/graphql" if Rails.env.development?
  post "/graphql", to: "graphql#execute"
end
</code></pre>

<p>Mount çš„<code>GraphiQL::Rails::Engine</code>è®©æˆ‘ä»¬èƒ½ä½¿ç”¨ä¸€ä¸ªç§°ä¸º <a href="https://github.com/graphql/graphiql">GraphiQL</a> çš„ web ç•Œé¢æ¥æµ‹è¯•è‡ªå·±çš„ query å’Œ mutationã€‚å¦‚å‰æ‰€è¿°ï¼Œschema æ˜¯å¯è¢«æ£€æŸ¥çš„ï¼Œè€Œ GraphiQL åˆ™ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ä¸ºæˆ‘ä»¬æ¥æ„å»ºäº¤äº’æ–‡æ¡£ã€‚æ¥è¯•ä¸€è¯•å§ï¼</p>

<pre><code class="language-bash"># Let's run a Rails web server
$ rails s
</code></pre>

<p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:3000/graphiqlï¼š</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/graphiql-4633e9d.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/graphiql-4633e9d.png" /></p>

<p>åœ¨å·¦ä¾§çª—å£ï¼Œä½ å¯ä»¥è¾“å…¥ä¸€ä¸ª query æ¥æ‰§è¡Œï¼Œç„¶åç‚¹å‡»â€œplayâ€æŒ‰é’®ï¼ˆæˆ–æŒ‰ä¸‹<em>Ctrl/Cmd+Enter</em>ï¼‰ï¼Œå³å¯åœ¨å³ä¾§çª—å£çœ‹åˆ°å“åº”ç»“æœã€‚ç‚¹å‡»å³ä¸Šè§’çš„â€œDocsâ€é“¾æ¥ï¼Œä½ å°±å¯ä»¥æµè§ˆ schemaã€‚</p>

<p>æ¥çœ‹ä¸‹æ—¥å¿—â€”â€”æˆ‘ä»¬æƒ³è¦çŸ¥é“å½“æŒ‰ä¸‹æ‰§è¡ŒæŒ‰é’®æ—¶å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/execute_log-e654371.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/execute_log-e654371.png" /></p>

<p>è¯·æ±‚è¢«å‘é€åˆ°<code>GraphlController</code>ï¼Œå…¶ä¹Ÿæ˜¯ç”±<code>graphql</code> gem çš„ç”Ÿæˆå™¨æ·»åŠ åˆ°åº”ç”¨ç¨‹åºçš„ã€‚</p>

<p>çœ‹ä¸€çœ¼<code>GraphlController#execute</code>æ–¹æ³•ï¼š</p>

<pre><code class="language-ruby"># app/controllers/graphql_controller.rb
def execute
  variables = ensure_hash(params[:variables])
  query = params[:query]
  operation_name = params[:operationName]
  context = {
    # Query context goes here, for example:
    # current_user: current_user,
  }
  result = GraphqlSchema.execute(
    query,
    variables: variables,
    context: context,
    operation_name: operation_name
  )
  render json: result
rescue StandardError =&gt; e
  raise e unless Rails.env.development?

  handle_error_in_development e
end
</code></pre>

<p>è¯¥æ–¹æ³•è°ƒç”¨äº†<code>GraphqlSchema#execute</code>æ–¹æ³•ï¼Œä»¥å¦‚ä¸‹å‚æ•°ï¼š</p>

<ul>
  <li><code>query</code>å’Œ<code>variables</code>åˆ†åˆ«ä»£è¡¨ä¸€ä¸ª query å­—ç¬¦ä¸²å’Œå®¢æˆ·ç«¯å‘é€çš„å‚æ•°ï¼›</li>
  <li><code>context</code>æ˜¯ä¸€ä¸ªä»»æ„ hashï¼Œåœ¨ query æ‰§è¡Œçš„ä»»ä½•åœ°æ–¹éƒ½æ˜¯å¯ç”¨çš„ï¼›</li>
  <li><code>operation_name</code>ä»è¿›æ¥çš„è¯·æ±‚ä¸­å–å‡ºä¸€ä¸ªå‘½åæ“ä½œæ¥æ‰§è¡Œï¼ˆå¯ä»¥ä¸ºç©ºï¼‰ã€‚</li>
</ul>

<p>æ‰€æœ‰çš„é­”æ³•éƒ½å‘ç”Ÿåœ¨è¿™ä¸ªæ–¹æ³•å†…ï¼šå®ƒè§£æ queryï¼Œæ£€æµ‹æ‰€æœ‰å°†è¢«ç”¨æ¥æ„å»ºå“åº”çš„ typeï¼Œå¹¶å†³å®šæ‰€æœ‰è¢«è¯·æ±‚åˆ°çš„å­—æ®µã€‚æˆ‘ä»¬å”¯ä¸€éœ€è¦åšçš„äº‹å°±æ˜¯å®šä¹‰è¿™äº› typeï¼Œå¹¶å£°æ˜å­—æ®µåº”è¯¥è¢«æ€æ ·å†³å®šã€‚</p>

<h2 id="whats-in-the-martian-library">Whatâ€™s in the Martian Library?</h2>

<p>è®©æˆ‘ä»¬ä»â€œhello worldâ€è½¬åˆ°æ›´çœŸå®çš„ä¸œè¥¿ï¼šä»<code>Types::QueryType</code>ç§»é™¤èŒƒä¾‹å†…å®¹å¹¶æ³¨å†Œä¸€ä¸ªç§°ä¸º<code>:items</code>çš„å­—æ®µï¼Œå…¶å°†è¿”å›æ‰€æœ‰å›¾ä¹¦é¦†çš„ itemsã€‚æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸ºè¯¥å­—æ®µæ·»åŠ ä¸€ä¸ª resolver æ–¹æ³•ï¼ˆresolver æ–¹æ³•åå¿…é¡»åŒ¹é…å­—æ®µåï¼‰ï¼š</p>

<pre><code class="language-ruby"># app/graphql/types/query_type.rb
module Types
  class QueryType &lt; Types::BaseObject
    field :items,
          [Types::ItemType],
          null: false,
          description: "Returns a list of items in the martian library"

    def items
      Item.all
    end
  end
end
</code></pre>

<p>æ¯ä¸ªå­—æ®µå®šä¹‰éƒ½åŒ…å«ä¸€ä¸ªåç§°ï¼Œä¸€ä¸ªå…¶ç»“æœç±»å‹ï¼ŒåŠä¸€äº›é€‰é¡¹ã€‚<code>:null</code>æ˜¯éœ€è¦çš„ï¼Œå¿…é¡»è®¾ä¸º<code>true</code>æˆ–è€…<code>false</code>ã€‚æˆ‘ä»¬ä¹Ÿå®šä¹‰äº†å¯é€‰çš„<code>:description</code>â€”â€”ä¸ºå­—æ®µæ·»åŠ æ˜“äºé˜…è¯»çš„ä¿¡æ¯æ˜¯ä¸€ç§å¥½çš„å®è·µï¼šå®ƒä¼šè¢«è‡ªåŠ¨æ·»åŠ åˆ°æ–‡æ¡£ä¸­ï¼Œä¸ºå¼€å‘è€…æä¾›æ›´å¤šç›¸å…³ä¿¡æ¯ã€‚å¯¹äºç»“æœç±»å‹çš„æ•°ç»„è¡¨ç¤ºï¼Œ<code>[Types::ItemType]</code>ï¼Œæ„å‘³ç€å­—æ®µçš„å€¼å¿…é¡»æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¸”å…¶æ¯ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯<code>Types::ItemType</code>ç±»å‹ã€‚</p>

<p>ä½†æˆ‘ä»¬è¿˜æ²¡æœ‰å®šä¹‰<code>ItemType</code>ï¼Œå¯¹å§ï¼Ÿå¹¸è¿çš„æ˜¯ï¼Œ<code>graphql</code> gem ç»™äº†ä¸€ä¸ªæ–¹ä¾¿çš„ç”Ÿæˆå™¨ï¼š</p>

<pre><code class="language-bash">$ rails g graphql:object item
</code></pre>

<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹æ–°åˆ›å»ºçš„<code>app/graphql/types/item_type.rb</code>ä¸ºæƒ³è¦çš„æ ·å­äº†ã€‚</p>

<pre><code class="language-ruby"># app/graphql/types/item_type.rb
module Types
  class ItemType &lt; Types::BaseObject
    field :id, ID, null: false
    field :title, String, null: false
    field :description, String, null: true
    field :image_url, String, null: true
  end
end
</code></pre>

<p>å¦‚ä¸Šæ‰€è§ï¼Œæˆ‘ä»¬åœ¨<code>ItemType</code>ä¸­æš´éœ²äº†ä¸‰ä¸ªå­—æ®µï¼š</p>

<ul>
  <li>é null çš„å­—æ®µï¼Œ<code>id</code>å’Œ<code>title</code></li>
  <li>å¯ä¸º null çš„å­—æ®µ<code>description</code></li>
</ul>

<p>æˆ‘ä»¬çš„æ‰§è¡Œå¼•æ“è§£æå†³å®šå­—æ®µæ—¶æ˜¯ä½¿ç”¨å¦‚ä¸‹ç®—æ³•ï¼ˆç•¥æœ‰ç®€åŒ–ï¼‰ï¼š</p>

<ul>
  <li>é¦–å…ˆï¼Œå®ƒåœ¨ type ç±»è‡ªèº«å†…æŸ¥æ‰¾åŒåå®šä¹‰çš„æ–¹æ³•ï¼ˆå¦‚åŒå‰é¢æˆ‘ä»¬åœ¨<code>QueryType</code>ä¸­å¯¹<code>items</code>åšçš„ä¸€æ ·ï¼‰ï¼›æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>object</code>æ–¹æ³•æ¥è®¿é—®è¢«è§£æå†³å®šçš„å¯¹è±¡ã€‚</li>
  <li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°è¿™æ ·å®šä¹‰çš„æ–¹æ³•ï¼Œå®ƒå°±å°è¯•åœ¨<code>object</code>ä¸Šå»è°ƒç”¨åŒåæ–¹æ³•ã€‚</li>
</ul>

<p>æˆ‘ä»¬åœ¨ type ç±»ä¸­æ²¡æœ‰å®šä¹‰ä»»ä½•æ–¹æ³•ï¼Œå› æ­¤å‡å®šåº•å±‚å®ç°äº†æ‰€æœ‰å­—æ®µçš„æ–¹æ³•ã€‚</p>

<p>å›åˆ°http://localhost:3000/graphiqlï¼Œæ‰§è¡Œå¦‚ä¸‹ queryï¼Œç¡®è®¤åœ¨å“åº”ä¸­è·å–åˆ°äº†æ‰€æœ‰ items çš„åˆ—è¡¨ï¼š</p>

<pre><code class="language-graphql">{
  items {
    id
    title
    description
  }
}
</code></pre>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ä½“ç° graph å¨åŠ›çš„åŠŸèƒ½â€”â€”å½“å‰çš„ graph æ·±åº¦åªæœ‰ä¸€å±‚ã€‚è®©æˆ‘ä»¬æ¥æ·»åŠ ä¸€ä¸ªéåˆå§‹èŠ‚ç‚¹åˆ°<code>ItemType</code>ä¸Šï¼Œè®© graph å¤æ‚ä¸€ç‚¹ã€‚æ¯”å¦‚ï¼Œæ·»åŠ ä¸€ä¸ª<code>user</code>å­—æ®µæ¥ä»£è¡¨ item çš„åˆ›å»ºè€…ï¼š</p>

<pre><code class="language-ruby"># app/graphql/types/item_type.rb
module Types
  class ItemType &lt; Types::BaseObject
    # ...
    field :user, Types::UserType, null: false
  end
end
</code></pre>

<p>é‡å¤ä½¿ç”¨ç›¸åŒçš„ç”Ÿæˆå™¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ type ç±»ï¼š</p>

<pre><code class="language-bash">$ rails g graphql:object user
</code></pre>

<p>è¿™ä¸€æ¬¡æˆ‘ä»¬è¿˜æƒ³è¦æ·»åŠ ä¸€ä¸ªè®¡ç®—å­—æ®µâ€”â€”<code>full_name</code>ï¼š</p>

<pre><code class="language-ruby"># app/graphql/types/user_type.rb
module Types
  class UserType &lt; Types::BaseObject
    field :id, ID, null: false
    field :email, String, null: false
    field :full_name, String, null: false

    def full_name
      # `object` references the user instance
      [object.first_name, object.last_name].compact.join(" ")
    end
  end
end
</code></pre>

<p>ä½¿ç”¨å¦‚ä¸‹ query æ¥è·Ÿ items ä¸€èµ·è·å– usersï¼š</p>

<pre><code class="language-graphql">{
  items {
    id
    title
    user {
      id
      email
    }
  }
}
</code></pre>

<p>åˆ°è¿™ä¸€æ­¥æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠç›®å…‰ä»åç«¯ç§»åˆ°å‰ç«¯äº†ã€‚è®©æˆ‘ä»¬æ¥ä¸ºè¿™ä¸ª API æ„å»ºä¸€ä¸ªå®¢æˆ·ç«¯å§ï¼</p>

<h2 id="configuring-the-frontend-application">Configuring the frontend application</h2>

<p>æ­£å¦‚å·²ç»æåˆ°çš„ï¼Œæˆ‘ä»¬æ¨èä½ å®‰è£…<a href="https://www.apollographql.com/docs/react/">Apollo</a> æ¡†æ¶æ¥å¤„ç†å®¢æˆ·ç«¯çš„ GraphQLã€‚</p>

<p>è¦è®©ä¸€åˆ‡é¡ºåˆ©è¿è½¬ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…æ‰€æœ‰éœ€è¦çš„ä¾èµ–åº“ï¼š</p>

<pre><code class="language-bash">$ yarn add apollo-client apollo-cache-inmemory apollo-link-http apollo-link-error apollo-link graphql graphql-tag react-apollo
</code></pre>

<p>æ¥çœ‹ä¸‹æ‰€å®‰è£…çš„ä¸€äº›åº“ï¼š</p>

<ul>
  <li>æˆ‘ä»¬ä½¿ç”¨<code>graphql-tag</code>æ„å»ºç¬¬ä¸€ä¸ª queryã€‚</li>
  <li><code>apollo-client</code>æ˜¯ä¸€ä¸ªé€šç”¨çš„ã€ä¸æ¡†æ¶æ— å…³çš„åº“ï¼Œæ¥æ‰§è¡Œå¹¶ç¼“å­˜ GraphQL è¯·æ±‚ã€‚</li>
  <li><code>apollo-cache-inmemory</code>æ˜¯ä¸€ä¸ª Apollo ç¼“å­˜çš„å­˜å‚¨å®ç°ã€‚</li>
  <li><code>react-apollo</code>åŒ…å«ä¸€å¥— React ç»„ä»¶æ¥å±•ç¤ºæ•°æ®ã€‚</li>
  <li><code>apollo-link</code>ä¸å…¶ä»– <em>links</em> ç»™<code>apollo-client</code>çš„æ“ä½œï¼ˆä½ å¯ä»¥åœ¨<a href="https://www.apollographql.com/docs/link/overview.html">è¿™é‡Œ</a>æ‰¾åˆ°æ›´å¤šç»†èŠ‚ï¼‰å®ç°äº†ä¸€ä¸ªä¸­é—´ä»¶æ¨¡å¼ã€‚</li>
</ul>

<p>ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸ºå‰ç«¯åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªå…¥å£ã€‚ä»<code>packs</code>ç›®å½•ç§»é™¤<code>hello_react.jsx</code>å¹¶æ·»åŠ <code>index.js</code>ï¼š</p>

<pre><code class="language-ruby">$ rm app/javascript/packs/hello_react.jsx &amp;&amp; touch app/javascript/packs/index.js
</code></pre>

<p>ä¸ºäº†è°ƒè¯•ç›®çš„ï¼ŒåŠ å…¥å¦‚ä¸‹å†…å®¹ï¼š</p>

<pre><code class="language-js">// app/javascript/packs/index.js
console.log('ğŸ‘»');
</code></pre>

<p>ç”Ÿæˆä¸€ä¸ªç”¨äºå‰ç«¯çš„ controllerï¼š</p>

<pre><code class="language-bash">$ rails g controller Library index --skip-routes
</code></pre>

<p>æ›´æ–°<code>app/views/library/index.html.erb</code>ä»¥åŒ…å« React æ ¹å…ƒç´ åŠä¸€ä¸ªåˆ° <em>pack</em> çš„<code>javascript_pack_tag</code>ï¼š</p>

<pre><code class="language-erb">&lt;!-- app/views/library/index.html.erb --&gt;
&lt;div id="root" /&gt;
&lt;%= javascript_pack_tag 'index' %&gt;
</code></pre>

<p>æœ€åï¼Œåœ¨<code>config/routes.rb</code>æ³¨å†Œä¸€ä¸ªæ–°çš„è·¯ç”±ï¼š</p>

<pre><code class="language-ruby"># config/routes.rb
root 'library#index'
</code></pre>

<p>é‡å¯ Rails serverï¼Œç¡®è®¤çœ‹åˆ°é‚£ä¸ª ğŸ‘» å‡ºç°åœ¨æµè§ˆå™¨çš„ console ä¸­ã€‚</p>

<h2 id="configuring-apollo">Configuring Apollo</h2>

<p>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ¥å­˜å‚¨ Apollo çš„é…ç½®ï¼š</p>

<pre><code class="language-bash">$ mkdir -p app/javascript/utils &amp;&amp; touch app/javascript/utils/apollo.js
</code></pre>

<p>è¯¥æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦é…ç½® Apollo åº”ç”¨çš„ä¸¤ä¸ªæ ¸å¿ƒä¸œè¥¿ï¼Œå®¢æˆ·ç«¯å’Œç¼“å­˜ï¼ˆæˆ–æ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯åˆ›å»ºäºŒè€…çš„å‡½æ•°ï¼‰ï¼š</p>

<pre><code class="language-js">// app/javascript/utils/apollo.js

// client
import { ApolloClient } from 'apollo-client';
// cache
import { InMemoryCache } from 'apollo-cache-inmemory';
// links
import { HttpLink } from 'apollo-link-http';
import { onError } from 'apollo-link-error';
import { ApolloLink, Observable } from 'apollo-link';
export const createCache = () =&gt; {
  const cache = new InMemoryCache();
  if (process.env.NODE_ENV === 'development') {
    window.secretVariableToStoreCache = cache;
  }
  return cache;
};
</code></pre>

<p>è®©æˆ‘ä»¬èŠ±ä¸€ç‚¹æ—¶é—´æ¥çœ‹çœ‹ç¼“å­˜æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>

<p>æ¯ä¸ª query å“åº”ç»“æœéƒ½è¢«æ”¾åˆ°ç¼“å­˜ä¸­ï¼ˆç›¸åº”çš„è¯·æ±‚é€šå¸¸è¢«ç”¨åšç¼“å­˜çš„ keyï¼‰ã€‚åœ¨è¿›è¡Œè¯·æ±‚ä¹‹å‰ï¼Œ<code>apollo-client</code>ç¡®ä¿å“åº”ç»“æœè¿˜æœªè¢«ç¼“å­˜ï¼Œè€Œå¦‚æœå…¶å·²è¢«ç¼“å­˜â€”â€”è¯·æ±‚å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚è¯¥è¡Œä¸ºæ˜¯å¯é…ç½®åŒ–çš„ï¼šæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæŸä¸€ä¸ªç‰¹åˆ«è¯·æ±‚å…³é—­ç¼“å­˜ï¼Œæˆ–è€…è®©å®¢æˆ·ç«¯æŸ¥æ‰¾ä¸€ä¸ªä¸åŒçš„ query çš„ç¼“å­˜æ•°æ®ã€‚</p>

<p>å…³äºç¼“å­˜æœºåˆ¶ï¼Œå¯¹æœ¬æ•™ç¨‹è€Œè¨€ï¼Œä¸€ä¸ªæˆ‘ä»¬éœ€è¦äº†è§£çš„é‡è¦äº‹æƒ…æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç¼“å­˜çš„ key æ˜¯<code>id</code>å’Œ<code>__typename</code>çš„ç»„åˆä¸²ã€‚å› æ­¤ï¼Œè·å–åŒæ ·å¯¹è±¡ä¸¤æ¬¡ä¹Ÿåªä¼šå¯¼è‡´ä¸€ä¸ªè¯·æ±‚ã€‚</p>

<p>å›åˆ°ä»£ç ä¸Šæ¥ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨ HTTP POST ä½œä¸ºä¼ è¾“ï¼Œæ‰€ä»¥éœ€è¦é™„å¸¦ä¸€ä¸ªé€‚å½“çš„ CSRF token åˆ°æ¯ä¸ªè¯·æ±‚ä¸Šä»¥é€šè¿‡ Rails ä¸­çš„ <a href="https://guides.rubyonrails.org/security.html#cross-site-request-forgery-csrf">forgery protection check</a>ã€‚æˆ‘ä»¬å¯ä»¥ä»<code>meta[name="csrf-token"]</code>æ‹¿åˆ°å®ƒï¼ˆå…¶æ˜¯é€šè¿‡<code>&lt;%= csrf_meta_tags %&gt;</code>ç”Ÿæˆçš„ï¼‰ï¼š</p>

<pre><code class="language-js">// app/javascript/utils/apollo.js
// ...
// getToken from meta tags
const getToken = () =&gt;
  document.querySelector('meta[name="csrf-token"]').getAttribute('content');
const token = getToken();
const setTokenForOperation = async operation =&gt;
  operation.setContext({
    headers: {
      'X-CSRF-Token': token,
    },
  });
// link with token
const createLinkWithToken = () =&gt;
  new ApolloLink(
    (operation, forward) =&gt;
      new Observable(observer =&gt; {
        let handle;
        Promise.resolve(operation)
          .then(setTokenForOperation)
          .then(() =&gt; {
            handle = forward(operation).subscribe({
              next: observer.next.bind(observer),
              error: observer.error.bind(observer),
              complete: observer.complete.bind(observer),
            });
          })
          .catch(observer.error.bind(observer));
        return () =&gt; {
          if (handle) handle.unsubscribe();
        };
      })
  );
</code></pre>

<p>æ¥çœ‹ä¸‹æˆ‘ä»¬å¦‚ä½•è®°å½•é”™è¯¯æ—¥å¿—ï¼š</p>

<pre><code class="language-js">// app/javascript/utils/apollo.js
//...
// log erors
const logError = (error) =&gt; console.error(error);
// create error link
const createErrorLink = () =&gt; onError(({ graphQLErrors, networkError, operation }) =&gt; {
  if (graphQLErrors) {
    logError('GraphQL - Error', {
      errors: graphQLErrors,
      operationName: operation.operationName,
      variables: operation.variables,
    });
  }
  if (networkError) {
    logError('GraphQL - NetworkError', networkError);
  }
})
</code></pre>

<p>ç”Ÿäº§ç¯å¢ƒä¸Šï¼Œæ›´å¥½çš„åšæ³•æ˜¯ä½¿ç”¨å¼‚å¸¸è¿½è¸ªæœåŠ¡ï¼ˆexception tracking serviceï¼‰ï¼ˆæ¯”å¦‚ï¼ŒSentry æˆ–è€… Honeybadgerï¼‰ï¼šåªç”¨è¦†ç›–<code>logError</code>å‡½æ•°æŠŠé”™è¯¯å‘é€åˆ°å¤–éƒ¨ç³»ç»Ÿå³å¯ã€‚</p>

<p>æ›™å…‰åœ¨å‰äº†â€”â€”è®©æˆ‘ä»¬æŠŠå…¥å£å‘ŠçŸ¥å®¢æˆ·ç«¯ä»¥è¿›è¡ŒæŸ¥è¯¢ï¼š</p>

<pre><code class="language-js">// app/javascript/utils/apollo.js
//...
// http link
const createHttpLink = () =&gt; new HttpLink({
  uri: '/graphql',
  credentials: 'include',
})
</code></pre>

<p>æœ€åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»º Apollo å®¢æˆ·ç«¯çš„å®ä¾‹äº†ï¼š</p>

<pre><code class="language-js">// app/javascript/utils/apollo.js
//...
export const createClient = (cache, requestLink) =&gt; {
  return new ApolloClient({
    link: ApolloLink.from([
      createErrorLink(),
      createLinkWithToken(),
      createHttpLink(),
    ]),
    cache,
  });
};
</code></pre>

<h2 id="the-very-first-query">The very first query</h2>

<p>æˆ‘ä»¬å°†ä½¿ç”¨<a href="https://reactjs.org/docs/context.html#contextprovider">provider pattern</a>æ¥æŠŠå®¢æˆ·ç«¯å®ä¾‹ä¼ ç»™ React ç»„ä»¶ï¼š</p>

<pre><code class="language-bash">$ mkdir -p app/javascript/components/Provider &amp;&amp; touch app/javascript/components/Provider/index.js
</code></pre>

<p>è¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡ä½¿ç”¨<code>react-apollo</code>çš„<code>ApolloProvider</code>ç»„ä»¶ï¼š</p>

<pre><code class="language-js">// app/javascript/components/Provider/index.js
import React from 'react';
import { ApolloProvider } from 'react-apollo';
import { createCache, createClient } from '../../utils/apollo';

export default ({ children }) =&gt; (
  &lt;ApolloProvider client={createClient(createCache())}&gt;
    {children}
  &lt;/ApolloProvider&gt;
);
</code></pre>

<p>ä¿®æ”¹<code>index.js</code>ä»¥ä½¿ç”¨æ–°åˆ›å»ºçš„ providerï¼š</p>

<pre><code class="language-js">// app/javascript/packs/index.js
import React from 'react';
import { render } from 'react-dom';
import Provider from '../components/Provider';

render(&lt;Provider&gt;ğŸ‘»&lt;/Provider&gt;, document.querySelector('#root'));
</code></pre>

<p>å¦‚æœä½ ä½¿ç”¨äº†<code>Webpacker v3</code>ï¼Œåˆ™éœ€è¦å¯¼å…¥<code>babel-polyfill</code>ä»¥ç”¨ä¸Šè¯¸å¦‚ <code>async/await</code>ç­‰å¾ˆé…·çš„ JavaScript ç‰¹æ€§ã€‚ä¸ç”¨æ‹…å¿ƒ polyfill çš„å¤§å°ã€‚<code>babel-preset-env</code>ä¼šå¸®ä½ ç§»é™¤æ‰æ‰€ä¸éœ€è¦çš„ä¸€èµ·ã€‚</p>

<p>æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª<code>Library</code>ç»„ä»¶ï¼Œåœ¨é¡µé¢ä¸Šå±•ç¤º items çš„åˆ—è¡¨ï¼š</p>

<pre><code class="language-bash">$ mkdir -p app/javascript/components/Library &amp;&amp; touch app/javascript/components/Library/index.js
</code></pre>

<p>æˆ‘ä»¬ä¼šä½¿ç”¨<code>react-apollo</code>çš„<code>Query</code>ç»„ä»¶ï¼Œæ¥æ”¶<code>query</code>å­—ç¬¦ä¸²ä½œä¸º property ä»¥è·å–æ‰€ mount çš„æ•°æ®ï¼š</p>

<pre><code class="language-js">// app/javascript/components/Library/index.js
import React from 'react';
import { Query } from 'react-apollo';
import gql from 'graphql-tag';

const LibraryQuery = gql`
  {
    items {
      id
      title
      user {
        email
      }
    }
  }
`;

export default () =&gt; (
  &lt;Query query={LibraryQuery}&gt;
    {({ data, loading }) =&gt; (
      &lt;div&gt;
        {loading
          ? 'loading...'
          : data.items.map(({ title, id, user }) =&gt; (
              &lt;div key={id}&gt;
                &lt;b&gt;{title}&lt;/b&gt; {user ? `added by ${user.email}` : null}
              &lt;/div&gt;
            ))}
      &lt;/div&gt;
    )}
  &lt;/Query&gt;
);
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›¸åº”çš„<code>loading</code>å’Œ<code>data</code> property åˆ†åˆ«è®¿é—®è½½å…¥çŠ¶æ€å’Œå·²åŠ è½½æ•°æ®ï¼ˆä½¿ç”¨æ‰€è°“çš„<a href="https://reactjs.org/docs/render-props.html">render-props æ¨¡å¼</a>ä¼ é€’ï¼‰ã€‚</p>

<p>åˆ«å¿˜äº†æŠŠç»„ä»¶æ·»åŠ åˆ°ä¸»é¡µé¢ä¸Šï¼š</p>

<pre><code class="language-js">// app/javascript/packs/index.js
import React from 'react';
import { render } from 'react-dom';
import Provider from '../components/Provider';
import Library from '../components/Library';

render(
  &lt;Provider&gt;
    &lt;Library /&gt;
  &lt;/Provider&gt;,
  document.querySelector('#root')
);
</code></pre>

<p>å¦‚æœä½ åˆ·æ–°é¡µé¢ï¼Œå°†ä¼šçœ‹åˆ° items åˆ—è¡¨ï¼Œä»¥åŠæ·»åŠ å®ƒä»¬çš„ç”¨æˆ·çš„ emailï¼š</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/items-b791b9f.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/items-b791b9f.png" /></p>

<p>ç¥è´ºä½ ï¼ä½ åˆšåˆšè¿ˆå‡ºäº†é€šå‘ GraphQL çš„ç¬¬ä¸€æ­¥ã€‚å¾ˆæ£’ï¼</p>

<h2 id="and-the-very-first-problem">â€¦And the very first problem</h2>

<p>ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å·¥ä½œå¾—å¾ˆå¥½ï¼Œä½†æ¥çœ‹ä¸€çœ¼æˆ‘ä»¬çš„æœåŠ¡ç«¯æ—¥å¿—ï¼š</p>

<p><img src="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/n_plus_one-77d1121.png" alt="https://cdn.evilmartians.com/front/posts/graphql-on-rails-1-from-zero-to-the-first-query/n_plus_one-77d1121.png" /></p>

<p>SQL æŸ¥è¯¢<code>SELECT * FROM users WHERE id = ?</code>è¢«æ‰§è¡Œäº†å››æ¬¡ï¼Œæ„å‘³ç€æˆ‘ä»¬æ’ä¸Šäº†è‘—åçš„ <em>N+1</em> é—®é¢˜â€”â€”æœåŠ¡ç«¯å¯¹é›†åˆä¸­çš„æ¯ä¸ª item éƒ½è¿›è¡Œäº†ä¸€æ¬¡æŸ¥è¯¢ï¼Œä»¥è·å–ç›¸åº”çš„ç”¨æˆ·ä¿¡æ¯ã€‚</p>

<p>åœ¨ä¿®å¤è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿è¿›è¡Œä»£ç è°ƒæ•´æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šæåä»»ä½•ä¸œè¥¿â€”â€”æ‰€ä»¥ï¼Œæ¥å†™æµ‹è¯•å§ï¼Œå°‘å¹´ï¼</p>

<h2 id="writing-some-specs">Writing some specs</h2>

<p>ç°åœ¨è¯¥æ¥å®‰è£…é…ç½® RSpec äº†ï¼Œæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯<code>rspec-rails</code> gemï¼š</p>

<pre><code class="language-bash"># Add gem to the Gemfile
$ bundle add rspec-rails --version="4.0.0.beta2" --group="development,test"
# Generate the initial configuration
$ rails generate rspec:install
</code></pre>

<p>ä¸ºäº†æ˜“äºç”Ÿæˆæµ‹è¯•æ•°æ®ï¼Œä¹Ÿå®‰è£…ä¸Š <a href="https://github.com/thoughtbot/factory_bot">factory_bot</a>ï¼š</p>

<pre><code class="language-bash">$ bundle add factory_bot_rails --version="~&gt; 5.0" --group="development,test"
</code></pre>

<p>ä¸ºäº†è®© factory æ–¹æ³•ï¼ˆ<code>create</code>ï¼Œ<code>build</code>ç­‰ï¼‰åœ¨æµ‹è¯•ä¸­å…¨å±€å¯è§ï¼Œæ·»åŠ <code>config.include FactoryBot::Syntax::Methods</code>åˆ°<code>rails_helper.rb</code>ä¸­ã€‚</p>

<p>ç”±äºæˆ‘ä»¬åœ¨æ·»åŠ  Factory Bot ä¹‹å‰å°±åˆ›å»ºäº† modelï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—æ‰‹åŠ¨ç”Ÿæˆ factoryã€‚å•ç‹¬åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œ<code>spec/factories.rb</code>ï¼Œå¦‚ä¸‹ï¼š</p>

<pre><code class="language-ruby"># spec/factories.rb
FactoryBot.define do
  factory :user do
    # Use sequence to make sure that the value is unique
    sequence(:email) { |n| "user-#{n}@example.com" }
  end

  factory :item do
    sequence(:title) { |n| "item-#{n}" }
    user
  end
end
</code></pre>

<p>ç°åœ¨å·²ç»å‡†å¤‡å¥½å†™æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµ‹è¯•äº†ã€‚æ¥ä¸º<code>QueryType</code>åˆ›å»ºä¸€ä¸ª spec æ–‡ä»¶ï¼š</p>

<pre><code class="language-bash">$ mkdir -p spec/graphql/types
$ touch spec/graphql/types/query_type_spec.rb
</code></pre>

<p>æœ€ç®€å•çš„ query æµ‹è¯•ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š</p>

<pre><code class="language-ruby"># spec/graphql/types/query_type_spec.rb
require "rails_helper"

RSpec.describe Types::QueryType do
  describe "items" do
    let!(:items) { create_pair(:item) }

    let(:query) do
      %(query {
        items {
          title
        }
      })
    end

    subject(:result) do
      MartianLibrarySchema.execute(query).as_json
    end

    it "returns all items" do
      expect(result.dig("data", "items")).to match_array(
        items.map { |item| { "title" =&gt; item.title } }
      )
    end
  end
end
</code></pre>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºåœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€å¯¹ itemsã€‚ç„¶åï¼Œå®šä¹‰äº†è¦è¢«æµ‹è¯•çš„ query å’Œsubjectï¼ˆ<code>result</code>ï¼‰ï¼Œåè€…é€šè¿‡è°ƒç”¨<code>MartianLibrarySchema.execute</code>æ–¹æ³•æ‰€å¾—åˆ°ã€‚è¿˜è®°å¾—æˆ‘ä»¬åœ¨<code>GraphqlController#execute</code>é‚£é‡Œæœ‰ä¸€è¡Œç±»ä¼¼çš„ä»£ç å—ï¼Ÿ</p>

<p>è¿™ä¸ªç”¨ä¾‹éå¸¸ç®€å•ï¼šæˆ‘ä»¬å¯¹<code>execute</code>çš„è°ƒç”¨æ—¢æ²¡æœ‰ä¼ é€’<code>variables</code>ä¹Ÿæ²¡æœ‰ä¼ é€’<code>context</code>ï¼Œå½“ç„¶ï¼Œæœ‰éœ€è¦çš„æ—¶å€™æˆ‘ä»¬æ˜¾ç„¶å¯ä»¥è¿™ä¹ˆåšã€‚</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±æœ‰è¶³å¤Ÿè‡ªä¿¡æ¥ä¿®å¤ä¸Šé¢çš„ N+1 é—®é¢˜äº†ï¼</p>

<h2 id="graphql-vs-n1-problem">GraphQL vs. N+1 problem</h2>

<p>æœ€ç®€å•çš„é¿å… N+1 é—®é¢˜çš„æ–¹å¼æ˜¯ä½¿ç”¨ <a href="https://guides.rubyonrails.org/active_record_querying.html#eager-loading-associations">eager loading</a>ã€‚æˆ‘ä»¬è¿™é‡Œï¼Œéœ€è¦åœ¨è¿›è¡ŒæŸ¥è¯¢ä»¥è·å–<code>QueryType</code>ä¸­çš„ items æ—¶é¢„åŠ è½½ç”¨æˆ·ï¼š</p>

<pre><code class="language-ruby"># /app/graphql/types/query_type.rb
module Types
  class QueryType &lt; Types::BaseObject
    # ...

    def items
      Item.preload(:user)
    end
  end
end
</code></pre>

<p>è¿™ä¸ªæ–¹æ¡ˆåœ¨ç®€å•çš„åœºæ™¯ä¸‹æ˜¯æœ‰ç”¨çš„ï¼Œä½†å¹¶éååˆ†é«˜æ•ˆï¼šæ¯”å¦‚ï¼Œå¦‚ä¸‹ä»£ç ä¹Ÿä¼šé¢„åŠ è½½ç”¨æˆ·ï¼Œå³ä½¿å®¢æˆ·ç«¯ä¸éœ€è¦å®ƒä»¬æ—¶ï¼š</p>

<pre><code class="language-graphql">items {
  title
}
</code></pre>

<p>è¦è®¨è®ºè§£å†³ N+1 é—®é¢˜çš„å…¶ä»–æ–¹å¼ï¼Œå€¼å¾—å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ï¼Œå·²ç»è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒç•´ã€‚</p>

<p>å¤§å¤šæ•°è§£å†³æ–¹æ¡ˆéƒ½ä¸å¤–ä¹ä»¥ä¸‹ä¸¤ç§ï¼š</p>

<ul>
  <li>lazy eager loadingï¼ˆæ¯”å¦‚ï¼Œä½¿ç”¨ <a href="https://github.com/DmitryTsepelev/ar_lazy_preload">ar_lazy_preload</a> gemï¼‰</li>
  <li>batch loadingï¼ˆæ¯”å¦‚ï¼Œä½¿ç”¨ <a href="https://github.com/Shopify/graphql-batch">graphql-batch</a> gemï¼‰</li>
</ul>

<p>æœ¬æ–‡å°±åˆ°è¿™å„¿äº†ï¼æˆ‘ä»¬å­¦ä¹ äº†å…³äº GraphQL çš„å¾ˆå¤šä¸œè¥¿ï¼Œå®Œæˆäº†é…ç½®åç«¯å’Œå‰ç«¯åº”ç”¨ç¨‹åºçš„å¸¸è§„å·¥ä½œï¼Œè¿›è¡Œäº†ç¬¬ä¸€ä¸ªæŸ¥è¯¢ï¼Œç”šè‡³è¿˜å‘ç°å¹¶ä¿®å¤äº†ç¬¬ä¸€ä¸ª bugã€‚è€Œè¿™åªæ˜¯æˆ‘ä»¬æ—…ç¨‹ä¸­å¾®å°çš„ä¸€æ­¥ï¼ˆå°½ç®¡æ–‡ç« çš„ç¯‡å¹…å¹¶ä¸å¾®å°ï¼‰ã€‚æˆ‘ä»¬ä¼šå¾ˆå¿«å›æ¥çš„ï¼Œå±Šæ—¶å°†æ¨å‡ºå¦‚ä½•ä½¿ç”¨ GraphQL çš„ mutation æ¥æ“ä½œæ•°æ®ï¼Œä»¥åŠ subscription æ¥ä½¿æ•°æ®ä¿æŒæœ€æ–°çš„å†…å®¹ã€‚æ•¬è¯·å…³æ³¨ï¼</p>


</div>

<!-- Rating -->

<div class="rating mt-4 mb-4 d-flex align-items-center">
    <strong class="mr-1">Rating:</strong> <div class="rating-holder">
<div class="c-rating c-rating--regular" data-rating-value="4">
  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>4</button>
  <button>5</button>
</div>
</div>
</div>


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->


<div class="d-flex authorbox align-items-center">
    <div class="col-md-2 mr-4 text-center">
        
        <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
        
    </div>
    <div class="col-md-10"> 
        <a target="_blank" class="text-dark h4" href="https://xfyuan.github.io">About Mr.Z</a>   <a target="_blank" href="https://twitter.com/apexy" class="btn-sm"><i class="fab fa-twitter"></i></a>        
        <span class="author-description d-block mt-2">A Chinese software engineer living and working in Chengdu. I love Creating the future in digital worlds, big and small.</span>            
    </div>
</div>



<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments">
    <button class="btn btn-dark show-comments">Load Comments</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'xfyuan'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       


<!-- Share -->
<div class="share">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=GraphQL on Railsâ€”â€”å¯ç¨‹&url=/2020/11/graphql-on-rails-series-1/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=/2020/11/graphql-on-rails-series-1/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=/2020/11/graphql-on-rails-series-1/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Explore more like this</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">
    
    <!-- Categories -->
    
    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/categories#Programming">Programming</a>                
    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/categories#Translation">Translation</a>                
    

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#graphql">graphql</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#rails">rails</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#ruby">ruby</a>               
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/04/hotwire-reactive-rails-with-no-javascript/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_121324.jpg" alt="Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/04/hotwire-reactive-rails-with-no-javascript/">Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails</a>
                
                <div class="mb-2 mt-2 font-weight-normal">
                <div class="rating-holder">
<div class="c-rating c-rating--regular" data-rating-value="5">
  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>4</button>
  <button>5</button>
</div>
</div>
                </div>
                
            </h2>
            <h4 class="card-text">æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆVladimir Dementyevï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡ä»‹ç»äº† Rails çš„æœ€æ–°â€œé­”æ³•â€ï¼šHotwireã€‚è¿™ä¹Ÿæ˜¯ Vladimir Dementyev åœ¨ RailsConf 2021 ä¸Šçš„æ¼”è®²å†…å®¹ã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">24 Apr 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/04/the-foundation-of-how-tailwindcss-works/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_115551.jpg" alt="Tailwindcssåº•å±‚åŸºçŸ³çš„ç†å¿µ">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/04/the-foundation-of-how-tailwindcss-works/">Tailwindcssåº•å±‚åŸºçŸ³çš„ç†å¿µ</a>
                
            </h2>
            <h4 class="card-text">Tailwindcss ä» 2019 å¹´å¼€å§‹é€æ¸åœ¨å›½å¤–çš„ Web å¼€å‘åœˆå­å†…ç››è¡Œèµ·æ¥ã€‚å›½å†…å€’æ˜¯è‡³ä»Šä»ç„¶ä¸æ¸©ä¸ç«ã€‚2020 å¹´çš„ Ruby China ä¸Šè¿‡çº¯ä¸­åšè¿‡ä¸€æ¬¡åœ¨é¡¹ç›®ä¸Šä½¿ç”¨ tailwindcss ä½“éªŒçš„æœ‰å…³æ¼”è®²ã€‚æˆ‘åœ¨ 2020 å¹´ä¹Ÿå†™è¿‡ä¸€ç¯‡æœ‰å…³çš„åšå®¢â€œåœ¨ Rails 6 ä¸­æ•´åˆ Stimulus å’Œ Tailwind CSSâ€ï¼ˆè¢«å‰è€…åœ¨æ¼”è®²ä¸­æ‰€å¼•ç”¨^_^ï¼‰ã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">10 Apr 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/03/hotwire-build-turbo-application/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_133340.jpg" alt="Hotwireä¹‹æ„å»ºTurboåº”ç”¨">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/03/hotwire-build-turbo-application/">Hotwireä¹‹æ„å»ºTurboåº”ç”¨</a>
                
            </h2>
            <h4 class="card-text">æœ¬æ–‡æ˜¯å¯¹æ„å»º Turbo åº”ç”¨çš„å…·ä½“æè¿°ï¼ŒåŸæ–‡å‡ºè‡ªï¼šhttps://turbo.hotwire.dev/handbook/buildingã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">26 Mar 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
                
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

    <script type="application/ld+json">
    {
    "@context": "http://schema.org/",
    "@type": "Review",
    "itemReviewed": {
    "@type": "Thing",
    "name": "GraphQL on Railsâ€”â€”å¯ç¨‹"
    },
    "author": {
    "@type": "Person",
    "name": "Mr.Z"
    },
    "datePublished": "2020-11-12",
    "reviewRating": {
    "@type": "Rating",
    "ratingValue": "4",
    "bestRating": "5"
    }
    }
    </script>

    </div>

    

</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center text-lg-left">
                Copyright Â© 2021 The Tragedy of XY
            </div>
            <div class="col-md-6 col-sm-12 text-center text-lg-right">
                <a target="_blank" href="https://www.wowthemes.net/memoirs-free-jekyll-theme/">Memoirs Jekyll Theme</a>
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

<script src="/assets/js/prism.js"></script>

<script src="/assets/js/theme.js"></script>


<script src="/assets/js/lazyload.js"></script>



<script id="dsq-count-scr" src="//xfyuan.disqus.com/count.js"></script>


</body>
</html>
