<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails | The Tragedy of XY</title>

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails | The Tragedy of XY</title>
<meta name="generator" content="Jekyll v4.1.0" />
<meta property="og:title" content="Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails" />
<meta name="author" content="Mr.Z" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆVladimir Dementyevï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡ä»‹ç»äº† Rails çš„æœ€æ–°â€œé­”æ³•â€ï¼šHotwireã€‚è¿™ä¹Ÿæ˜¯ Vladimir Dementyev åœ¨ RailsConf 2021 ä¸Šçš„æ¼”è®²å†…å®¹ã€‚" />
<meta property="og:description" content="æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆVladimir Dementyevï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡ä»‹ç»äº† Rails çš„æœ€æ–°â€œé­”æ³•â€ï¼šHotwireã€‚è¿™ä¹Ÿæ˜¯ Vladimir Dementyev åœ¨ RailsConf 2021 ä¸Šçš„æ¼”è®²å†…å®¹ã€‚" />
<meta property="og:site_name" content="The Tragedy of XY" />
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_121324.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-24T00:00:00+00:00" />
<script type="application/ld+json">
{"dateModified":"2021-04-24T00:00:00+00:00","datePublished":"2021-04-24T00:00:00+00:00","description":"æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆVladimir Dementyevï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡ä»‹ç»äº† Rails çš„æœ€æ–°â€œé­”æ³•â€ï¼šHotwireã€‚è¿™ä¹Ÿæ˜¯ Vladimir Dementyev åœ¨ RailsConf 2021 ä¸Šçš„æ¼”è®²å†…å®¹ã€‚","url":"/2021/04/hotwire-reactive-rails-with-no-javascript/","@type":"BlogPosting","image":"https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_121324.jpg","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"},"name":"Mr.Z"},"mainEntityOfPage":{"@type":"WebPage","@id":"/2021/04/hotwire-reactive-rails-with-no-javascript/"},"author":{"@type":"Person","name":"Mr.Z"},"headline":"Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link href="/assets/css/prism.css" rel="stylesheet">

<link href="/assets/css/theme.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body>
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>

<!-- Begin Sidebar Navigation
================================================== -->

<div class="sidebar">
</div>
<div class="nav-icon">
    <div class="hamburger-bar"></div>
</div>
<div id="blackover-nav" class="blackover"></div>
<nav id="menu">
    <ul>
        <h3>Navigation</h3>
        <li><a href="/">Home</a></li>
        <li><a href="/categories">Categories</a></li>
        <li><a href="/about">About</a></li>
    </ul>
</nav>

<script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>


<!-- End Sidebar Navigation
================================================== -->

<div class="site-content ">

<div class="container">

    <!-- Site Logo/Name
    ================================================== -->

    <a class="navbar-brand" href="/">
        <img src="/assets/images/logo.png" alt="The Tragedy of XY">
    </a>


    <!-- Site Tag
    ================================================== -->
    

    <!-- Content
    ================================================== -->
    <div class="main-content">
        <div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
            
        </div>            
        <div>
        Written by <a target="_blank" class="text-dark" href="https://xfyuan.github.io">Mr.Z</a> on 
        <span class="post-date"><time class="post-date" datetime="2021-04-24">24 Apr 2021</time></span>           
        
        </div>            
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image lazyimg " src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_121324.jpg" alt="Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails">
    
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <p><em>æœ¬æ–‡å·²è·å¾—åŸä½œè€…ï¼ˆVladimir Dementyevï¼‰å’Œ Evil Martians æˆæƒè®¸å¯è¿›è¡Œç¿»è¯‘ã€‚åŸæ–‡ä»‹ç»äº† Rails çš„æœ€æ–°â€œé­”æ³•â€ï¼š<strong>Hotwire</strong>ã€‚è¿™ä¹Ÿæ˜¯ Vladimir Dementyev åœ¨ RailsConf 2021 ä¸Šçš„æ¼”è®²å†…å®¹ã€‚</em></p>

<ul>
  <li>åŸæ–‡é“¾æ¥ï¼š<a href="https://evilmartians.com/chronicles/hotwire-reactive-rails-with-no-javascript">Hotwire: Reactive Rails with no JavaScript?</a></li>
  <li>ä½œè€…ï¼š<a href="https://twitter.com/palkan_tula">Vladimir Dementyev</a></li>
  <li>ç«™ç‚¹ï¼šEvil Martians â€”â€”ä½äºçº½çº¦å’Œä¿„ç½—æ–¯çš„ Ruby on Rails å¼€å‘äººå‘˜åšå®¢ã€‚ å®ƒå‘å¸ƒäº†è®¸å¤šä¼˜ç§€çš„æ–‡ç« ï¼Œå¹¶ä¸”æ˜¯ä¸å°‘ gem çš„èµåŠ©å•†ã€‚</li>
</ul>

<p><em>ã€æ­£æ–‡å¦‚ä¸‹ã€‘</em></p>

<h2 id="å¼•è¨€">å¼•è¨€</h2>

<p>åˆ°ä¼ æ’­ DHH åŠå…¶å…¬å¸ä¹…ç»è€ƒéªŒçš„<a href="https://twitter.com/dhh/status/1275901955995385856">æ–°é­”æ³•</a>çš„æ—¶å€™äº†ï¼Œå¹¶ä¸”åœ¨è¶…è¿‡ 5 åˆ†é’Ÿçš„æ•™å­¦ä¸­å­¦ä¹ ä½¿ç”¨ <a href="https://hotwire.dev/">Hotwire</a>ã€‚è‡ªä»ä»Šå¹´æ­å¼€å…¶é¢çº±ä»¥æ¥ï¼Œè¿™ä¸ªç”¨äºæ„å»ºç°ä»£ Web ç•Œé¢è€Œä¼¼ä¹æ— éœ€ä»»ä½• JavaScript çš„æŠ€æœ¯çš„åå­—å°±å¤‡å—æ¬¢è¿ã€‚è¿™ä¸ª <strong>HTML-over-the-wire</strong> çš„æ–¹æ¡ˆæ­£åœ¨ Rails ä¸–ç•Œé‡Œæ¿€å‘èµ·å±‚å±‚æ¶Ÿæ¼ªï¼šä¸è®¡å…¶æ•°çš„åšå®¢æ–‡ç« ã€reddit ç¤¾åŒºå¸–å­ã€å½•å±è§†é¢‘ï¼Œä»¥åŠ<a href="https://railsconf.com/program">ä»Šå¹´ RailsConf çš„äº”ä¸ªæ¼”è®²</a>ï¼Œè€Œå…¶ä¸­ä¼šåŒ…å«ä½ æ‰€æœŸæœ›çš„å†…å®¹ã€‚æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³è¦å¯¹ Hotwire è¿›è¡Œå½»åº•åœ°è§£é‡Šâ€”â€”å€ŸåŠ©ä»£ç ç¤ºä¾‹å’Œæµ‹è¯•ç­–ç•¥ã€‚å°±åƒæˆ‘æœ€çˆ±çš„æ‘‡æ»šä¹é˜Ÿè¯´çš„é‚£æ ·ï¼Œè®©æˆ‘ä»¬ Hotwired æ¥â€¦â€¦<del>self destruct</del> å­¦ä¹ æ–°æŠ€å·§å§ï¼ã€è¯‘è€…æ³¨ï¼šæ‘‡æ»šä¹é˜Ÿ Metallica 2016 å¹´å‘è¡Œäº†ä¸“è¾‘ã€ŠHardwired â€¦ To Self-Destructã€‹ï¼Œä½œè€…åœ¨è¿™å„¿ä½¿ç”¨äº†åç§°çš„è°éŸ³ã€‘</p>

<h2 id="life-is-short">Life is short</h2>

<p><strong>è¦æ¦‚è§ˆ Hotwire åœ¨ Rails 6 ä¸­è¿›è¡Œä½¿ç”¨çš„å…¨è²Œï¼Œæ¯‹éœ€å†è´¹å…¶ä»–åŠŸå¤«ï¼Œçœ‹<a href="https://github.com/anycable/anycable_rails_demo/pull/16">è¿™ä¸ª PR</a> å°±è¶³å¤Ÿäº†ã€‚</strong></p>

<p>æ¥ä¸‹æ¥çš„æ–‡ç« ä¼šè§£é‡Šä¸Šè¿° PR ä»£ç â€”â€”åœ¨å¾ˆå¤šç»†èŠ‚ä¸Šã€‚å®ƒæ˜¯æˆ‘çš„ <a href="https://railsconf.com/">RailsConf 2021</a> æ¼”è®²ï¼š<a href="https://railsconf.com/program/sessions#session-1118">â€œFrontendless Rails frontendâ€</a> çš„ä¸€ä¸ªæ”¹ç¼–å’Œæ‰©å±•ç‰ˆæœ¬ï¼Œæ‰€æœ‰ RailsConf çš„å‚ä¼šè€…éƒ½å·²èƒ½å¤Ÿåœ¨çº¿è§‚çœ‹ã€‚å¦‚æœä½ æ²¡æœ‰å¤§ä¼šé—¨ç¥¨ä¹Ÿä¸ç”¨æ‹…å¿ƒï¼šå¯ä»¥åœ¨<a href="https://noti.st/palkan/eVl0xO/frontendless-rails-frontend">è¿™é‡Œ</a>çœ‹åˆ°å…¶ç®€æŠ¥ï¼Œè€Œä¸”è¯¥é¡µé¢ä¼šæ›´æ–°æ¼”è®²è§†é¢‘ï¼Œä¸€æ—¦æ¼”è®²å¯ä»¥å…¬å¼€å‘å¸ƒçš„è¯ã€‚</p>

<h2 id="this-is-the-way">â€œThis is the wayâ€</h2>

<p>è¿‡å»äº”å¹´ä¸­ï¼Œæˆ‘ä¸€ç›´ä¸»è¦åœ¨åšçº¯åç«¯çš„å¼€å‘ï¼šREST å’Œ GraphQL APIsã€WebSocketã€gRPCã€æ•°æ®åº“ã€ç¼“å­˜ç­‰ã€‚</p>

<p>æ•´ä¸ªå‰ç«¯çš„è¿›åŒ–åƒå·¨æµªä¸€æ ·å¸­å·äº†æˆ‘ï¼šæˆ‘ä»ç„¶ä¸ç†è§£ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ª Web åº”ç”¨éƒ½ä½¿ç”¨ <em>reacts</em> å’Œ <em>webpacks</em>ã€‚ä¼ ç»Ÿçš„ HTML-first çš„ <strong>Rails æ–¹å¼</strong> æ‰æ˜¯æˆ‘çš„æ–¹å¼ï¼ˆæˆ–è€…è¯´æ·å¾„ğŸ˜‰ï¼‰ã€‚è¿˜è®°å¾—é‚£äº› JavaScript åœ¨ä½ çš„åº”ç”¨ä¸­æ— éœ€ä»€ä¹ˆ MVCï¼ˆæˆ– MVVMï¼‰çš„æ—¥å­å—ï¼Ÿæˆ‘æ€€å¿µé‚£ç§æ—¥å­ã€‚è€Œè¿™äº›æ—¥å­æ­£åœ¨æ‚„æ‚„åœ°å·åœŸé‡æ¥ã€‚</p>

<p>ä»Šå¤©ï¼Œæˆ‘ä»¬ç›®ç¹äº† <em>HTML-over-the-wire</em> çš„å´›èµ·ï¼ˆæ˜¯çš„ï¼Œç°åœ¨å®ƒæ˜¯ä¸€ä¸ªå®é™…åè¯äº†ï¼‰ã€‚ç”± <a href="https://github.com/phoenixframework/phoenix_live_view">Phoenix LiveView</a> ç‡å…ˆæå‡ºï¼Œ<a href="https://stimulusreflex.com/">StimulusReflex</a> ç³»åˆ— gems å¯¹å…¶å‘æ‰¬å…‰å¤§ï¼Œè¿™ç§åŸºäºåç«¯é€šè¿‡ WebSocket æŠŠæ¸²æŸ“çš„æ¨¡æ¿æ¨é€åˆ°æ‰€æœ‰æ‰€è¿æ¥çš„å®¢æˆ·ç«¯çš„æ–¹æ¡ˆï¼Œåœ¨ Rails ç¤¾åŒºè·å¾—äº†æå¤§çš„å¸å¼•åŠ›ã€‚æœ€ç»ˆï¼ŒDHH æœ¬äººäºä»Šå¹´åˆæŠŠ <a href="https://hotwire.dev/">Hotwire</a> å‘ˆç°äºä¸–ç•Œé¢å‰ã€‚</p>

<p>æˆ‘ä»¬æ˜¯å¦æ­£ç«™åœ¨ Web å¼€å‘çš„å¦ä¸€ä¸ªå…¨çƒèŒƒå¼è½¬å˜çš„è¾¹ç¼˜ï¼Ÿå›åˆ°æœåŠ¡ç«¯æ¸²æŸ“æ¨¡æ¿çš„ç®€å•æ€ç»´æ¨¡å‹ï¼Œè¿™ä¸€æ¬¡èŠ±è´¹å¾ˆå°‘çš„ç²¾åŠ›å°±å¯å®ç°å„ç§èŠ±é‡Œèƒ¡å“¨çš„ååº”å¼ç•Œé¢å—ï¼Ÿç»å°½è„‘æ±åï¼Œæˆ‘è®¤è¯†åˆ°è¿™æ˜¯ä¸€å¢æƒ…æ„¿çš„æƒ³æ³•ï¼šæŠ€æœ¯é¢†åŸŸå·²ç»æœ‰å¤ªå¤šçš„æŠ•èµ„åœ¨å®¢æˆ·ç«¯æ¸²æŸ“çš„åº”ç”¨ä¸Šè€Œå¾ˆéš¾å›å¤´äº†ã€‚2020 æ—¶ä»£çš„å‰ç«¯å¼€å‘å·²ç»æ˜¯ä¸€ç§ç‹¬ç«‹çš„<strong>èµ„è´¨</strong>å’Œæœ‰å…¶è‡ªèº«éœ€æ±‚çš„ç‹¬ç«‹è¡Œä¸šï¼Œæˆ‘ä»¬å°†æ²¡åŠæ³•å†æˆä¸ºâ€œå…¨æ ˆâ€äº†ã€‚</p>

<p>ç„¶è€Œï¼ŒHOTWireï¼ˆçœ‹åˆ°é‚£ä¸ªé¦–å­—æ¯ç¼©å†™å—ï¼ŸBasecamp è¿™æ–¹é¢å¾ˆèªæ˜ï¼Œæ˜¯å§ï¼Ÿï¼‰ï¼Œä¸ºå¤æ‚çš„ï¼Œæˆ–è€…æˆ‘ä»¬åº”è¯¥è¯´â€œé”™ç»¼å¤æ‚çš„â€ï¼Œèˆªå¤©ç§‘å­¦ä¸€èˆ¬é’ˆå¯¹æµè§ˆå™¨çš„ç°ä»£å®¢æˆ·ç«¯ç¼–ç¨‹ï¼Œæä¾›äº†ä¸€ç§æ€¥éœ€çš„æ›¿ä»£æ–¹æ¡ˆã€‚</p>

<p><strong>å¯¹äºåŒå€¦äº†åªåš API åº”ç”¨è€Œæ— æ³•æŒæ§å…¶å‘ˆç°ï¼Œä»¥åŠæ€€å¿µåˆ›å»ºå“è¶Šç”¨æˆ·ä½“éªŒè€Œæ‘†è„±æ¯å‘¨ 40 å°æ—¶å……æ–¥ç€ SQL å’Œ JSON çš„ä¸€å Rails å¼€å‘è€…è€Œè¨€ï¼ŒHotwire å°±å¦‚ä»–æ‰€æ¸´æœ›èƒ½å¸¦æ¥æ–°é²œæ°”æ¯çš„å‘¼å¸ä¸€èˆ¬ï¼Œè®© Web å¼€å‘é‡æ‹¾ä¹è¶£ã€‚</strong></p>

<p>æœ¬æ–‡ä¸­ï¼Œæˆ‘ä¼šæ¼”ç¤ºå¦‚ä½•æŠŠ HTML-over-the-wire å“²å­¦é€šè¿‡ Hotwire ç”¨åˆ°ç°æœ‰çš„ Rails åº”ç”¨ä¸Šã€‚å°±åƒæˆ‘æœ€è¿‘çš„å¤§å¤šæ•°æ–‡ç« ä¸€æ ·ï¼Œæˆ‘ä¼šä½¿ç”¨ <a href="https://github.com/anycable/anycable_rails_demo">AnyCable demo åº”ç”¨</a>ä½œä¸ºå°ç™½é¼ ã€‚</p>

<p>è¿™ä¸ªåº”ç”¨å¾ˆåº”æ™¯ï¼šäº¤äº’å’Œååº”ï¼ŒTurbolinks é©±åŠ¨ï¼Œä»¥åŠå°‘é‡è‡ªå®šä¹‰ JavaScriptsï¼Œè¿˜æœ‰ç›¸å½“å¥½çš„ç³»ç»Ÿæµ‹è¯•è¦†ç›–ç‡ï¼ˆè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è¿›è¡Œå®‰å…¨åœ°é‡æ„ï¼‰ã€‚æˆ‘ä»¬çš„ <em>Hotwire åŒ–</em> å°†ä¼šæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡Œï¼š</p>

<ul>
  <li><a href="https://evilmartians.com/chronicles/hotwire-reactive-rails-with-no-javascript#from-turbolinks-to-turbo-drive">From Turbolinks to Turbo Drive</a></li>
  <li><a href="https://evilmartians.com/chronicles/hotwire-reactive-rails-with-no-javascript#framing-with-turbo-frames">Framing with Turbo Frames</a></li>
  <li><a href="https://evilmartians.com/chronicles/hotwire-reactive-rails-with-no-javascript#streaming-with-turbo-streams">Streaming with Turbo Streams</a></li>
  <li><a href="https://evilmartians.com/chronicles/hotwire-reactive-rails-with-no-javascript#beyond-turbo-or-using-stimulus-and-custom-elements">Beyond Turbo, or using Stimulus and custom elements</a></li>
</ul>

<h2 id="from-turbolinks-to-turbo-drive">From Turbolinks to Turbo Drive</h2>

<p><a href="https://github.com/turbolinks/turbolinks">Turbolinks</a> åœ¨ Rails ä¸–ç•Œé‡Œå¾ˆé•¿æ—¶é—´ä¹…è´Ÿç››åï¼›å…¶<a href="https://github.com/turbolinks/turbolinks-classic/commit/41dd321407f837d9705de9d893f2847537676904">ç¬¬ä¸€ä¸ªä¸»è¦ç‰ˆæœ¬</a>åœ¨ 2013 å¹´æ—©æœŸå‘å¸ƒã€‚ç„¶è€Œï¼Œåœ¨æˆ‘çš„å¼€å‘ç”Ÿæ¶¯åˆæœŸï¼ŒRails å¼€å‘è€…æœ‰ä¸€ä¸ªç»éªŒä¹‹è°ˆï¼š<em>å¦‚æœä½ çš„å‰ç«¯å‡ºæ¯›ç—…äº†ï¼Œå°è¯•ä¸€ä¸‹ç¦ç”¨Turbolinks</em>ã€‚è®©ç¬¬ä¸‰æ–¹ JS åº“çš„ä»£ç è·Ÿ Turbolinks çš„ä¼ªå¯¼èˆªï¼ˆå‚è€ƒï¼š<code>pushState</code> + AJAXï¼‰å…¼å®¹å¯ä¸åƒåœ¨å…¬å›­é‡Œæ•£æ­¥é‚£æ ·å®¹æ˜“ã€‚</p>

<p>å½“ <a href="https://stimulus.hotwire.dev/">StimulusJS</a> å‡ºæ¥ä»¥åï¼Œæˆ‘å°±ä¸å†èº²é¿ Turbolinks äº†ã€‚å®ƒé€šè¿‡ä¾é ç°ä»£çš„ <a href="https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver">DOM mutation APIs</a> è€Œä»æ ¹æœ¬ä¸Šè§£å†³äº†â€œè¿æ¥â€å’Œâ€œæ–­å¼€è¿æ¥â€ JavaScript çš„é—®é¢˜ã€‚Turbolinks ä¸ Stimulus çš„ä»£ç ç»„åˆï¼ŒDOM æ“ä½œä»…ä»¥ React-Angular å‡ åˆ†ä¹‹ä¸€çš„å¼€å‘æˆæœ¬å°±è½»è€Œæ˜“ä¸¾äº§ç”Ÿäº†â€œSPAâ€èˆ¬çš„ä½“éªŒã€‚</p>

<p>æ˜”æ—¥è¯¸èˆ¬å¥½å¤„çš„ Turbolinks ç°åœ¨æ›´åä¸º <em>Turbo Drive</em>ï¼Œå°±å¦‚å­—é¢ä¸Šé‚£æ ·å®ƒé©±åŠ¨äº† <a href="https://turbo.hotwire.dev/">Turbo</a> â€”â€” Hotwire åŒ…çš„æ ¸å¿ƒã€‚</p>

<p><strong>å¦‚æœä½ çš„åº”ç”¨å·²ç»ä½¿ç”¨äº† Turbolinksï¼ˆå¦‚æˆ‘ä¸€èˆ¬ï¼‰ï¼Œåˆ‡æ¢åˆ° Turbo Drive ä¸è´¹å¹ç°ä¹‹åŠ›ã€‚ä¸è¿‡æ˜¯ä¸€äº›é‡å‘½åçš„äº‹å„¿ç½¢äº†ã€‚</strong></p>

<p>æ‰€æœ‰ä½ éœ€è¦åšçš„å°±æ˜¯æŠŠ<code>package.json</code>ä¸­çš„<code>turbolinks</code>æ›¿æ¢ä¸º<code>@hotwired/turbo-rails</code>ï¼Œä»¥åŠæŠŠ<code>Gemfile</code>ä¸­çš„<code>turbolinks</code>æ›¿æ¢ä¸º<code>turbo-rails</code>ã€‚</p>

<p>åˆå§‹åŒ–ä»£ç ç¨æœ‰å·®å¼‚ï¼Œç°åœ¨çš„æ›´ç®€æ´äº†ï¼š</p>

<pre><code class="language-diff">- import Turbolinks from 'turbolinks';

- Turbolinks.start();
+ import "@hotwired/turbo"
</code></pre>

<p>æ³¨æ„ï¼Œæˆ‘ä»¬ç°åœ¨ä¸éœ€è¦æ‰‹åŠ¨å¯åŠ¨ Turbo Drive äº†ï¼ˆå½“ç„¶ä½ å¯ä»¥<a href="https://github.com/hotwired/turbo/issues/198">ä¸è¿™ä¹ˆåš</a>ï¼‰ã€‚</p>

<p>è¿˜æœ‰äº›â€œæŸ¥æ‰¾ &amp; æ›¿æ¢â€å·¥ä½œè¦åšï¼šæŠŠæ‰€æœ‰ HTML çš„ data å±æ€§çš„<code>data-turbolinks</code>æ›´æ–°ä¸º<code>data-turbo</code>ã€‚</p>

<p>è¿™äº›å˜æ›´ä¸­å”¯ä¸€èŠ±è´¹äº†æˆ‘ä¸€ç‚¹æ—¶é—´è€Œå€¼å¾—ä¸€æçš„æ˜¯å¤„ç† <strong>forms å’Œ redirects</strong>ã€‚ä¹‹å‰ä½¿ç”¨ Turbolinks æ—¶ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ remote formsï¼ˆ<code>remote: true</code>ï¼‰å’Œ <a href="https://github.com/turbolinks/turbolinks-rails/blob/master/lib/turbolinks/redirection.rb">Redirection concern</a> æ¥å“åº”ä»¥ JavaScript æ¨¡æ¿ã€‚Turbo Drive å·²ç»å†…ç½®äº†å¯¹è¡¨å•æ‹¦æˆªçš„æ”¯æŒï¼Œæ‰€ä»¥<code>remote: true</code>å°±ä¸å†éœ€è¦äº†ã€‚ç„¶è€Œï¼Œäº‹å®è¯æ˜ redirection ä»£ç å¿…é¡»è¿›è¡Œæ›´æ–°ï¼Œæˆ–è€…æ›´ç²¾ç¡®åœ°è¯´ï¼Œæ˜¯ redirection <strong>status code</strong>ï¼š</p>

<pre><code class="language-diff">- redirect_to workspace
+ redirect_to workspace, status: :see_other
</code></pre>

<p>ä½¿ç”¨æœ‰äº›æ™¦æ¶©çš„ <em>See Other</em> HTTP response code (303) æ˜¯ä¸€ä¸ªèªæ˜çš„é€‰æ‹©ï¼šå®ƒå…è®¸ Turbo ä¾èµ–åŸç”Ÿ Fetch API çš„ <code>redirect: "follow" </code> é€‰é¡¹ï¼Œè¿™æ ·åœ¨è¡¨å•æäº¤åä½ å°±ä¸å¿…æ˜ç¡®å‘èµ·å¦ä¸€ä¸ªè¯·æ±‚ä»¥è·å–æ–°å†…å®¹ã€‚æ ¹æ®<a href="https://fetch.spec.whatwg.org/#concept-http-redirect-fetch">å…¶è§„èŒƒ</a>ï¼Œâ€œ<em>if status is 303 and requestâ€™s method is not <code>GET</code> or <code>HEAD</code></em>â€ï¼ŒGET è¯·æ±‚å¿…é¡»è¢«è‡ªåŠ¨æ‰§è¡Œã€‚æŠŠè¿™ä¸ªè·Ÿ â€œ<em>if status is 301 or 302 and requestâ€™s method is <code>POST</code></em>â€ æ¯”è¾ƒä¸€ä¸‹â€”â€”çœ‹åˆ°åŒºåˆ«äº†å—ï¼Ÿ</p>

<p>å…¶ä»–çš„ 3xx çŠ¶æ€ä»…é€‚ç”¨äº POST è¯·æ±‚ï¼Œè€Œ Rails ä¸­æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ POST, PATCH, PUT, å’Œ DELETEã€‚</p>

<h2 id="framing-with-turbo-frames">Framing with Turbo Frames</h2>

<p>è¯¥æ¥çœ‹ä¸€äº›çœŸæ­£çš„æ–°ä¸œè¥¿äº†ï¼šTurbo Framesã€‚</p>

<p>Turbo Frames å¸¦æ¥äº†é¡µé¢åœ¨å±€éƒ¨ä¸Šçš„æ— ç¼æ›´æ–°ï¼ˆä¸åƒ Turbo Drive æ˜¯åœ¨æ•´ä¸ªé¡µé¢ä¸Šï¼‰ã€‚æˆ‘ä»¬å¯ä»¥è¯´å®ƒéå¸¸ç±»ä¼¼äº<code>&lt;iframe&gt;</code>æ‰€åšçš„ï¼Œä½†å´ä¸ç”¨åˆ›å»ºå•ç‹¬çš„ windowsã€DOM æ ‘ä»¥åŠä¸ä¹‹ä¿±æ¥çš„é‚£äº›å®‰å…¨å™©æ¢¦ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹å®é™…çš„ä¾‹å­ã€‚</p>

<p>AnyCable demo åº”ç”¨ï¼ˆç§°ä¸º <em>AnyWork</em>ï¼‰å…è®¸ä½ åˆ›å»º dashboardsï¼Œå…¶å¸¦å¤šä¸ª ToDo åˆ—è¡¨å’Œä¸€ä¸ªèŠå¤©å®¤ã€‚ç”¨æˆ·å¯ä»¥ä¸ä¸åŒåˆ—è¡¨ä¸­çš„æ¡ç›®è¿›è¡Œäº¤äº’ï¼šæ·»åŠ ã€åˆ é™¤ä»¥åŠæŠŠå…¶æ ‡æ³¨ä¸ºå·²å®Œæˆã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/turbo_frames.av1-d92b50b.gif" alt="turbo_frames.av1-d92b50b" /></p>

<p>èµ·åˆï¼Œå®Œæˆå’Œåˆ é™¤è¿™äº›æ¡ç›®æ˜¯é€šè¿‡ AJAX è¯·æ±‚å’Œ<a href="https://github.com/anycable/anycable_rails_demo/blob/fdb1353b3fa4aae2598b5eaceba838b73d09254e/frontend/controllers/list_controller.js">ä¸€ä¸ªè‡ªå®šä¹‰ Stimulus controller</a> æ¥åšåˆ°çš„ã€‚æˆ‘å†³å®šä½¿ç”¨ Turbo Frames æ¥é‡å†™è¿™éƒ¨åˆ†åŠŸèƒ½ä»¥å…¨éƒ¨ä½¿ç”¨ HTMLã€‚</p>

<p>æˆ‘ä»¬å¦‚ä½•æ¥è§£æ„è¿™äº› ToDo åˆ—è¡¨é¡¹ä»¥å¤„ç†å•ä¸ªæ¡ç›®çš„æ›´æ–°å‘¢ï¼ŸæŠŠæ¯ä¸ªæ¡ç›®éƒ½è½¬åŒ–ä¸ºä¸€ä¸ª frameï¼</p>

<pre><code class="language-erb">&lt;!-- _item.html.rb --&gt;
&lt;%= turbo_frame_tag dom_id(item) do %&gt;
  &lt;div class="any-list--item&lt;%= item.completed? ? " checked" : ""%&gt;"&gt;
    &lt;%= form_for item do |f| %&gt;
      &lt;!-- ... --&gt;
    &lt;% end %&gt;
    &lt;%= button_to item_path(item), method: :delete %&gt;
      &lt;!-- ... --&gt;
    &lt;% end %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>è¿™é‡Œæˆ‘ä»¬åšäº†ä¸‰ä¸ªé‡è¦çš„äº‹æƒ…ï¼š</p>

<ul>
  <li>é€šè¿‡ helper ä¼ é€’ä¸€ä¸ªå”¯ä¸€è¯†åˆ«ç¬¦ï¼ˆæ¥è‡ª<code>ActionView</code>çš„å¯çˆ±çš„ <a href="https://api.rubyonrails.org/classes/ActionView/RecordIdentifier.html#method-i-dom_id">dom_id</a> æ–¹æ³•ï¼‰ï¼ŒæŠŠå•ä¸ªæ¡ç›®åŒ…è£¹åœ¨ä¸€ä¸ª<code>&lt;turbo-frame&gt;</code> tag ä¹‹å†…ï¼›</li>
  <li>æ·»åŠ ä¸€ä¸ª HTML formï¼Œä½¿å¾— Turbo æ‹¦æˆªè¡¨å•æäº¤å¹¶æ›´æ–°è¯¥ frame çš„å†…å®¹ï¼›ä»¥åŠ</li>
  <li>ä½¿ç”¨<code>button_to</code> helper å¹¶å¸¦ <code>method: :delete</code> å‚æ•°ï¼Œåœ¨è¯¥ä»£ç å¤„ä¹Ÿåˆ›å»ºäº†ä¸€ä¸ª HTML formã€‚</li>
</ul>

<p>ç°åœ¨ï¼Œä»»ä½•æ—¶å€™è¯¥ frame å†…æœ‰è¡¨å•æäº¤ï¼ŒTurbo éƒ½ä¼šæ‹¦æˆªè¯¥æäº¤ï¼Œæ‰§è¡Œ AJAX è¯·æ±‚ï¼Œä»å“åº”è¿”å›çš„ HTML ä¸­æå–å‡ºæœ‰ç›¸åŒ ID çš„ frameï¼ŒæŠŠå…¶å†…å®¹æ›¿æ¢åˆ°è¯¥ frame ä¸Šã€‚</p>

<p><strong>æ‰€æœ‰ä¸Šè¿°å·¥ä½œæ²¡æœ‰ä¸€è¡Œè‡ªå·±æ‰‹å†™çš„ JavaScriptï¼</strong></p>

<p>æ¥çœ‹ä¸€ä¸‹æ›´æ–°è¿‡åçš„ controller ä»£ç ï¼š</p>

<pre><code class="language-ruby">class ItemsController &lt; ApplicationController
  def update
    item.update!(item_params)

    render partial: "item", locals: { item }
  end

  def destroy
    item.destroy!

    render partial: "item", locals: { item }
  end
end
</code></pre>

<p>æ³¨æ„ï¼Œå½“æˆ‘ä»¬åˆ é™¤æ¡ç›®æ—¶ï¼Œä»¥åŒæ ·çš„ partial è¿›è¡Œäº†å“åº”ã€‚ä½†æˆ‘ä»¬éœ€è¦ç§»é™¤è¯¥æ¡ç›®çš„ HTML èŠ‚ç‚¹è€Œéæ›´æ–°å®ƒã€‚è¦å¦‚ä½•åšå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç©º frame æ¥å“åº”ï¼æ›´æ–° partial ä¸ºå¦‚ä¸‹ï¼š</p>

<pre><code class="language-erb">&lt;!-- _item.html.rb --&gt;
&lt;%= turbo_frame_tag dom_id(item) do %&gt;
  &lt;% unless item.destroyed? %&gt;
    &lt;div class="any-list--item&lt;%= item.completed? ? " checked" : ""%&gt;"&gt;
      &lt;!-- ... --&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</code></pre>

<p>ä½ å¯èƒ½ä¼šé—®è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼šâ€œå½“æ ‡æ³¨ä¸€ä¸ªæ¡ç›®ä¸ºå®Œæˆæ—¶å¦‚ä½•è§¦å‘è¡¨å•æäº¤å‘¢ï¼Ÿâ€æ¢å¥è¯è¯´ï¼Œå¦‚ä½•è®© checkbox çš„çŠ¶æ€å˜æ›´æ¥è§¦å‘æäº¤è¡¨å•ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ª<em>è¡Œå†…äº‹ä»¶ç›‘å¬å™¨</em>åšåˆ°ï¼š</p>

<pre><code class="language-erb">&lt;%= f.check_box :completed, onchange: "this.form.requestSubmit();" %&gt;
</code></pre>

<p><strong>æé†’ï¼š</strong>ä½¿ç”¨ <em><code>requestSubmit()</code></em> è€Œé <em><code>submit()</code></em> å¾ˆé‡è¦ï¼šå‰è€…è§¦å‘çš„â€œsubmitâ€äº‹ä»¶èƒ½å¤Ÿè¢« Turbo æ‰€æ‹¦æˆªï¼Œè€Œåè€…ä¸èƒ½ã€‚</p>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾å¼ƒæ‰€æœ‰ä¸“é—¨ä¸ºæ­¤åŠŸèƒ½å®šåˆ¶çš„ JS äº†ï¼Œåªéœ€ä¸€ç‚¹ HTML æ¨¡æ¿çš„æ›´æ”¹å’Œ controller ä»£ç çš„ç®€åŒ–ã€‚éå¸¸ä»¤äººå…´å¥‹ï¼Œä¸æ˜¯ä¹ˆï¼Ÿ</p>

<p>æˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼ŒæŠŠåˆ—è¡¨ä¹Ÿè½¬åŒ–ä¸º framesã€‚è¿™ä¼šè®©æˆ‘ä»¬åœ¨æ·»åŠ ä¸€ä¸ªæ–°æ¡ç›®æ—¶ï¼Œä» Turbo Drive çš„æ•´ä¸ªé¡µé¢æ›´æ–°åˆ‡æ¢ä¸ºä»…ç‰¹æ®Šé¡µé¢èŠ‚ç‚¹çš„æ›´æ–°ã€‚ä½ å¤§å¯è‡ªå·±å°è¯•ä¸€ä¸‹ï¼</p>

<p>å‡è®¾ä½ ä¹ŸæœŸæœ›åœ¨ä¸€ä¸ªæ¡ç›®è¢«å®Œæˆæˆ–åˆ é™¤çš„ä»»ä½•æ—¶å€™éƒ½ä¸ºç”¨æˆ·å±•ç¤ºä¸€ä¸ª flash æé†’ï¼ˆæ¯”å¦‚ï¼Œâ€œæ¡ç›®å·²è¢«æˆåŠŸåˆ é™¤â€ï¼‰ã€‚æˆ‘ä»¬èƒ½å€ŸåŠ©äº Turbo Frames åšåˆ°å—ï¼Ÿå¬èµ·æ¥æˆ‘ä»¬éœ€è¦æŠŠ flash æ¶ˆæ¯å®¹å™¨åŒ…è£¹åœ¨ä¸€ä¸ª frame å†…ï¼Œå¹¶å°†æ›´æ–°åçš„ HTML è·Ÿæ ‡è®°ä¸€èµ·æ¨é€ç»™è¯¥æ¡ç›®ã€‚è¿™æ˜¯æˆ‘åˆå§‹çš„æ€è·¯ï¼Œä½†å…¶å¹¶ä¸èƒ½æ­£å¸¸å·¥ä½œï¼šframe çš„æ›´æ–°æ˜¯åœ¨æ‰€åˆ›å»ºçš„ frame å®šä¹‰åŸŸå†…çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ— æ³•æ›´æ–°åœ¨å…¶å¤–éƒ¨çš„ä»»ä½•ä¸œè¥¿ã€‚</p>

<p>ç»è¿‡ä¸€ç•ªæ¢ç´¢ä¹‹åï¼Œæˆ‘å‘ç° <a href="https://turbo.hotwire.dev/handbook/streams">Turbo Streams</a> èƒ½å¸®æˆ‘ä»¬åšåˆ°è¿™ç‚¹ã€‚</p>

<h2 id="streaming-with-turbo-streams">Streaming with Turbo Streams</h2>

<p>è¾ƒä¹‹äº Drive å’Œ Framesï¼Œ<a href="https://turbo.hotwire.dev/handbook/streams">Turbo Streams</a> å®Œå…¨æ˜¯ä¸€é¡¹æ–°æŠ€æœ¯ã€‚è·Ÿå‰ä¸¤è€…ä¸åŒï¼ŒStreams å«ä¹‰æ˜ç¡®ï¼Œæ˜“äºç†è§£ã€‚æ²¡æœ‰ä»€ä¹ˆä¼šè‡ªåŠ¨å‘ç”Ÿï¼Œä½ å¾—è´Ÿè´£é¡µé¢ä¸Šä½•æ—¶æ›´æ–°ä½•ç§å†…å®¹ã€‚è¦åšåˆ°è¿™ç‚¹ï¼Œä½ éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„<code>&lt;trubo-stream&gt;</code>å…ƒç´ ã€‚</p>

<p>æ¥çœ‹ä¸€ä¸ª stream å…ƒç´ çš„ç¤ºä¾‹ï¼š</p>

<pre><code class="language-erb">&lt;turbo-stream action="replace" target="flash-alerts"&gt;
  &lt;template&gt;
    &lt;div class="flash-alerts--container" id="flash-alerts"&gt;
      &lt;!--  --&gt;
    &lt;/div&gt;
  &lt;/template&gt;
&lt;/turbo-stream&gt;
</code></pre>

<p>è¯¥å…ƒç´ è´Ÿè´£ä»¥<code>&lt;template&gt;</code> tag å†…æ‰€ä¼ è¾“è¿‡æ¥çš„æ–° HTML å†…å®¹æ›¿æ¢ï¼ˆ<code>action="replace"</code>ï¼‰DOM ID ä¸º<code>flash-alerts</code>å…¶ä¸‹çš„èŠ‚ç‚¹ã€‚ä¸ç®¡ä»€ä¹ˆæ—¶å€™ä½ æŠŠè¿™æ ·çš„<code>&lt;turbo-stream&gt;</code>å…ƒç´ ä¸‹å‘åˆ°é¡µé¢ä¸Šï¼Œå®ƒéƒ½ä¼šç«‹åˆ»æ‰§è¡Œå…¶ action å¹¶é”€æ¯å…¶è‡ªèº«ã€‚è€Œåœ¨åº•å±‚ï¼Œå®ƒä½¿ç”¨äº† HTML çš„ <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_custom_elements">Custom Elements API</a> â€”â€” åˆä¸€ä¸ªä¸ºäº†å¼€å‘ä¹è¶£ï¼ˆæ¯”å¦‚ï¼Œæ›´å°‘çš„ JavaScript ğŸ˜„ï¼‰è€Œä½¿ç”¨ç°ä»£ Web APIs çš„èŒƒä¾‹ã€‚</p>

<p>æˆ‘å¾—è¯´ï¼ŒTurbo Streams æ˜¯è€å¼çš„ JavaScript æ¨¡æ¿çš„ä¸€ä¸ªå£°æ˜å¼æ›¿ä»£æ–¹æ¡ˆã€‚åœ¨ 2010 å¹´ä»£ï¼Œæˆ‘ä»¬å†™çš„ä»£ç ç±»ä¼¼è¿™æ ·ï¼š</p>

<pre><code class="language-erb">// destroy.js.erb
$("#&lt;%= dom_id(item) %&gt;").remove();
</code></pre>

<p>è€Œç°åœ¨ï¼Œæˆ‘ä»¬è¿™æ ·å†™ï¼š</p>

<pre><code class="language-erb">&lt;!--  destroy.html.erb --&gt;
&lt;%= turbo_stream.remove dom_id(item) %&gt;
</code></pre>

<p>ç›®å‰ï¼Œä»…æœ‰äº”ç§å¯ç”¨çš„ actionsï¼š<em>appendã€prependã€replaceã€remove å’Œ update</em>ï¼ˆä»…æ›¿æ¢èŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹ï¼‰ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢è°ˆè®ºå…¶å±€é™æ€§å’Œå¦‚ä½•å…‹æœå®ƒã€‚</p>

<p>å›åˆ°æˆ‘ä»¬çš„åˆå§‹é—®é¢˜ï¼šä¸º ToDo æ¡ç›®çš„å®Œæˆæˆ–åˆ é™¤ï¼Œå±•ç¤ºå“åº”ç»“æœä¸­çš„ flash æé†’ã€‚</p>

<p>æˆ‘ä»¬æƒ³è¦ä¸€æ¬¡å“åº”ç»“æœå°±å¸¦æœ‰<code>&lt;turbo-frame&gt;</code>å’Œ<code>&lt;turbo-stream&gt;</code>ä¸¤ç§æ›´æ–°ã€‚å¦‚ä½•æ¥åšï¼Ÿä¸ºå…¶æ·»åŠ ä¸€ä¸ªæ–°çš„ partial æ¨¡æ¿ï¼š</p>

<pre><code class="language-erb">&lt;!-- _item_update.html.erb --&gt;
&lt;%= render item %&gt;

&lt;%= turbo_stream.replace "flash-alerts" do %&gt;
  &lt;%= render "shared/alerts" %&gt;
&lt;% end %&gt;
</code></pre>

<p>å¯¹<code>ItemsController</code>æ·»åŠ ä¸€ç‚¹å°çš„æ”¹åŠ¨ï¼š</p>

<pre><code class="language-diff">+    flash.now[:notice] = "Item has been updated"

-    render partial: "item", locals: { item }
+    render partial: "item_update", locals: { item }
</code></pre>

<p>ä¸å¹¸åœ°æ˜¯ï¼Œä¸Šè¿°ä»£ç å¹¶æœªå¦‚é¢„æœŸé‚£æ ·æ­£å¸¸å·¥ä½œï¼šæˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°ä»»ä½• flash æé†’ã€‚</p>

<p>æ·±å…¥ç ”ç©¶<a href="https://turbo.hotwire.dev/handbook/streams#streaming-from-http-responses">æ–‡æ¡£</a>ä¹‹åï¼Œæˆ‘å‘ç°æ˜¯ Turbo æœŸæœ› HTTP å“åº”å…·æœ‰<code>text/vnd.turbo-stream.html</code> content type æ‰å¯æ¿€æ´» stream å…ƒç´ ã€‚å¥½å§ï¼ŒåŠ ä¸Šå®ƒï¼š</p>

<pre><code class="language-diff">-    render partial: "item_update", locals: { item }
+    render partial: "item_update", locals: { item }, content_type: "text/vnd.turbo-stream.html"
</code></pre>

<p>ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†ç›¸åçš„æƒ…å†µï¼šflash æ¶ˆæ¯æ­£å¸¸å·¥ä½œï¼Œä½†æ¡ç›®çš„å†…å®¹ä¸èƒ½æ›´æ–°äº†ğŸ˜ã€‚æ˜¯æˆ‘å¯¹ Hotwire è¦æ±‚å¤ªé«˜äº†ä¹ˆï¼Ÿé˜…è¯»äº†ä¸‹ Turbo çš„æºç ï¼Œæˆ‘å‘ç°ç±»ä¼¼è¿™æ ·æŠŠ streams å’Œ frames è¿›è¡Œæ··åˆæ˜¯<a href="https://github.com/hotwired/turbo/blob/8bce5f17cd697716600d3b34836365ebcdc04b3f/src/observers/stream_observer.ts#L50-L55">ä¸è¡Œçš„</a>ã€‚</p>

<p>è¿™è¯´æ˜ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥å®ç°è¯¥åŠŸèƒ½ï¼š</p>

<ul>
  <li>æŠŠ streams ç”¨åœ¨æ‰€æœ‰ä¸œè¥¿ä¸Šã€‚</li>
  <li>æŠŠ<code>&lt;turbo-stream&gt;</code>ç½®äº<code>&lt;turbo-frame&gt;</code>å†…éƒ¨ã€‚</li>
</ul>

<p>ç¬¬äºŒä¸ªé€‰é¡¹ï¼Œå¯¹æˆ‘è€Œè¨€ï¼Œä¸åœ¨å¸¸è§„é¡µé¢ä¸Šé‡ç”¨ HTML partials å¹¶ä»¥ Turbo è¿›è¡Œæ›´æ–°çš„æƒ³æ³•èƒŒé“è€Œé©°ã€‚æ‰€ä»¥ï¼Œæˆ‘é€‰æ‹©ç¬¬ä¸€ä¸ªï¼š</p>

<pre><code class="language-erb">&lt;!-- _item_update.html.erb --&gt;
&lt;%= turbo_stream.replace dom_id(item) do %&gt;
  &lt;%= render item %&gt;
&lt;% end %&gt;

&lt;%= turbo_stream.replace "flash-alerts" do %&gt;
  &lt;%= render "shared/alerts" %&gt;
&lt;% end %&gt;
</code></pre>

<p>ä»»åŠ¡å®Œæˆã€‚ä½†ä»˜å‡ºäº†ä»€ä¹ˆä»£ä»·å‘¢ï¼Ÿæˆ‘ä»¬ä¸å¾—ä¸ä¸ºè¿™ç§ç”¨ä¾‹æ·»åŠ ä¸€ä¸ªæ–°çš„æ¨¡æ¿ã€‚å¹¶ä¸”æˆ‘æ‹…å¿ƒåœ¨ç°å®ä¸­çš„åº”ç”¨ç¨‹åºé‡Œï¼Œè¿™ç§ partials çš„æ•°é‡ä¼šéšç€åº”ç”¨çš„è¿›åŒ–è€Œå¢é•¿ã€‚</p>

<p><strong>æ›´æ–°ï¼ˆ2021-04-13ï¼‰</strong>ï¼šAlex Takitani <a href="https://twitter.com/alex_takitani/status/1381706025875730435?s=20">å»ºè®®</a>äº†ä¸€ç§æ›´åŠ ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ layout æ¥æ›´æ–° flash å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹é¢è¿™æ ·æŠŠ application layout å®šä¹‰ä¸º Turbo Stream å“åº”ï¼š</p>

<pre><code class="language-erb">&lt;!-- layouts/application.turbo_stream.erb --&gt;
&lt;%= turbo_stream.replace "flash-alerts" do %&gt;
  &lt;%= render "shared/alerts" %&gt;
&lt;% end %&gt;

&lt;%= yield %&gt;
</code></pre>

<p>ç„¶åï¼Œæˆ‘ä»¬éœ€è¦ä» controller ç§»é™¤ç›¸åº”çš„æ¸²æŸ“ï¼ˆå› ä¸ºè¦ä¸ç„¶ <a href="https://github.com/hotwired/turbo-rails/issues/25">layout å°±ä¸ä¼šè¢«ç”¨ä¸Šäº†</a>ï¼‰ï¼š</p>

<pre><code class="language-diff">def update
     item.update!(item_params)

     flash.now[:notice] = "Item has been updated"
-
-    render partial: "item_update", locals: { item }, content_type: "text/vnd.turbo-stream.html"
   end
</code></pre>

<p><strong>æ³¨æ„ï¼š</strong>åˆ«å¿˜äº†æŠŠ<em><code>format: :turbo_stream</code></em>æ·»åŠ åˆ° controller/request specs æµ‹è¯•ç›¸åº”çš„è¯·æ±‚ä¸Šï¼Œä»¥ä¾¿ä½¿å¾— render èƒ½æ­£å¸¸å·¥ä½œã€‚</p>

<p>å¹¶ä¸”æŠŠæˆ‘ä»¬çš„<code>_item_update</code> partial è½¬æ¢ä¸º<code>update</code>çš„ Turbo Stream æ¨¡æ¿ï¼š</p>

<pre><code class="language-erb">&lt;!-- update.turbo_stream.erb --&gt;
&lt;%= turbo_stream.replace dom_id(item) do %&gt;
  &lt;%= render item %&gt;
&lt;% end %&gt;
</code></pre>

<p>å¾ˆé…·ï¼Œå¯¹å§ï¼Ÿè¿™æ­£æ˜¯ Rails çš„æ–¹å¼ï¼</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è½¬åˆ°ä¸€äº›å®æ—¶çš„æµå¹¿æ’­ä¸Šã€‚</p>

<p>Turbo Streams ç»å¸¸åœ¨å®æ—¶æ›´æ–°çš„è¯­å¢ƒä¸­è¢«æåˆ°ï¼ˆä¸”å¸¸å¸¸è¢«ç”¨æ¥è·Ÿ <a href="https://stimulusreflex.com/">StimulusReflex</a> æ¯”è¾ƒï¼‰ã€‚</p>

<p>æ¥çœ‹çœ‹æˆ‘ä»¬èƒ½å¤Ÿå¦‚ä½•åœ¨ Turbo Streams ä¹‹ä¸Šæ„å»ºåˆ—è¡¨çš„åŒæ­¥åŒ–ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/turbo_streams.av1-17e20a6.gif" alt="turbo_streams.av1-17e20a6" /></p>

<p>åœ¨æœ‰ Turbo ä¹‹å‰ï¼Œæˆ‘ä¸å¾—ä¸æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„ Action Cable channel å’Œä¸€ä¸ª Stimulus controller æ¥å¤„ç†å¹¿æ’­çš„äº‹æƒ…ã€‚æˆ‘ä¹Ÿéœ€è¦å¤„ç†æ¶ˆæ¯çš„æ ¼å¼ï¼Œå› ä¸ºå¿…é¡»åŒºåˆ†å¯¹æ¡ç›®çš„åˆ é™¤å’Œå®Œæˆã€‚æ¢å¥è¯è¯´ï¼Œæœ‰ä¸å°‘ä»£ç è¦ç»´æŠ¤ã€‚</p>

<p>è€Œ Turbo Streams å·²ç»ç…§é¡¾å¥½äº†å‡ ä¹ä¸€åˆ‡ï¼š<code>turbo-rails</code> gem è‡ªå¸¦ä¸€ä¸ªé€šç”¨çš„<code>Turbo::StreamChannel</code>å’Œä¸€ä¸ª helperï¼ˆ<code>#turbo_stream_from</code>ï¼‰ï¼Œç”¨æ¥ä» HTML ä¸­åˆ›å»ºä¸€ä¸ª subscriptionï¼š</p>

<pre><code class="language-erb">&lt;!-- worspaces/show.html.erb --&gt;
&lt;div&gt;
  &lt;%= turbo_stream_from workspace %&gt;
  &lt;!-- ... --&gt;
&lt;/div&gt;
</code></pre>

<p>åœ¨ controller ä¸­ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†<code>#broadcast_new_item</code>å’Œ<code>#broadcast_changes</code>è¿™æ ·çš„â€œafter actionâ€ callback è´Ÿè´£å¯¹æ›´æ–°è¿›è¡Œæ’­å‘ã€‚ç°åœ¨æˆ‘ä»¬æ‰€æœ‰éœ€è¦åšçš„å°±æ˜¯åˆ‡æ¢åˆ°<code>Turbo::StreamChannel</code>ï¼š</p>

<pre><code class="language-diff">def broadcast_changes
   return if item.errors.any?
   if item.destroyed?
-    ListChannel.broadcast_to list, type: "deleted", id: item.id
+    Turbo::StreamsChannel.broadcast_remove_to workspace, target: item
   else
-    ListChannel.broadcast_to list, type: "updated", id: item.id, desc: item.desc, completed: item.completed
+    Turbo::StreamsChannel.broadcast_replace_to workspace, target: item, partial: "items/item", locals: { item }
   end
 end
</code></pre>

<p>è¿™æ¬¡è¿ç§»å¾ˆé¡ºç•…ï¼Œå‡ ä¹â€”â€”å› ä¸ºæ‰€æœ‰æ£€éªŒæ’­å‘ï¼ˆ<code>#have_broadcasted_to</code>ï¼‰çš„ controller å•å…ƒæµ‹è¯•éƒ½å¤±è´¥äº†ã€‚</p>

<p>ä¸å¹¸çš„æ˜¯ï¼ŒTurbo Rails æ²¡æœ‰æä¾›ä»»ä½•æµ‹è¯•å·¥å…·ï¼ˆ?ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä¸å¾—ä¸è‡ªå·±å†™ä¸€ä¸ªï¼Œä»¥<a href="https://github.com/rails/rails/pull/33659">è‡ªå·±ç†Ÿæ‚‰çš„æ–¹å¼</a>ï¼š</p>

<pre><code class="language-ruby">module Turbo::HaveBroadcastedToTurboMatcher
  include Turbo::Streams::StreamName

  def have_broadcasted_turbo_stream_to(*streamables, action:, target:) # rubocop:disable Naming/PredicateName
    target = target.respond_to?(:to_key) ? ActionView::RecordIdentifier.dom_id(target) : target
    have_broadcasted_to(stream_name_from(streamables))
      .with(a_string_matching(%(turbo-stream action="#{action}" target="#{target}")))
  end
end

RSpec.configure do |config|
  config.include Turbo::HaveBroadcastedToTurboMatcher
end
</code></pre>

<p>ä¸‹é¢æ˜¯æˆ‘å¦‚ä½•æŠŠè¿™ä¸ªæ–°çš„åŒ¹é…å™¨ç”¨åœ¨æµ‹è¯•ä¸Šï¼š</p>

<pre><code class="language-diff">it "broadcasts a deleted message" do
-  expect { subject }.to have_broadcasted_to(ListChannel.broadcasting_for(list))
-    .with(type: "deleted", id: item.id)
+  expect { subject }.to have_broadcasted_turbo_stream_to(
+    workspace, action: :remove, target: item
+  )
 end
</code></pre>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½¿ç”¨ Turbo çš„å®æ—¶å¤„ç†è¿›å±•é¡ºåˆ©ï¼ä¸€å¤§å †ä»£ç éƒ½è¢«ç§»é™¤äº†ã€‚</p>

<p><strong>è€Œæˆ‘ä»¬ä»ç„¶è¿˜æ˜¯ä¸€è¡Œ JavaScript ä»£ç éƒ½æ²¡æœ‰å†™ã€‚è¿™ä¹Ÿå¤ªä¸çœŸå®äº†å§ï¼Ÿ</strong></p>

<p>ä¸è¿‡æ˜¯ä¸ªå¹»æ¢¦å—ï¼Ÿä½•æ—¶æˆ‘ä¼šé†’æ¥ï¼Ÿå¥½å§ï¼Œå°±æ˜¯ç°åœ¨ã€‚</p>

<h2 id="beyond-turbo-or-using-stimulus-and-custom-elements">Beyond Turbo, or using Stimulus and custom elements</h2>

<p>åœ¨å‘ Turbo è¿ç§»çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ç¢°åˆ°äº†å¥½å‡ ä¸ªåœºæ™¯ï¼Œä½¿ç”¨å·²æœ‰çš„ API æ˜¯ä¸å¤Ÿçš„ï¼Œæ‰€ä»¥æˆ‘æœ€ç»ˆä¸å¾—ä¸ç¼–å†™ä¸€äº› JavaScript ä»£ç ï¼</p>

<p>åœºæ™¯ä¸€ï¼šå‘ dashboard å®æ—¶æ·»åŠ æ–°çš„åˆ—è¡¨ã€‚è¿™è·Ÿå‰é¢æåˆ°çš„åˆ—è¡¨ä¸­æ¡ç›®çš„ç¤ºä¾‹æœ‰ä½•ä¸åŒï¼Ÿåœ¨äºæ ‡è®°ã€‚æ¥çœ‹ä¸€ä¸‹ dashboard layoutï¼š</p>

<pre><code class="language-html">&lt;div id="workspace_1"&gt;
  &lt;div id="list_1"&gt;...&lt;/div&gt;
  &lt;div id="list_2"&gt;...&lt;/div&gt;
  &lt;div id="new_list"&gt;
    &lt;form&gt;...&lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>æœ€åä¸€ä¸ªå…ƒç´ æ€»æ˜¯æ–°åˆ—è¡¨çš„ form å®¹å™¨ã€‚ä¸ç®¡æˆ‘ä»¬ä½•æ—¶æ·»åŠ æ–°åˆ—è¡¨ï¼Œå®ƒéƒ½ä¼šè¢«æ’å…¥åˆ°<code>#new_list</code>èŠ‚ç‚¹ä¹‹å‰ã€‚è¿˜è®°å¾— Turbo Streams ä»…ä»…æ”¯æŒäº”ç§ actions ä¸ï¼Ÿæ˜ç™½é—®é¢˜æ‰€åœ¨äº†å—ï¼Ÿä¸‹é¢æ˜¯æˆ‘èµ·åˆä½¿ç”¨çš„ä»£ç ï¼š</p>

<pre><code class="language-js">handleUpdate(data) {
  this.formTarget.insertAdjacentHTML("beforebegin", data.html);
}
</code></pre>

<p>è¦ä½¿ç”¨ Turbo Streams å®ç°ç±»ä¼¼çš„è¡Œä¸ºï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ª hackï¼Œåœ¨åˆ—è¡¨è¢«é€šè¿‡ stream æ·»åŠ ä¹‹åç«‹å³æŠŠå…¶ç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®ã€‚æ‰€ä»¥ï¼Œæ¥æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„ JavaScript ä»£ç å§ã€‚</p>

<p>é¦–å…ˆæ¥ç»™æˆ‘ä»¬çš„ä»»åŠ¡ä¸€ä¸ªæ­£å¼çš„å®šä¹‰ï¼šâ€œå½“ä¸€ä¸ªæ–°åˆ—è¡¨è¢« append åˆ° workspace å®¹å™¨æ—¶ï¼Œå®ƒåº”è¯¥å‡ºç°åœ¨é‚£ä¸ª new form å…ƒç´ ä¹‹å‰çš„æ­£ç¡®ä½ç½®ä¸Šã€‚â€ã€‚è¿™é‡Œçš„â€œå½“â€æ„å‘³ç€æˆ‘ä»¬éœ€è¦è§‚å¯Ÿ DOM å¹¶å¯¹å˜æ›´ä½œå‡ºååº”ã€‚æ˜¯ä¸æ˜¯å¬èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬å·²ç»æåˆ°è¿‡ä¸ Stimulus æœ‰å…³çš„ MutationObserver APIï¼ç”¨å®ƒå°±å¯¹äº†ã€‚</p>

<p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸æ˜¯å¿…é¡»ç¼–å†™é«˜é˜¶çš„ JavaScript æ‰èƒ½ä½¿ç”¨è¯¥ç‰¹æ€§ï¼›æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href="https://github.com/stimulus-use/stimulus-use">stimulus-use</a>ï¼ˆæŠ±æ­‰ä½¿ç”¨è¿™ç§é‡è¨€å¼è¯­æ³•ã€‚ã€è¯‘è€…æ³¨ï¼šåŸæ–‡æ˜¯ use stimulus-useï¼Œæ‰€ä»¥ä½œè€…è¿™ä¹ˆè¯´ã€‘ï¼‰ã€‚Stimulus Use æ˜¯ä¸€ä¸ª Stimulus controllers å¾ˆæœ‰ç”¨çš„è¡Œä¸ºçš„é›†åˆï¼Œä»¥ç®€å•çš„ä»£ç ç‰‡æ®µè§£å†³å¤æ‚çš„é—®é¢˜ã€‚æˆ‘ä»¬è¿™å„¿ï¼Œéœ€è¦ <a href="https://github.com/stimulus-use/stimulus-use/blob/master/docs/use-mutation.md">useMutation</a> è¡Œä¸ºã€‚</p>

<p>å¦‚ä¸‹çš„ controller ä»£ç ç›¸å½“ç®€æ´ï¼Œå«ä¹‰ä¸è¨€è‡ªæ˜ï¼š</p>

<pre><code class="language-js">import { Controller } from "stimulus";
import { useMutation } from "stimulus-use";

export default class extends Controller {
  static targets = ["lists", "newForm"];

  connect() {
    [this.observeLists, this.unobserveLists] = useMutation(this, {
      element: this.listsTarget,
      childList: true,
    });
  }

  mutate(entries) {
    // There should be only one entry in case of adding a new list via streams
    const entry = entries[0];

    if (!entry.addedNodes.length) return;

    // Disable observer while we modify the childList
    this.unobserveLists();
    // Move newForm to the end of the childList
    this.listsTarget.append(this.newFormTarget);
    this.observeLists();
  }
}
</code></pre>

<p>é—®é¢˜å°±è¿™æ ·è§£å†³äº†ã€‚</p>

<p>æ¥è®¨è®ºä¸‹ç¬¬äºŒä¸ªè¾¹ç•Œåœºæ™¯ï¼šå®ç°èŠå¤©å®¤åŠŸèƒ½ã€‚</p>

<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„èŠå¤©å®¤é™„åœ¨æ¯ä¸ª dashboard ä¸Šï¼šç”¨æˆ·å¯ä»¥å‘é€ä¸´æ—¶æ¶ˆæ¯ï¼ˆä¸ä¼šè¢«å­˜å‚¨åˆ°ä»»ä½•åœ°æ–¹ï¼‰å’Œå®æ—¶æ¥æ”¶å®ƒä»¬ã€‚æ¶ˆæ¯å…·æœ‰ä¾èµ–äºä¸Šä¸‹æ–‡çš„ä¸åŒå¤–è§‚ï¼šè‡ªå·±çš„æ¶ˆæ¯æœ‰ç»¿è‰²è¾¹æ¡†ï¼Œé å·¦ï¼›å…¶ä»–æ¶ˆæ¯åˆ™æ˜¯ç°è‰²ï¼Œé å³ã€‚è€Œæˆ‘ä»¬æ˜¯å‘æ¯ä¸ªæ‰€è¿æ¥çš„å®¢æˆ·ç«¯æ’­å‘ç›¸åŒçš„ HTMLã€‚è¦å¦‚ä½•ä½¿å¾—ç”¨æˆ·çœ‹åˆ°è¿™ç§åŒºåˆ«å‘¢ï¼Ÿè¿™å¯¹äºèŠå¤©å®¤ç±»çš„åº”ç”¨æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„é—®é¢˜ï¼Œä¸”ä¸€èˆ¬è€Œè¨€ï¼Œå®ƒé€šè¿‡è¦ä¹ˆå‘æ¯ä¸ªç”¨æˆ· channel å‘é€ä¸ªæ€§åŒ–çš„ HTMLï¼Œè¦ä¹ˆå¢å¼ºæ‰€æ”¶åˆ°çš„ HTML åœ¨å®¢æˆ·ç«¯æ¥è§£å†³ã€‚æˆ‘æ›´å–œæ¬¢ç¬¬äºŒç§ï¼Œæ‰€ä»¥æ¥å®ç°å®ƒå§ã€‚</p>

<p>è¦æŠŠå½“å‰ç”¨æˆ·çš„ä¿¡æ¯ä¼ é€’ç»™ JavaScriptï¼Œæˆ‘ä½¿ç”¨ meta tagsï¼š</p>

<pre><code class="language-erb">&lt;!-- layouts/application.html.erb --&gt;
&lt;head&gt;
  &lt;% if logged_in? %&gt;
    &lt;meta name="current-user-name" content="&lt;%= current_user.name %&gt;" data-turbo-track="reload"&gt;
    &lt;meta name="current-user-id" content="&lt;%= current_user.id %&gt;" data-turbo-track="reload"&gt;
  &lt;% end %&gt;
  &lt;!-- ... --&gt;
&lt;/head&gt;
</code></pre>

<p>å’Œä¸€ä¸ªå°çš„ JS helper æ¥è·å–è¿™äº› valuesï¼š</p>

<pre><code class="language-js">let user;

export const currentUser = () =&gt; {
  if (user) return user;

  const id = getMeta("id");
  const name = getMeta("name");

  user = { id, name };
  return user;
};

function getMeta(name) {
  const element = document.head.querySelector(
    `meta[name='current-user-${name}']`
  );
  if (element) {
    return element.getAttribute("content");
  }
}
</code></pre>

<p>è¦æ’­å‘èŠå¤©å®¤æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†ä¼šä½¿ç”¨<code>Turbo::StreamChannel</code>ï¼š</p>

<pre><code class="language-ruby">def create
  Turbo::StreamsChannel.broadcast_append_to(
    workspace,
    target: ActionView::RecordIdentifier.dom_id(workspace, :chat_messages),
    partial: "chats/message",
    locals: { message: params[:message], name: current_user.name, user_id: current_user.id }
  )
  # ...
end
</code></pre>

<p>ä¸‹é¢æ˜¯åˆå§‹çš„<code>chat/message</code>æ¨¡æ¿ï¼š</p>

<pre><code class="language-erb">&lt;div class="chat--msg"&gt;
  &lt;%= message %&gt;
  &lt;span data-role="author" class="chat--msg--author"&gt;&lt;%= name %&gt;&lt;/span&gt;
&lt;/div&gt;
</code></pre>

<p>ä»¥åŠå‰è¿°æ ¹æ®å½“å‰ç”¨æˆ·èµ‹äºˆä¸åŒæ ·å¼çš„ JS ä»£ç ï¼Œè¿™äº›ä»£ç æˆ‘ä»¬å¾ˆå¿«å°±è¦å»æ‰ï¼š</p>

<pre><code class="language-js">// Don't get attached to it
appendMessage(html, mine) {
  this.messagesTarget.insertAdjacentHTML("beforeend", html);
  const el = this.messagesTarget.lastElementChild;
  el.classList.add(mine ? "mine" : "theirs");

  if (mine) {
    const authorElement = el.querySelector('[data-role="author"]');
    if (authorElement) authorElement.innerText = "You";
  }
}
</code></pre>

<p>ç°åœ¨ï¼Œå½“ Turbo è´Ÿè´£æ›´æ–° HTML æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åšç‚¹ä¸åŒçš„äº‹ã€‚å½“ç„¶ï¼Œ<code>useMutaion</code>ä¹Ÿä¼šåœ¨è¿™é‡Œè¢«ç”¨åˆ°ã€‚å¹¶ä¸”è¿™æœ‰å¯èƒ½æ˜¯æˆ‘å°†ç”¨åœ¨<em>ç°å®</em>é¡¹ç›®ä¸Šçš„ã€‚ç„¶è€Œï¼Œæˆ‘ä»Šå¤©çš„ç›®æ ‡æ˜¯æ¼”ç¤ºä»¥ä¸åŒçš„æ–¹å¼æ¥è§£å†³é—®é¢˜ã€‚</p>

<p>è¿˜è®°å¾—æˆ‘ä»¬ä¸€ç›´åœ¨è°ˆè®º Custom Elementsï¼ˆå“¦ï¼Œé‚£æ˜¯å¥½å‡ é¡µä¹‹å‰äº†ï¼ŒæŠ±æ­‰ï¼Œè¿™è¯´æ˜æˆ‘ä»¬é˜…è¯»å¤ªä¹…äº†ï¼‰ï¼Ÿå®ƒæ­£æ˜¯ä»¤ Turbo ä¹‹æ‰€ä»¥å¼ºå¤§çš„ Web APIã€‚æˆ‘ä»¬å¹²å˜›ä¸ç”¨å‘¢ï¼</p>

<p>è®©æˆ‘å…ˆåˆ†äº«ä¸€ä¸ª<em>æ›´æ–°åçš„</em> HTML æ¨¡æ¿ï¼š</p>

<pre><code class="language-erb">&lt;any-chat-message class="chat--msg" data-author-id="&lt;%= user_id %&gt;&gt;
  &lt;%= message %&gt;
  &lt;span data-role="author" class="chat--msg--author"&gt;&lt;%= name %&gt;&lt;/span&gt;
&lt;/any-chat-message&gt;
</code></pre>

<p>æˆ‘ä»¬åªæ·»åŠ äº†<code>data-author-id</code>å±æ€§ï¼Œå¹¶æŠŠ<code>&lt;div&gt;</code>æ›¿æ¢ä¸ºè‡ªå®šä¹‰ tag â€”â€”<code>&lt;any-chat-message&gt;</code>ã€‚</p>

<p>ç°åœ¨æ¥å¯¹ custom element è¿›è¡Œæ³¨å†Œï¼š</p>

<pre><code class="language-js">import { currentUser } from "../utils/current_user";

// This is how you create custom HTML elements with a modern API
export class ChatMessageElement extends HTMLElement {
  connectedCallback() {
    const mine = currentUser().id == this.dataset.authorId;

    this.classList.add(mine ? "mine" : "theirs");

    const authorElement = this.querySelector('[data-role="author"]');

    if (authorElement &amp;&amp; mine) authorElement.innerText = "You";
  }
}

customElements.define("any-chat-message", ChatMessageElement);
</code></pre>

<p>å¤§åŠŸå‘Šæˆï¼ç°åœ¨å½“ä¸€ä¸ªæ–°çš„<code>&lt;any-chat-message&gt;</code>å…ƒç´ è¢«æ·»åŠ åˆ°é¡µé¢æ—¶ï¼Œå¦‚æœå®ƒæ¥è‡ªäºå½“å‰ç”¨æˆ·å°±è‡ªåŠ¨æ›´æ–°è‡ªå·±ã€‚è€Œä¸”ç”šè‡³æˆ‘ä»¬ä¸ºæ­¤éƒ½ä¸å†éœ€è¦ Stimulus äº†ï¼</p>

<p>ä½ å¯ä»¥åœ¨<a href="https://github.com/anycable/anycable_rails_demo/pull/16">è¿™ä¸ª PR</a> ä¸­æ‰¾åˆ°æœ¬æ–‡æœ‰å…³çš„å…¨éƒ¨æºä»£ç ã€‚</p>

<p>æ‰€ä»¥ï¼Œé‚£ä¹ˆé›¶ JavaScript çš„ Reactive Rails åˆ°åº•å­˜åœ¨å—ï¼Ÿå¹¶ä¸ã€‚æˆ‘ä»¬ç§»é™¤äº†å¾ˆå¤š JS ä»£ç ï¼Œä½†æœ€åä¸å¾—ä¸ç”¨ä¸€äº›æ–°ä¸œè¥¿æ¥æ›¿ä»£ã€‚è¿™äº›æ–°ä¸œè¥¿è·Ÿä¹‹å‰çš„æœ‰æ‰€åŒºåˆ«ï¼šå®ƒæ›´åŠ ï¼Œæˆ‘å¾—è¯´ï¼Œ<strong><em>å®ç”¨ä¸»ä¹‰</em></strong>ã€‚å®ƒä¹Ÿæ›´åŠ é«˜é˜¶ï¼Œéœ€è¦å¯¹ JavaScript ä»¥åŠæœ€æ–°æµè§ˆå™¨ APIs æœ‰å¾ˆå¥½çš„äº†è§£ï¼Œè¿™è‚¯å®šæ˜¯è¦æƒè¡¡è€ƒè™‘çš„ã€‚</p>

<p>é™„ï¼šæˆ‘å¯¹ CableReady å’Œ StimulusReflex ä¹Ÿæœ‰ä¸€ä¸ª<a href="https://github.com/anycable/anycable_rails_demo/pull/12">ç±»ä¼¼çš„ PR</a>ã€‚ä½ å¯ä»¥æŠŠå®ƒè·Ÿ Hotwire çš„è¿™ä¸ª PR è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨ <a href="https://twitter.com/evilmartians">Twitter</a> ä¸Šä¸æˆ‘ä»¬åˆ†äº«ä½ çš„è§‚ç‚¹ã€‚</p>


</div>

<!-- Rating -->

<div class="rating mt-4 mb-4 d-flex align-items-center">
    <strong class="mr-1">Rating:</strong> <div class="rating-holder">
<div class="c-rating c-rating--regular" data-rating-value="5">
  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>4</button>
  <button>5</button>
</div>
</div>
</div>


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->


<div class="d-flex authorbox align-items-center">
    <div class="col-md-2 mr-4 text-center">
        
        <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
        
    </div>
    <div class="col-md-10"> 
        <a target="_blank" class="text-dark h4" href="https://xfyuan.github.io">About Mr.Z</a>   <a target="_blank" href="https://twitter.com/apexy" class="btn-sm"><i class="fab fa-twitter"></i></a>        
        <span class="author-description d-block mt-2">A Chinese software engineer living and working in Chengdu. I love Creating the future in digital worlds, big and small.</span>            
    </div>
</div>



<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments">
    <button class="btn btn-dark show-comments">Load Comments</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'xfyuan'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       


<!-- Share -->
<div class="share">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails&url=/2021/04/hotwire-reactive-rails-with-no-javascript/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=/2021/04/hotwire-reactive-rails-with-no-javascript/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=/2021/04/hotwire-reactive-rails-with-no-javascript/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Explore more like this</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">
    
    <!-- Categories -->
    
    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/categories#Programming">Programming</a>                
    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/categories#Translation">Translation</a>                
    

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#hotwire">hotwire</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#rails">rails</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#ruby">ruby</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#stimulus">stimulus</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#turbo">turbo</a>               
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/04/the-foundation-of-how-tailwindcss-works/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_115551.jpg" alt="Tailwindcssåº•å±‚åŸºçŸ³çš„ç†å¿µ">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/04/the-foundation-of-how-tailwindcss-works/">Tailwindcssåº•å±‚åŸºçŸ³çš„ç†å¿µ</a>
                
            </h2>
            <h4 class="card-text">Tailwindcss ä» 2019 å¹´å¼€å§‹é€æ¸åœ¨å›½å¤–çš„ Web å¼€å‘åœˆå­å†…ç››è¡Œèµ·æ¥ã€‚å›½å†…å€’æ˜¯è‡³ä»Šä»ç„¶ä¸æ¸©ä¸ç«ã€‚2020 å¹´çš„ Ruby China ä¸Šè¿‡çº¯ä¸­åšè¿‡ä¸€æ¬¡åœ¨é¡¹ç›®ä¸Šä½¿ç”¨ tailwindcss ä½“éªŒçš„æœ‰å…³æ¼”è®²ã€‚æˆ‘åœ¨ 2020 å¹´ä¹Ÿå†™è¿‡ä¸€ç¯‡æœ‰å…³çš„åšå®¢â€œåœ¨ Rails 6 ä¸­æ•´åˆ Stimulus å’Œ Tailwind CSSâ€ï¼ˆè¢«å‰è€…åœ¨æ¼”è®²ä¸­æ‰€å¼•ç”¨^_^ï¼‰ã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">10 Apr 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/03/hotwire-build-turbo-application/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_133340.jpg" alt="Hotwireä¹‹æ„å»ºTurboåº”ç”¨">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/03/hotwire-build-turbo-application/">Hotwireä¹‹æ„å»ºTurboåº”ç”¨</a>
                
            </h2>
            <h4 class="card-text">æœ¬æ–‡æ˜¯å¯¹æ„å»º Turbo åº”ç”¨çš„å…·ä½“æè¿°ï¼ŒåŸæ–‡å‡ºè‡ªï¼šhttps://turbo.hotwire.dev/handbook/buildingã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">26 Mar 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/2021/03/hotwire-turbo-streams/">
                

                    
                        <img class="img-thumb lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/xfyuan/ossimgs@master/uPic/IMG_20210220_115651.jpg" alt="Hotwireä¹‹ä½¿ç”¨Turbo Streamsç„•å‘æ´»åŠ›">
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/2021/03/hotwire-turbo-streams/">Hotwireä¹‹ä½¿ç”¨Turbo Streamsç„•å‘æ´»åŠ›</a>
                
            </h2>
            <h4 class="card-text">æœ¬æ–‡æ˜¯å¯¹ Turbo Streams çš„è¯¦ç»†è¯´æ˜ï¼ŒåŸæ–‡å‡ºè‡ªï¼šhttps://turbo.hotwire.dev/handbook/streamsã€‚
</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="/assets/images/avatar.png" alt="Mr.Z">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="https://xfyuan.github.io">Mr.Z</a></span> 
                
                <span class="post-date">19 Mar 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
                
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

    <script type="application/ld+json">
    {
    "@context": "http://schema.org/",
    "@type": "Review",
    "itemReviewed": {
    "@type": "Thing",
    "name": "Hotwire: æ²¡æœ‰JavaScriptçš„Reactive Rails"
    },
    "author": {
    "@type": "Person",
    "name": "Mr.Z"
    },
    "datePublished": "2021-04-24",
    "reviewRating": {
    "@type": "Rating",
    "ratingValue": "5",
    "bestRating": "5"
    }
    }
    </script>

    </div>

    

</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center text-lg-left">
                Copyright Â© 2021 The Tragedy of XY
            </div>
            <div class="col-md-6 col-sm-12 text-center text-lg-right">
                <a target="_blank" href="https://www.wowthemes.net/memoirs-free-jekyll-theme/">Memoirs Jekyll Theme</a>
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

<script src="/assets/js/prism.js"></script>

<script src="/assets/js/theme.js"></script>


<script src="/assets/js/lazyload.js"></script>



<script id="dsq-count-scr" src="//xfyuan.disqus.com/count.js"></script>


</body>
</html>
